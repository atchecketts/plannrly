# UAT: Feature 12.2 - Checkout & Subscription Flow

## Test Environment Setup

**Prerequisites:**
- Stripe test mode configured
- Test products/prices created in Stripe
- Tenant accounts without existing subscriptions
- Stripe test card numbers ready

**Test URLs:**
- Subscription Index: `/subscription`
- Checkout: `/subscription/checkout/{plan}`
- Success Page: `/subscription/success`

**Test Card Numbers:**
- Success: 4242 4242 4242 4242
- Decline: 4000 0000 0000 0002
- Requires Auth: 4000 0025 0000 3155

---

## Test Cases

### TC-12.2.1: Subscription Overview Shows Current Plan

**Steps:**
1. Log in as tenant with existing subscription
2. Navigate to subscription page

**Expected Results:**
- [ ] Current plan name displayed
- [ ] Billing period shown (monthly/annual)
- [ ] Next billing date displayed
- [ ] Subscription status visible

---

### TC-12.2.2: New Subscription - Checkout Flow

**Steps:**
1. Log in as tenant without subscription
2. Navigate to subscription page
3. Select Starter plan
4. Click subscribe/checkout

**Expected Results:**
- [ ] Redirects to Stripe Checkout
- [ ] Correct plan details shown on Stripe page
- [ ] Price is correct
- [ ] Company name visible

---

### TC-12.2.3: Complete Checkout Successfully

**Steps:**
1. Start checkout for a plan
2. On Stripe Checkout page, enter test card 4242 4242 4242 4242
3. Complete the payment
4. Wait for redirect back to app

**Expected Results:**
- [ ] Payment processed successfully
- [ ] Redirected to success page
- [ ] Success message displayed
- [ ] Subscription active in database
- [ ] Stripe Dashboard shows active subscription

---

### TC-12.2.4: Checkout Cancelled

**Steps:**
1. Start checkout for a plan
2. On Stripe Checkout page, click back or cancel
3. Observe behavior

**Expected Results:**
- [ ] Redirected to cancel page
- [ ] No subscription created
- [ ] No charge made
- [ ] Can try again

---

### TC-12.2.5: Upgrade Plan (Starter to Professional)

**Steps:**
1. Log in as tenant with Starter subscription
2. Navigate to subscription page
3. Click "Upgrade" to Professional
4. Complete the change

**Expected Results:**
- [ ] Proration calculated and shown
- [ ] Upgrade processed immediately
- [ ] New plan reflected in dashboard
- [ ] Invoice generated with proration

---

### TC-12.2.6: Downgrade Plan (Professional to Starter)

**Steps:**
1. Log in as tenant with Professional subscription
2. Navigate to subscription page
3. Click "Downgrade" to Starter
4. Complete the change

**Expected Results:**
- [ ] Confirmation message shown
- [ ] Downgrade scheduled for end of period
- [ ] Current plan continues until period end
- [ ] Message shows when downgrade takes effect

---

### TC-12.2.7: Cancel Subscription

**Steps:**
1. Log in as tenant with active subscription
2. Navigate to subscription page
3. Click "Cancel Subscription"
4. Confirm cancellation

**Expected Results:**
- [ ] Confirmation prompt shown
- [ ] Subscription marked as cancelled
- [ ] Access continues until period end
- [ ] Cancellation date shown
- [ ] Grace period message displayed

---

### TC-12.2.8: Resume Cancelled Subscription

**Steps:**
1. Log in as tenant with cancelled (but not expired) subscription
2. Navigate to subscription page
3. Click "Resume Subscription"

**Expected Results:**
- [ ] Resume option available before end date
- [ ] Subscription reactivated
- [ ] Cancellation removed
- [ ] Billing continues as normal

---

### TC-12.2.9: Trial Period - New Subscription

**Steps:**
1. Log in as new tenant
2. Start checkout with trial enabled
3. Complete signup

**Expected Results:**
- [ ] Trial period activated (14 days or configured)
- [ ] No immediate charge
- [ ] Trial end date displayed
- [ ] Payment method captured for future billing

---

### TC-12.2.10: Trial Period - Ends and Charges

**Steps:**
1. Set trial to expire (adjust dates in test)
2. Verify billing triggers

**Expected Results:**
- [ ] Charge attempted at trial end
- [ ] Subscription converts to active
- [ ] Email notification sent
- [ ] Or subscription cancelled if payment fails

---

### TC-12.2.11: Failed Payment on Checkout

**Steps:**
1. Start checkout
2. Use declined test card 4000 0000 0000 0002
3. Attempt payment

**Expected Results:**
- [ ] Payment declined
- [ ] Error message shown
- [ ] No subscription created
- [ ] Can try again with valid card

---

### TC-12.2.12: Monthly to Annual Switch

**Steps:**
1. Log in with monthly subscription
2. Switch to annual billing
3. Complete the change

**Expected Results:**
- [ ] Annual price shown with savings
- [ ] Proration handled correctly
- [ ] Billing cycle updated
- [ ] Next billing date reflects annual period

---

### TC-12.2.13: Success Page Content

**Steps:**
1. Complete a successful checkout
2. Land on success page

**Expected Results:**
- [ ] Thank you message displayed
- [ ] Plan name confirmed
- [ ] Next steps or navigation shown
- [ ] Link to dashboard

---

## Notes

- Always use Stripe test mode cards
- Check Stripe Dashboard to verify subscription states
- Test webhook delivery for subscription events
- Verify proration calculations match Stripe
- Test on mobile for responsive checkout flow
