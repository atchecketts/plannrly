# UAT: Feature 3.5 - Missed Shift Detection

## Test Environment Setup

**Prerequisites:**
- One admin user
- Multiple employee users with assigned shifts
- Published shifts that have passed without clock-in
- Tenant with clock-in enabled
- Grace period configured (default: 15 minutes via missed_grace_minutes)

**Test URLs:**
- Dashboard: `/dashboard`
- Time Entries: `/time-entries`
- Timesheets: `/timesheets`
- Shifts: `/schedule`

**Command:**
- Manual: `php artisan attendance:detect-missed-shifts`
- Scheduled: Every 15 minutes automatically

---

## Test Cases

### TC-3.5.1: Detect Missed Shift (No Clock-In)

**Steps:**
1. Log in as admin
2. Create a published shift for Employee A starting 30+ minutes ago
3. Ensure Employee A did NOT clock in
4. Run: `php artisan attendance:detect-missed-shifts`
5. Check time entries

**Expected Results:**
- [x] Time entry created with status "missed"
- [x] Entry linked to the shift
- [x] No clock-in/out times recorded
- [x] Notes field shows auto-detection message

---

### TC-3.5.2: No False Positive for Clocked-In Shift

**Steps:**
1. Log in as admin
2. Ensure Employee B has a shift and DID clock in
3. Run missed shift detection

**Expected Results:**
- [x] No duplicate missed entry created
- [x] Existing time entry remains
- [x] Status is "clocked_in", "on_break", or "clocked_out"
- [x] Only one time entry per shift

---

### TC-3.5.3: Grace Period Respected

**Steps:**
1. Log in as admin
2. Create shift starting 10 minutes ago
3. Grace period is 15 minutes (default)
4. Run detection command

**Expected Results:**
- [x] Shift NOT marked as missed yet
- [x] Employee still has time to clock in
- [x] Wait until 15+ minutes have passed
- [x] Run again - then marked as missed

---

### TC-3.5.4: Manager Notification on Missed Shift

**Steps:**
1. Create scenario where shift is missed
2. Run detection command
3. Log in as admin/manager
4. Check email or database notifications

**Expected Results:**
- [x] Manager receives MissedShiftNotification
- [x] Notification shows employee name
- [x] Shows shift date and time
- [x] Link to timesheets

---

### TC-3.5.5: Missed Shift Alert on Admin Dashboard

**Steps:**
1. Create missed shift scenario
2. Log in as admin
3. View dashboard

**Expected Results:**
- [x] Red alert banner visible when missed_shifts_today > 0
- [x] Shows count of missed shifts
- [x] "View Timesheets" link navigates to `/timesheets`
- [x] Alert is prominent with warning icon

---

### TC-3.5.6: Employee Sees Own Missed Shift

**Steps:**
1. Log in as the employee who missed a shift
2. View dashboard

**Expected Results:**
- [x] Red alert banner if missed shifts this week
- [x] Shows message to speak with manager
- [x] Count displays number of missed shifts
- [x] Cannot edit/change status

---

### TC-3.5.7: Detection Does Not Run for Unassigned Shifts

**Steps:**
1. Create a shift with no user assigned (user_id = null)
2. Let shift time pass
3. Run detection command

**Expected Results:**
- [x] No time entry created
- [x] Unassigned shifts cannot be "missed"
- [x] Only assigned shifts are tracked

---

### TC-3.5.8: Detection Does Not Run for Draft Shifts

**Steps:**
1. Create a shift with status = draft
2. Assign to employee, don't publish
3. Let shift time pass
4. Run detection command

**Expected Results:**
- [x] No time entry created
- [x] Only published shifts are checked
- [x] Draft shifts are not tracked

---

### TC-3.5.9: Detection Does Not Run for Future Shifts

**Steps:**
1. Create a shift for tomorrow
2. Run detection command

**Expected Results:**
- [x] No time entry created
- [x] Only past/current day shifts checked
- [x] Future shifts untouched

---

### TC-3.5.10: Detection Runs Periodically

**Steps:**
1. Log in as admin
2. Check routes/console.php

**Expected Results:**
- [x] Command scheduled: `everyFifteenMinutes()`
- [x] Catches missed shifts promptly
- [x] No long delays in detection

---

### TC-3.5.11: Missed Shift for Multiple Employees

**Steps:**
1. Create shifts for 3 employees at same time
2. Only 1 clocks in
3. Run detection

**Expected Results:**
- [x] 2 missed entries created
- [x] 1 existing entry unchanged
- [x] Each missed entry has correct employee/shift
- [x] Notifications sent for each missed

---

### TC-3.5.12: Tenant Isolation for Missed Detection

**Steps:**
1. Create missed shift in Tenant A
2. Run detection command
3. Log in as admin of Tenant B
4. View dashboard/timesheets

**Expected Results:**
- [x] Tenant B cannot see Tenant A's missed shifts
- [x] Detection creates entries in correct tenant
- [x] Notifications only sent to correct tenant's managers
- [x] No cross-tenant data leakage

---

### TC-3.5.13: Missed Shift Count on Manager Dashboard

**Steps:**
1. Create multiple missed shifts today
2. Log in as admin
3. View dashboard

**Expected Results:**
- [x] stats['missed_shifts_today'] count in view data
- [x] Count is accurate
- [x] Alert banner displays count
- [x] Links to timesheets for review

---

### TC-3.5.14: Detection Skipped When Clock-In Disabled

**Steps:**
1. Disable clock-in/out in tenant settings
2. Create past shift without time entry
3. Run detection command

**Expected Results:**
- [x] No time entry created
- [x] Tenant is skipped in processing
- [x] Only clock-in enabled tenants are checked

---

## Notes

- Missed entries have status = 'missed' (TimeEntryStatus::Missed)
- Detection command: `php artisan attendance:detect-missed-shifts`
- Scheduler runs every 15 minutes in routes/console.php
- Grace period configured via TenantSettings.missed_grace_minutes
- Notifications use mail + database channels
