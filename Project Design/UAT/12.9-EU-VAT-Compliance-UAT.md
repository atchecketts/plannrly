# UAT: Feature 12.9 - EU Intra-Community VAT Compliance

## Test Environment Setup

**Prerequisites:**
- VIES service accessible
- Test EU VAT numbers (see below)
- Tenants from different countries configured
- Invoice creation capability

**Test VAT Numbers:**
- Spain (valid): ESB42691550
- Germany (test): DE123456789
- France (test): FR12345678901
- UK (non-EU): GB123456789

**Test URLs:**
- VAT Validation: `/vat/validate` (POST)
- Billing Details: `/settings/billing-details`
- Modelo 349 Report: `/reports/modelo-349`

---

## Test Cases

### TC-12.9.1: VIES Validation - Valid Spanish VAT

**Steps:**
1. Navigate to billing details
2. Enter country: Spain
3. Enter VAT number: ESB42691550
4. Trigger validation

**Expected Results:**
- [ ] VIES service queried
- [ ] Validation successful
- [ ] Company name returned from VIES
- [ ] "Validated" indicator shown
- [ ] Validation timestamp recorded

---

### TC-12.9.2: VIES Validation - Invalid VAT

**Steps:**
1. Navigate to billing details
2. Enter country: Germany
3. Enter VAT number: DE000000000
4. Trigger validation

**Expected Results:**
- [ ] VIES service queried
- [ ] Validation fails
- [ ] Error message shown
- [ ] "Invalid" indicator
- [ ] Can try different number

---

### TC-12.9.3: Domestic VAT - Spanish Customer

**Steps:**
1. Create invoice for Spanish customer (B2B)
2. Customer has valid Spanish VAT
3. Check VAT treatment

**Expected Results:**
- [ ] VAT type: Domestic
- [ ] Rate: 21% Spanish IVA
- [ ] Normal VAT applied
- [ ] Invoice shows 21% tax

---

### TC-12.9.4: Reverse Charge - EU B2B Customer

**Steps:**
1. Create invoice for German customer (B2B)
2. Customer has valid German VAT (validated via VIES)
3. Check VAT treatment

**Expected Results:**
- [ ] VAT type: Intra-EU B2B
- [ ] Rate: 0%
- [ ] Reverse charge applies
- [ ] Invoice shows "Reverse charge - Article 196"
- [ ] Both VAT numbers displayed

---

### TC-12.9.5: Reverse Charge Text on Invoice

**Steps:**
1. Create reverse charge invoice
2. Download PDF

**Expected Results:**
- [ ] "Reverse charge - Article 196 Council Directive 2006/112/EC"
- [ ] Text clearly visible
- [ ] Customer VAT number shown
- [ ] Supplier VAT number shown (ESB42691550)

---

### TC-12.9.6: Export - Non-EU Customer

**Steps:**
1. Create invoice for US customer
2. Check VAT treatment

**Expected Results:**
- [ ] VAT type: Export
- [ ] Rate: 0%
- [ ] No VAT charged
- [ ] Invoice shows "Outside EU - no VAT applicable"

---

### TC-12.9.7: EU B2C - Consumer in Other EU Country

**Steps:**
1. Create invoice for French individual (no VAT number)
2. Check VAT treatment

**Expected Results:**
- [ ] VAT type: Intra-EU B2C
- [ ] Rate: 21% (Spanish IVA applies)
- [ ] Normal VAT charged
- [ ] No reverse charge

---

### TC-12.9.8: VAT Validation Display on Form

**Steps:**
1. Navigate to billing details
2. Enter a VAT number
3. Watch for validation feedback

**Expected Results:**
- [ ] Loading indicator during validation
- [ ] Green checkmark if valid
- [ ] Red X if invalid
- [ ] Company name from VIES displayed
- [ ] Clear validation status

---

### TC-12.9.9: VIES Service Unavailable

**Steps:**
1. Simulate VIES service down
2. Try to validate VAT number

**Expected Results:**
- [ ] Graceful error handling
- [ ] Message: "VIES service temporarily unavailable"
- [ ] Option to retry later
- [ ] Can save without validation (pending)

---

### TC-12.9.10: Quarterly VAT Re-validation

**Steps:**
1. Have tenant with validated VAT (90+ days ago)
2. Trigger re-validation command
3. Check validation status

**Expected Results:**
- [ ] Command identifies stale validations
- [ ] Re-queries VIES for each
- [ ] Updates validation timestamp
- [ ] Flags any that are now invalid

---

### TC-12.9.11: Modelo 349 Report

**Steps:**
1. Log in as SuperAdmin
2. Have multiple intra-EU B2B invoices
3. Navigate to Modelo 349 report
4. Select quarter

**Expected Results:**
- [ ] Report generates
- [ ] Lists all intra-EU B2B transactions
- [ ] Shows customer VAT numbers
- [ ] Shows amounts per customer
- [ ] Can export as CSV/XML

---

### TC-12.9.12: VAT Determination Logged

**Steps:**
1. Create invoice with VAT determination
2. Check audit/logs

**Expected Results:**
- [ ] VAT determination recorded
- [ ] Reason logged (domestic/reverse charge/export)
- [ ] Customer country recorded
- [ ] Timestamp recorded
- [ ] Audit trail complete

---

### TC-12.9.13: Invoice Shows Both VAT Numbers

**Steps:**
1. Create intra-EU B2B invoice
2. View/download invoice

**Expected Results:**
- [ ] Supplier VAT: ESB42691550 displayed
- [ ] Customer VAT number displayed
- [ ] Both clearly labeled
- [ ] Correct on PDF

---

### TC-12.9.14: UK Customer Post-Brexit

**Steps:**
1. Create invoice for UK customer
2. UK has VAT number but is non-EU

**Expected Results:**
- [ ] VAT type: Export (UK is non-EU)
- [ ] Rate: 0%
- [ ] No reverse charge (not EU)
- [ ] Treated as non-EU export

---

### TC-12.9.15: EU Country List Correct

**Steps:**
1. Check system's EU country list
2. Verify current EU members

**Expected Results:**
- [ ] Contains all 27 EU members
- [ ] Does NOT contain UK
- [ ] Correct country codes (AT, BE, BG, etc.)
- [ ] Up to date list

---

## Notes

- VIES service can be slow - allow up to 10 seconds
- Real EU VAT numbers needed for production testing
- Keep track of Spanish tax law updates
- Modelo 349 format may have specific requirements
- Consider caching VIES results for 24 hours
- Test with borderline cases (Northern Ireland, territories)
