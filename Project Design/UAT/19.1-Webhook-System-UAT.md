# UAT: Feature 19.1 - Webhook System

## Test Environment Setup

**Prerequisites:**
- Admin user with webhook management permissions
- Access to an external webhook testing endpoint (e.g., webhook.site, requestbin)
- Existing shifts, employees, leave requests, and swap requests for event generation
- API access to trigger events

**Test URL:** `/settings/webhooks`

---

## Test Cases

### TC-19.1.1: View Webhook Management Index

**Steps:**
1. Log in as an admin
2. Navigate to Settings > Webhooks

**Expected Results:**
- [ ] Page loads successfully
- [ ] Shows list of configured webhooks (or empty state if none)
- [ ] "Create Webhook" button is visible
- [ ] Each webhook shows name, URL, status, and event subscriptions

---

### TC-19.1.2: Create New Webhook

**Steps:**
1. Log in as an admin
2. Navigate to Settings > Webhooks
3. Click "Create Webhook"
4. Enter webhook name (e.g., "Test Integration")
5. Enter a valid webhook URL
6. Select events to subscribe to (e.g., shift.created, shift.updated)
7. Click "Save"

**Expected Results:**
- [ ] Form validates required fields
- [ ] Webhook is created successfully
- [ ] Success message is displayed
- [ ] New webhook appears in the list
- [ ] Secret key is generated and displayed (only once)

---

### TC-19.1.3: Edit Existing Webhook

**Steps:**
1. Log in as an admin
2. Navigate to Settings > Webhooks
3. Click on an existing webhook
4. Modify the name and event subscriptions
5. Click "Save"

**Expected Results:**
- [ ] Changes are saved successfully
- [ ] Updated information is reflected in the list
- [ ] Secret key is NOT changed during edit
- [ ] Success message is displayed

---

### TC-19.1.4: Delete Webhook

**Steps:**
1. Log in as an admin
2. Navigate to Settings > Webhooks
3. Click delete on an existing webhook
4. Confirm deletion

**Expected Results:**
- [ ] Confirmation dialog appears
- [ ] Webhook is removed from the list
- [ ] Associated delivery logs are handled appropriately
- [ ] Success message is displayed

---

### TC-19.1.5: Test Webhook Button

**Steps:**
1. Log in as an admin
2. Navigate to Settings > Webhooks
3. Select an existing webhook
4. Click "Test Webhook"

**Expected Results:**
- [ ] Test payload is sent to the webhook URL
- [ ] Response status is displayed (success or failure)
- [ ] Test delivery appears in delivery log
- [ ] Appropriate error message if endpoint unreachable

---

### TC-19.1.6: Webhook Delivery on Shift Created Event

**Steps:**
1. Configure a webhook subscribed to "shift.created"
2. Create a new shift via the schedule interface
3. Check the webhook delivery log

**Expected Results:**
- [ ] Webhook is triggered automatically
- [ ] Delivery log shows the attempt
- [ ] Payload contains shift details
- [ ] HMAC signature header is included
- [ ] Response code is logged

---

### TC-19.1.7: Webhook Delivery on Schedule Published Event

**Steps:**
1. Configure a webhook subscribed to "schedule.published"
2. Publish a schedule
3. Check the webhook delivery log

**Expected Results:**
- [ ] Webhook is triggered on publish
- [ ] Payload contains schedule and shifts data
- [ ] Delivery timestamp is recorded
- [ ] Status shows success or failure

---

### TC-19.1.8: Webhook Delivery on Leave Events

**Steps:**
1. Configure a webhook subscribed to "leave.requested", "leave.approved", "leave.rejected"
2. Submit a leave request as an employee
3. Approve the leave request as a manager
4. Check the webhook delivery log

**Expected Results:**
- [ ] "leave.requested" webhook fires on submission
- [ ] "leave.approved" webhook fires on approval
- [ ] Each delivery is logged separately
- [ ] Payloads contain appropriate leave request details

---

### TC-19.1.9: Webhook Delivery on Clock In/Out Events

**Steps:**
1. Configure a webhook subscribed to "employee.clocked_in", "employee.clocked_out"
2. Clock in as an employee
3. Clock out as an employee
4. Check the webhook delivery log

**Expected Results:**
- [ ] "employee.clocked_in" webhook fires on clock in
- [ ] "employee.clocked_out" webhook fires on clock out
- [ ] Payloads contain employee and timestamp details

---

### TC-19.1.10: View Webhook Delivery Log

**Steps:**
1. Log in as an admin
2. Navigate to Settings > Webhooks
3. Select a webhook with delivery history
4. View the delivery log

**Expected Results:**
- [ ] Delivery log shows all recent attempts
- [ ] Each entry shows timestamp, event type, response code
- [ ] Failed deliveries are clearly marked
- [ ] Can view payload and response details

---

### TC-19.1.11: Webhook Retry on Failure

**Steps:**
1. Configure a webhook with an invalid/unreachable URL
2. Trigger an event that should fire the webhook
3. Monitor delivery log over time

**Expected Results:**
- [ ] Initial delivery fails
- [ ] System retries with exponential backoff
- [ ] Retry attempts are logged
- [ ] Delay between retries increases

---

### TC-19.1.12: Webhook Auto-Disable After Repeated Failures

**Steps:**
1. Configure a webhook with a permanently failing endpoint
2. Trigger multiple events
3. Allow retries to exhaust
4. Check webhook status

**Expected Results:**
- [ ] After threshold failures, webhook is disabled
- [ ] Admin notification is sent about disabled webhook
- [ ] Webhook status shows "Disabled"
- [ ] Events no longer trigger this webhook

---

### TC-19.1.13: HMAC Signature Verification

**Steps:**
1. Create a webhook and note the secret key
2. Trigger an event
3. Capture the webhook request at the endpoint
4. Verify the HMAC signature header

**Expected Results:**
- [ ] Request includes X-Webhook-Signature header
- [ ] Signature matches HMAC-SHA256 of payload using secret
- [ ] Timestamp is included in signature calculation

---

### TC-19.1.14: Enable/Disable Webhook Toggle

**Steps:**
1. Log in as an admin
2. Navigate to Settings > Webhooks
3. Toggle a webhook to disabled
4. Trigger an event the webhook is subscribed to
5. Toggle the webhook back to enabled

**Expected Results:**
- [ ] Disabled webhooks do not receive events
- [ ] Status change is immediate
- [ ] Re-enabled webhooks resume receiving events

---

### TC-19.1.15: Webhook Event Filtering

**Steps:**
1. Configure a webhook subscribed only to "shift.created"
2. Create a shift
3. Update the shift
4. Delete the shift
5. Check delivery log

**Expected Results:**
- [ ] Only "shift.created" event is delivered
- [ ] "shift.updated" and "shift.deleted" do NOT trigger webhook
- [ ] Event filtering is working correctly

---

## Notes

- Record any bugs or issues found during testing
- Note the browser and device used for testing
- Screenshot any unexpected behavior
- Verify HMAC signatures using an external tool for validation
