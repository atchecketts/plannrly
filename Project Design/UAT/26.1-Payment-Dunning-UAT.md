# UAT: Feature 26.1 - Payment Dunning

## Test Environment Setup

**Prerequisites:**
- Stripe test environment configured
- Test tenant with active subscription
- Test tenant in grace period
- Test tenant with failed payment
- Admin user for each test tenant
- Email delivery configured (or mail trap for testing)

**Test URL:** `/settings/billing`

---

## Test Cases

### TC-26.1.1: View Payment History (Healthy Account)

**Steps:**
1. Log in as admin for a tenant with successful payments
2. Navigate to Billing/Subscription settings
3. View payment history section

**Expected Results:**
- [ ] Payment history is visible
- [ ] Shows successful payments with dates
- [ ] Shows payment amounts
- [ ] Shows payment method used
- [ ] No warning banners displayed

---

### TC-26.1.2: Payment Failure Notification

**Steps:**
1. Simulate a failed payment in Stripe test mode
2. Trigger the dunning webhook or scheduled command
3. Check admin email inbox

**Expected Results:**
- [ ] Admin receives payment failure email
- [ ] Email explains the issue clearly
- [ ] Email contains link to update payment method
- [ ] Email mentions retry schedule
- [ ] Email mentions grace period

---

### TC-26.1.3: View Dunning State Banner

**Steps:**
1. Log in as admin for tenant with failed payment
2. View any page in the application

**Expected Results:**
- [ ] Warning banner is displayed prominently
- [ ] Banner indicates payment failed
- [ ] Banner shows days remaining in grace period
- [ ] Banner has link to update payment method
- [ ] Banner cannot be permanently dismissed

---

### TC-26.1.4: First Retry (Day 1)

**Steps:**
1. Create a failed payment scenario
2. Wait for or trigger first retry (Day 1)
3. Check payment attempts log

**Expected Results:**
- [ ] System attempts retry on Day 1
- [ ] Payment attempt is logged
- [ ] If successful, grace period ends
- [ ] If failed, dunning state continues
- [ ] Notification sent about retry attempt

---

### TC-26.1.5: Second Retry (Day 3)

**Steps:**
1. Continue from failed first retry
2. Wait for or trigger second retry (Day 3)
3. Check payment attempts log

**Expected Results:**
- [ ] System attempts retry on Day 3
- [ ] Payment attempt is logged
- [ ] Notification sent to admin
- [ ] Grace period countdown continues

---

### TC-26.1.6: Third Retry (Day 7)

**Steps:**
1. Continue from failed second retry
2. Wait for or trigger third retry (Day 7)
3. Check payment attempts log

**Expected Results:**
- [ ] System attempts retry on Day 7
- [ ] Payment attempt is logged
- [ ] Warning notification sent about approaching suspension
- [ ] Grace period shows 7 days remaining

---

### TC-26.1.7: Grace Period Warning (Day 10)

**Steps:**
1. Continue dunning process to Day 10
2. Check admin email and in-app notifications

**Expected Results:**
- [ ] Urgent warning notification sent
- [ ] Notification mentions 4 days until suspension
- [ ] In-app banner becomes more urgent
- [ ] Clear call to action to update payment

---

### TC-26.1.8: Update Payment Method During Grace Period

**Steps:**
1. Log in as admin for tenant in grace period
2. Navigate to Billing settings
3. Click "Update Payment Method"
4. Enter new valid card details
5. Submit the update

**Expected Results:**
- [ ] Payment method form loads correctly
- [ ] New card can be entered
- [ ] Immediate payment attempt is made
- [ ] If successful, subscription resumes
- [ ] Grace period ends
- [ ] Success confirmation shown

---

### TC-26.1.9: Tenant Suspension (Day 14)

**Steps:**
1. Allow grace period to expire (Day 14)
2. Trigger suspension process
3. Log in as tenant admin

**Expected Results:**
- [ ] Tenant access is restricted
- [ ] Shows suspension page with reason
- [ ] Employees cannot access schedules
- [ ] Historical data is preserved (not deleted)
- [ ] Link to reactivate is provided

---

### TC-26.1.10: Reactivate Suspended Tenant

**Steps:**
1. Log in as admin of suspended tenant
2. Click "Reactivate Account" or similar
3. Update payment method with valid card
4. Complete payment

**Expected Results:**
- [ ] Reactivation flow is accessible
- [ ] Payment method can be updated
- [ ] Outstanding balance is charged
- [ ] If successful, tenant is reactivated
- [ ] Full access is restored
- [ ] Confirmation email sent

---

### TC-26.1.11: Successful Payment Clears Dunning

**Steps:**
1. Have a tenant in dunning state
2. Manually update payment method to valid card
3. Trigger or wait for next retry

**Expected Results:**
- [ ] Payment succeeds
- [ ] Dunning state is cleared
- [ ] Warning banners are removed
- [ ] Payment history shows successful payment
- [ ] Confirmation notification sent

---

### TC-26.1.12: Payment Attempts Logging

**Steps:**
1. Navigate to admin payment/billing logs
2. Review payment attempt history

**Expected Results:**
- [ ] All payment attempts are logged
- [ ] Shows attempt date and time
- [ ] Shows result (success/failure)
- [ ] Shows failure reason if applicable
- [ ] Shows payment method used

---

## Notes

- Record any bugs or issues found during testing
- Note the browser and device used for testing
- Screenshot any unexpected behavior
- Use Stripe test mode for all payment testing
- Test with various failure scenarios (declined, insufficient funds, expired card)
