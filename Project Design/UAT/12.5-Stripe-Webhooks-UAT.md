# UAT: Feature 12.5 - Stripe Webhooks

## Test Environment Setup

**Prerequisites:**
- Stripe test mode configured
- Webhook endpoint registered in Stripe Dashboard
- Webhook signing secret configured
- Access to Stripe Dashboard to trigger test events
- Access to application logs

**Test URLs:**
- Webhook Endpoint: `/stripe/webhook` (POST)
- Stripe Dashboard > Developers > Webhooks

---

## Test Cases

### TC-12.5.1: Webhook Endpoint Registered

**Steps:**
1. Go to Stripe Dashboard > Developers > Webhooks
2. Check for registered endpoint

**Expected Results:**
- [ ] Endpoint URL registered
- [ ] Correct events selected
- [ ] Endpoint shows as enabled
- [ ] No failed webhooks in history

---

### TC-12.5.2: Signature Verification Works

**Steps:**
1. Send a test webhook from Stripe Dashboard
2. Check application logs

**Expected Results:**
- [ ] Webhook received by application
- [ ] Signature verified (no 400 errors)
- [ ] Event processed
- [ ] 200 response returned to Stripe

---

### TC-12.5.3: Invalid Signature Rejected

**Steps:**
1. Attempt to send webhook with invalid signature (e.g., using curl)
2. Check response and logs

**Expected Results:**
- [ ] Request rejected (400 or 403)
- [ ] Error logged
- [ ] Event not processed
- [ ] Security maintained

---

### TC-12.5.4: Subscription Created Event

**Steps:**
1. Create a new subscription through checkout
2. Monitor webhook delivery in Stripe Dashboard
3. Check application state

**Expected Results:**
- [ ] customer.subscription.created event sent
- [ ] Webhook received successfully
- [ ] Subscription status updated in app
- [ ] Tenant features synced

---

### TC-12.5.5: Subscription Updated Event

**Steps:**
1. Change a subscription plan
2. Monitor webhook delivery

**Expected Results:**
- [ ] customer.subscription.updated event sent
- [ ] Webhook processed
- [ ] Subscription details updated
- [ ] Plan changes reflected

---

### TC-12.5.6: Subscription Deleted Event

**Steps:**
1. Cancel a subscription (let it expire)
2. Monitor webhook delivery

**Expected Results:**
- [ ] customer.subscription.deleted event sent
- [ ] Webhook processed
- [ ] Subscription marked as cancelled
- [ ] Premium features disabled

---

### TC-12.5.7: Payment Succeeded Event

**Steps:**
1. Process a successful payment (new subscription or renewal)
2. Monitor webhook

**Expected Results:**
- [ ] invoice.payment_succeeded event sent
- [ ] Webhook processed
- [ ] Payment logged in app
- [ ] Receipt/confirmation sent (if configured)

---

### TC-12.5.8: Payment Failed Event

**Steps:**
1. Set up subscription with card that will fail (4000 0000 0000 0341)
2. Trigger renewal or payment
3. Monitor webhook

**Expected Results:**
- [ ] invoice.payment_failed event sent
- [ ] Webhook processed
- [ ] Tenant notified of failure
- [ ] Grace period started

---

### TC-12.5.9: Payment Failure Notification

**Steps:**
1. Trigger payment failure event
2. Check tenant notifications

**Expected Results:**
- [ ] Email sent to tenant owner
- [ ] Email explains payment failed
- [ ] Email includes action steps
- [ ] In-app notification created

---

### TC-12.5.10: Grace Period Started

**Steps:**
1. Trigger payment failure
2. Check tenant record

**Expected Results:**
- [ ] grace_period_ends_at set
- [ ] Grace period is 7 days (or configured)
- [ ] Tenant still has access during grace
- [ ] Warning displayed in app

---

### TC-12.5.11: Features Synced on Subscription Change

**Steps:**
1. Upgrade subscription to higher tier
2. Check tenant features

**Expected Results:**
- [ ] Webhook triggers feature sync
- [ ] New tier features enabled
- [ ] Feature gates updated
- [ ] User can access new features

---

### TC-12.5.12: Features Disabled on Cancellation

**Steps:**
1. Cancel and expire a subscription
2. Check tenant features after webhook

**Expected Results:**
- [ ] Premium features disabled
- [ ] Basic features remain (if freemium)
- [ ] User informed of changes
- [ ] Clean degradation to free tier

---

### TC-12.5.13: Webhook Retry Handling

**Steps:**
1. Temporarily break webhook handler
2. Let Stripe retry
3. Fix handler
4. Verify eventual success

**Expected Results:**
- [ ] Stripe retries failed webhooks
- [ ] Event eventually processed
- [ ] No duplicate processing
- [ ] Idempotency maintained

---

### TC-12.5.14: Customer Updated Event

**Steps:**
1. Update customer info in Stripe Dashboard
2. Monitor webhook

**Expected Results:**
- [ ] customer.updated event sent
- [ ] Webhook processed
- [ ] Customer info synced to app (if needed)

---

## Notes

- Use Stripe Dashboard to send test webhooks
- Monitor application logs during testing
- Verify idempotency (same event sent twice shouldn't double-process)
- Test webhook timeout handling
- Ensure webhook secret matches environment config
- Check that webhook returns 200 quickly (process async if needed)
