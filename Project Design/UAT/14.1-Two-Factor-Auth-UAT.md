# UAT: Feature 14.1 - Two-Factor Authentication (2FA)

## Test Environment Setup

**Prerequisites:**
- User accounts (admin and employee)
- Authenticator app installed on mobile device (Google Authenticator, Authy, etc.)
- Email service configured
- Test tenant with 2FA settings enabled

**Test URL:** `/settings/two-factor`

---

## Test Cases

### TC-14.1.1: Access 2FA Settings

**Steps:**
1. Log in as any user
2. Navigate to account settings
3. Click on "Two-Factor Authentication" or "Security"

**Expected Results:**
- [ ] 2FA settings page loads
- [ ] Current 2FA status is shown (enabled/disabled)
- [ ] Enable/disable options are available
- [ ] Instructions are clear

---

### TC-14.1.2: Enable 2FA Setup Wizard

**Steps:**
1. Log in as a user without 2FA enabled
2. Navigate to 2FA settings
3. Click "Enable Two-Factor Authentication"

**Expected Results:**
- [ ] Setup wizard starts
- [ ] QR code is displayed
- [ ] Manual entry code is provided
- [ ] Instructions for authenticator app shown

---

### TC-14.1.3: Scan QR Code with Authenticator

**Steps:**
1. Start 2FA setup wizard
2. Open authenticator app on mobile device
3. Scan the QR code displayed
4. Verify code appears in authenticator app

**Expected Results:**
- [ ] QR code scans successfully
- [ ] Account appears in authenticator app
- [ ] 6-digit code is generated
- [ ] Code refreshes every 30 seconds

---

### TC-14.1.4: Verify TOTP Code to Complete Setup

**Steps:**
1. After scanning QR code
2. Enter the 6-digit code from authenticator app
3. Click "Verify" or "Confirm"

**Expected Results:**
- [ ] Code is validated
- [ ] 2FA is enabled on the account
- [ ] Success message displayed
- [ ] Recovery codes are shown

---

### TC-14.1.5: Invalid TOTP Code Rejected

**Steps:**
1. Start 2FA setup wizard
2. Enter an incorrect 6-digit code
3. Click "Verify"

**Expected Results:**
- [ ] Code is rejected
- [ ] Error message displayed
- [ ] User can retry with correct code
- [ ] Account remains without 2FA

---

### TC-14.1.6: Recovery Codes Generation

**Steps:**
1. Complete 2FA setup successfully
2. View the recovery codes displayed

**Expected Results:**
- [ ] 8-10 recovery codes are generated
- [ ] Codes are unique and secure
- [ ] Download/copy option available
- [ ] Warning to store codes safely shown

---

### TC-14.1.7: Download Recovery Codes

**Steps:**
1. After 2FA setup
2. Click "Download Recovery Codes"

**Expected Results:**
- [ ] Text file is downloaded
- [ ] Contains all recovery codes
- [ ] File is named appropriately
- [ ] Codes are correctly formatted

---

### TC-14.1.8: Login with 2FA Challenge

**Steps:**
1. Log out of account with 2FA enabled
2. Log in with email and password
3. When prompted, enter TOTP code from authenticator

**Expected Results:**
- [ ] After password, 2FA challenge screen appears
- [ ] Can enter 6-digit code
- [ ] Correct code grants access
- [ ] Logged in successfully

---

### TC-14.1.9: Login with Invalid 2FA Code

**Steps:**
1. Log in to account with 2FA enabled
2. Enter password correctly
3. Enter incorrect 2FA code

**Expected Results:**
- [ ] Code is rejected
- [ ] Error message displayed
- [ ] Can retry with correct code
- [ ] Account is not locked immediately

---

### TC-14.1.10: Login with Recovery Code

**Steps:**
1. Log in to account with 2FA enabled
2. Enter password correctly
3. Click "Use recovery code" option
4. Enter one of the recovery codes

**Expected Results:**
- [ ] Recovery code option is available
- [ ] Valid recovery code grants access
- [ ] Used recovery code is invalidated
- [ ] Warning about fewer codes remaining

---

### TC-14.1.11: Trust This Device

**Steps:**
1. Log in with 2FA
2. Check "Trust this device" option
3. Complete login
4. Log out and log back in

**Expected Results:**
- [ ] "Trust this device" checkbox available
- [ ] Trusted device skips 2FA on next login
- [ ] Trust expires after configured period
- [ ] Other devices still require 2FA

---

### TC-14.1.12: Disable 2FA

**Steps:**
1. Log in to account with 2FA enabled
2. Navigate to 2FA settings
3. Click "Disable Two-Factor Authentication"
4. Confirm with current 2FA code

**Expected Results:**
- [ ] Confirmation required (password or 2FA code)
- [ ] 2FA is disabled
- [ ] Recovery codes are invalidated
- [ ] Success message shown

---

### TC-14.1.13: Mandatory 2FA per Role (Tenant Setting)

**Steps:**
1. Log in as tenant admin
2. Navigate to tenant security settings
3. Enable mandatory 2FA for admin role
4. Log in as admin without 2FA

**Expected Results:**
- [ ] Setting to require 2FA by role exists
- [ ] User without 2FA is forced to set up
- [ ] Cannot access app until 2FA enabled
- [ ] Clear instructions provided

---

### TC-14.1.14: Regenerate Recovery Codes

**Steps:**
1. Log in to account with 2FA enabled
2. Navigate to 2FA settings
3. Click "Regenerate Recovery Codes"
4. Confirm action

**Expected Results:**
- [ ] Requires confirmation (password/2FA code)
- [ ] New recovery codes generated
- [ ] Old recovery codes invalidated
- [ ] New codes displayed for download

---

### TC-14.1.15: 2FA Rate Limiting

**Steps:**
1. Attempt to verify 2FA code multiple times with wrong codes
2. Exceed rate limit threshold

**Expected Results:**
- [ ] Rate limiting is enforced
- [ ] After X failures, temporary lockout
- [ ] Lockout duration is reasonable
- [ ] User is informed of lockout

---

## Notes

- Record any bugs or issues found during testing
- Note the browser and device used for testing
- Screenshot any unexpected behavior
- Test with multiple authenticator apps if possible
