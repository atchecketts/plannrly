# UAT: Feature 12.8 - Ad-Hoc Invoice Management

## Test Environment Setup

**Prerequisites:**
- SuperAdmin account
- Tenants with billing details
- DomPDF or PDF generation configured
- Email sending configured

**Test URLs:**
- Invoice List: `/super-admin/invoices`
- Create Invoice: `/super-admin/invoices/create`
- Invoice View: `/super-admin/invoices/{id}`

---

## Test Cases

### TC-12.8.1: Invoice List Page Loads

**Steps:**
1. Log in as SuperAdmin
2. Navigate to Invoices section

**Expected Results:**
- [ ] Page loads without errors
- [ ] Invoice list displayed (or empty state)
- [ ] Create button visible
- [ ] Search/filter options available

---

### TC-12.8.2: Create New Invoice

**Steps:**
1. Navigate to create invoice page
2. Fill in required fields:
   - Select customer tenant
   - Add line item: "Consulting - 2 hours @ 100.00"
   - Set issue date
   - Set due date
3. Save as draft

**Expected Results:**
- [ ] Invoice created successfully
- [ ] Invoice number generated (2026-001 format)
- [ ] Draft status set
- [ ] Appears in invoice list

---

### TC-12.8.3: Invoice Number Sequential

**Steps:**
1. Create first invoice of the year
2. Create second invoice
3. Check invoice numbers

**Expected Results:**
- [ ] First invoice: 2026-001
- [ ] Second invoice: 2026-002
- [ ] Numbers never skip
- [ ] Numbers never duplicate

---

### TC-12.8.4: Add Multiple Line Items

**Steps:**
1. Create new invoice
2. Add line item 1: "Product A - qty 2 @ 50.00"
3. Add line item 2: "Service B - qty 1 @ 100.00"
4. Add line item 3: "Discount - qty 1 @ -25.00"
5. Save

**Expected Results:**
- [ ] All line items saved
- [ ] Subtotal calculated: (100 + 100 - 25) = 175
- [ ] Can add/remove lines dynamically
- [ ] Calculations update in real-time

---

### TC-12.8.5: Tax Calculation

**Steps:**
1. Create invoice with line items totaling 100.00
2. Set tax rate to 21%
3. Save

**Expected Results:**
- [ ] Tax amount calculated: 21.00
- [ ] Total: 121.00
- [ ] Tax clearly displayed
- [ ] Stored correctly

---

### TC-12.8.6: Invoice PDF Generation

**Steps:**
1. Create and save an invoice
2. Click "Download PDF"

**Expected Results:**
- [ ] PDF downloads
- [ ] PDF contains company details (Checketts Propiedad SL)
- [ ] Tax ID displayed (ESB42691550)
- [ ] Company address shown
- [ ] Invoice number, date visible
- [ ] Line items listed
- [ ] Totals correct
- [ ] Professional layout

---

### TC-12.8.7: Send Invoice via Email

**Steps:**
1. Create and save an invoice
2. Click "Send Invoice"
3. Confirm send

**Expected Results:**
- [ ] Email sent to customer
- [ ] Email contains PDF attachment
- [ ] Invoice marked as "Sent"
- [ ] sent_at timestamp recorded
- [ ] Email looks professional

---

### TC-12.8.8: Record Payment

**Steps:**
1. View a sent invoice
2. Click "Record Payment"
3. Enter:
   - Amount: full invoice amount
   - Payment Method: Bank Transfer
   - Payment Date: today
   - Reference: "TXN-12345"
4. Save

**Expected Results:**
- [ ] Payment recorded
- [ ] Invoice status changes to "Paid"
- [ ] paid_at timestamp set
- [ ] Amount due shows 0
- [ ] Payment appears in history

---

### TC-12.8.9: Partial Payment

**Steps:**
1. Have invoice for 100.00
2. Record payment of 50.00
3. Check invoice status

**Expected Results:**
- [ ] Payment recorded
- [ ] Status: "Partially Paid"
- [ ] Amount paid: 50.00
- [ ] Amount due: 50.00
- [ ] Can record additional payments

---

### TC-12.8.10: Multiple Payments to Full

**Steps:**
1. Have invoice for 100.00
2. Record payment of 40.00
3. Record payment of 60.00

**Expected Results:**
- [ ] Both payments recorded
- [ ] Status changes to "Paid" after second
- [ ] Total paid: 100.00
- [ ] Amount due: 0.00

---

### TC-12.8.11: Void Invoice

**Steps:**
1. View an unpaid invoice
2. Click "Void Invoice"
3. Enter reason: "Customer cancelled order"
4. Confirm

**Expected Results:**
- [ ] Invoice status: "Void"
- [ ] Reason recorded
- [ ] Cannot modify voided invoice
- [ ] Invoice number preserved (not reused)

---

### TC-12.8.12: Create Credit Note

**Steps:**
1. View a paid invoice
2. Click "Create Credit Note"
3. Enter reason and amount

**Expected Results:**
- [ ] Credit note created
- [ ] Linked to original invoice
- [ ] Negative amount
- [ ] Credit note number assigned
- [ ] Original invoice reference shown

---

### TC-12.8.13: Edit Draft Invoice

**Steps:**
1. Create draft invoice
2. Return to edit it
3. Change line items
4. Save

**Expected Results:**
- [ ] Can edit draft invoices
- [ ] Changes saved
- [ ] Invoice number unchanged
- [ ] Calculations update

---

### TC-12.8.14: Cannot Edit Sent Invoice

**Steps:**
1. View a sent/paid invoice
2. Try to edit

**Expected Results:**
- [ ] Edit restricted or unavailable
- [ ] Must void and recreate
- [ ] Or create credit note
- [ ] Clear message explaining

---

### TC-12.8.15: Invoice Search and Filter

**Steps:**
1. Navigate to invoice list
2. Search by invoice number
3. Filter by status
4. Filter by date range

**Expected Results:**
- [ ] Search works correctly
- [ ] Status filter shows matching invoices
- [ ] Date filter works
- [ ] Results update appropriately

---

### TC-12.8.16: Overdue Invoice Detection

**Steps:**
1. Create invoice with past due date
2. Leave unpaid
3. Check invoice list

**Expected Results:**
- [ ] Invoice marked as "Overdue"
- [ ] Overdue filter shows it
- [ ] Visual indicator of overdue status

---

## Notes

- Invoice numbers must never be reused
- Test PDF rendering with long line item descriptions
- Verify tax calculations are precise (2 decimal places)
- Test email delivery to real addresses in staging
- Ensure audit trail for all invoice actions
- Platform company details must appear on every invoice
