# Feature 26.1: Payment Dunning System

**Status:** Not Started
**Effort:** Medium
**Phase:** 26 - Billing & Search Enhancements

## Overview

Automatic payment retry and grace period handling for failed subscription payments. When a payment fails, the system will automatically retry according to a schedule and notify the tenant owner. If all retries fail, the tenant enters a grace period before suspension.

## Requirements

### Functional Requirements
- Automatic payment retry on failure (days 1, 3, 7 after initial failure)
- 14-day grace period after all retries exhausted
- Payment failure notification emails to tenant owner
- Grace period warning notifications at 7 days and 3 days remaining
- Tenant suspension when grace period ends
- Easy payment method update flow for users
- Manual retry option for admins
- Dashboard showing current dunning status

### Dunning Schedule
1. Day 0: Initial payment failure - immediate notification
2. Day 1: First retry attempt
3. Day 3: Second retry attempt
4. Day 7: Third retry attempt
5. Day 7-21: 14-day grace period starts
6. Day 14: Grace period warning (7 days left)
7. Day 18: Final warning (3 days left)
8. Day 21: Tenant suspended

### Authorization
- SuperAdmins can view all dunning states
- Tenant Admins can view their own dunning status
- Tenant Admins can update payment method

## Database Changes

### Tables to Create

**payment_attempts**
| Column | Type | Description |
|--------|------|-------------|
| id | bigint | Primary key |
| tenant_id | bigint | Foreign key to tenants |
| stripe_payment_intent_id | string | Stripe payment intent ID |
| amount | integer | Amount in cents |
| currency | string | Currency code |
| status | string | succeeded/failed/pending |
| failure_code | string | Stripe failure code |
| failure_message | text | Human-readable failure reason |
| attempt_number | integer | Which retry attempt |
| created_at | timestamp | |

**dunning_states**
| Column | Type | Description |
|--------|------|-------------|
| id | bigint | Primary key |
| tenant_id | bigint | Foreign key to tenants |
| initial_failure_at | timestamp | When payment first failed |
| last_retry_at | timestamp | Last retry attempt |
| retry_count | integer | Number of retries attempted |
| grace_period_starts_at | timestamp | When grace period began |
| grace_period_ends_at | timestamp | When suspension will occur |
| status | string | retrying/grace_period/suspended/resolved |
| resolved_at | timestamp | When payment succeeded |
| created_at | timestamp | |
| updated_at | timestamp | |

## Files

### To Create
- `app/Models/PaymentAttempt.php`
- `app/Models/DunningState.php`
- `app/Enums/DunningStatus.php`
- `app/Services/DunningService.php`
- `app/Services/PaymentRetryService.php`
- `app/Http/Controllers/DunningController.php`
- `app/Console/Commands/ProcessDunning.php`
- `app/Listeners/HandlePaymentFailed.php`
- `app/Listeners/HandlePaymentSucceeded.php`
- `app/Notifications/PaymentFailedNotification.php`
- `app/Notifications/PaymentRetryNotification.php`
- `app/Notifications/GracePeriodWarningNotification.php`
- `app/Notifications/TenantSuspendedNotification.php`
- `resources/views/billing/dunning-status.blade.php`
- `resources/views/billing/update-payment-method.blade.php`
- `resources/views/emails/payment-failed.blade.php`
- `resources/views/emails/grace-period-warning.blade.php`
- `database/migrations/xxxx_create_payment_attempts_table.php`
- `database/migrations/xxxx_create_dunning_states_table.php`
- `tests/Feature/DunningTest.php`
- `tests/Feature/PaymentRetryTest.php`

### Routes
```php
Route::get('billing/dunning-status', [DunningController::class, 'status'])->name('billing.dunning.status');
Route::get('billing/update-payment', [DunningController::class, 'updatePaymentForm'])->name('billing.update-payment');
Route::post('billing/update-payment', [DunningController::class, 'updatePayment'])->name('billing.update-payment.store');
Route::post('billing/retry-payment', [DunningController::class, 'retryPayment'])->name('billing.retry-payment');
```

## Tasks

- [ ] Create database migrations for payment_attempts and dunning_states tables
- [ ] Create PaymentAttempt model
- [ ] Create DunningState model
- [ ] Create DunningStatus enum (Retrying, GracePeriod, Suspended, Resolved)
- [ ] Create DunningService for state management
- [ ] Create PaymentRetryService for Stripe integration
- [ ] Implement retry schedule logic (days 1, 3, 7)
- [ ] Create 14-day grace period logic
- [ ] Implement tenant suspension on grace period end
- [ ] Create HandlePaymentFailed listener
- [ ] Create HandlePaymentSucceeded listener
- [ ] Create payment failure notification email
- [ ] Create grace period warning notifications
- [ ] Create ProcessDunning command for scheduled retries
- [ ] Create payment method update flow
- [ ] Write tests for all dunning scenarios

## DunningStatus Enum

```php
enum DunningStatus: string
{
    case Retrying = 'retrying';
    case GracePeriod = 'grace_period';
    case Suspended = 'suspended';
    case Resolved = 'resolved';
}
```

## Tests

Expected tests in `tests/Feature/DunningTest.php`:

1. `test_payment_failure_creates_dunning_state`
2. `test_payment_failure_sends_notification`
3. `test_first_retry_occurs_on_day_one`
4. `test_second_retry_occurs_on_day_three`
5. `test_third_retry_occurs_on_day_seven`
6. `test_grace_period_starts_after_all_retries`
7. `test_grace_period_warning_sent_at_seven_days`
8. `test_final_warning_sent_at_three_days`
9. `test_tenant_suspended_when_grace_period_ends`
10. `test_successful_payment_resolves_dunning`
11. `test_admin_can_view_dunning_status`
12. `test_admin_can_update_payment_method`
13. `test_admin_can_manually_retry_payment`

## Dependencies

- Tenant model
- Stripe integration (Laravel Cashier)
- Notification system
- Scheduler for ProcessDunning command
