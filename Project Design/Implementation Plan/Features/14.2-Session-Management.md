# Feature 14.2: Session Management

**Status:** Not Started
**Effort:** Medium
**Phase:** 14 - Security Features

## Overview

Let users view and manage their active sessions. Users can see all devices where they are logged in, remotely log out sessions, and receive notifications when a new device logs in.

## Requirements

### Functional Requirements
- Track sessions on login (device, IP, location)
- Display session list with device details
- Enable remote logout of specific sessions
- "Log out all other sessions" button
- Send email notification on new device login
- Configurable session timeout per tenant
- Highlight current session in the list

### Session Details to Track
- Device name/type
- Browser name and version
- IP address
- Approximate location (from IP)
- Last activity timestamp
- Login timestamp

### UI Components
- Session list showing all active sessions
- Current session highlighted
- Logout button per session
- "Log out all other sessions" button
- Session timeout configuration (admin)

## Files

### To Create
- `app/Models/UserSession.php` - Session model
- `app/Http/Controllers/SessionController.php` - Controller
- `app/Listeners/TrackUserSessionListener.php` - Track on login
- `app/Notifications/NewDeviceLoginNotification.php` - Email notification
- `database/migrations/xxxx_create_user_sessions_table.php`
- `resources/views/settings/sessions.blade.php` - Sessions view
- `tests/Feature/SessionManagementTest.php` - Feature tests

### Routes
```php
Route::get('settings/sessions', [SessionController::class, 'index'])->name('settings.sessions');
Route::delete('settings/sessions/{session}', [SessionController::class, 'destroy'])->name('settings.sessions.destroy');
Route::post('settings/sessions/logout-others', [SessionController::class, 'logoutOthers'])->name('settings.sessions.logout-others');
```

## Database Schema

### user_sessions
```php
Schema::create('user_sessions', function (Blueprint $table) {
    $table->id();
    $table->foreignId('user_id')->constrained()->cascadeOnDelete();
    $table->string('session_id')->unique();
    $table->string('device_name')->nullable();
    $table->string('device_type')->nullable(); // desktop, mobile, tablet
    $table->string('browser')->nullable();
    $table->string('browser_version')->nullable();
    $table->string('platform')->nullable(); // Windows, Mac, iOS, Android
    $table->string('ip_address');
    $table->string('location')->nullable(); // City, Country
    $table->timestamp('last_activity_at');
    $table->timestamp('logged_in_at');
    $table->timestamps();
});
```

## Tasks

- [ ] Create user_sessions migration
- [ ] Track sessions on login (device, IP, location)
- [ ] Create session list view with device details
- [ ] Implement remote logout functionality
- [ ] Add "Log out all other sessions" button
- [ ] Send email notification on new device login
- [ ] Add session timeout configuration per tenant
- [ ] Highlight current session in list
- [ ] Write tests

## Tests

Suggested tests for `tests/Feature/SessionManagementTest.php`:

1. `test_user_can_view_active_sessions`
2. `test_session_is_tracked_on_login`
3. `test_session_shows_device_details`
4. `test_current_session_is_highlighted`
5. `test_user_can_logout_specific_session`
6. `test_user_can_logout_all_other_sessions`
7. `test_user_cannot_logout_current_session_via_destroy`
8. `test_new_device_login_sends_notification`
9. `test_known_device_does_not_send_notification`
10. `test_session_last_activity_is_updated`

## Dependencies

- User model
- Session handling middleware
- User-Agent parser library (e.g., jenssegers/agent)
- IP geolocation service (optional)
- Mail system for notifications
