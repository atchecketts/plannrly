# Feature 24.1: Manager Delegation System

**Status:** Not Started
**Effort:** Large
**Phase:** 24 - Delegation & Messaging

## Overview

Configurable delegation of management responsibilities. This allows managers to delegate specific permissions to other users for a defined scope (location, department, time period), enabling flexible management structures and coverage during absences.

## Requirements

### Functional Requirements
- Delegate specific permissions to other users
- Scope delegations by location, department, or team
- Time-bound delegations (temporary coverage)
- Optional approval workflow for delegations
- Audit logging for delegated actions
- Delegation management UI

### Delegatable Permissions
- Approve leave requests
- Approve shift swaps
- Edit schedules
- Clock in/out on behalf of others
- View reports
- Manage employees

### Delegation Scope
- **All** - Full access same as delegator
- **Location** - Specific location(s) only
- **Department** - Specific department(s) only
- **Team** - Specific employees only

### Delegation Types
- **Permanent** - Until manually revoked
- **Temporary** - Date range specified
- **Conditional** - Active when delegator is on leave

## Files

### To Create
- `app/Models/ManagerDelegation.php`
- `app/Models/DelegationAuditLog.php`
- `app/Services/DelegationService.php`
- `app/Http/Controllers/DelegationController.php`
- `app/Http/Requests/Delegation/StoreDelegationRequest.php`
- `app/Http/Requests/Delegation/UpdateDelegationRequest.php`
- `app/Policies/DelegationPolicy.php`
- `app/Observers/DelegationObserver.php`
- `resources/views/delegations/index.blade.php`
- `resources/views/delegations/create.blade.php`
- `resources/views/delegations/edit.blade.php`
- `resources/views/delegations/received.blade.php`
- `resources/views/admin/delegations/index.blade.php`
- `database/migrations/xxxx_create_manager_delegations_table.php`
- `database/migrations/xxxx_create_delegation_audit_logs_table.php`
- `tests/Feature/DelegationTest.php`

### To Modify
- `app/Models/TenantSettings.php` - Add delegation settings
- Authorization policies to check delegations

### Routes
```php
Route::prefix('delegations')->name('delegations.')->group(function () {
    Route::get('/', [DelegationController::class, 'index'])->name('index');
    Route::get('create', [DelegationController::class, 'create'])->name('create');
    Route::post('/', [DelegationController::class, 'store'])->name('store');
    Route::get('{delegation}/edit', [DelegationController::class, 'edit'])->name('edit');
    Route::put('{delegation}', [DelegationController::class, 'update'])->name('update');
    Route::delete('{delegation}', [DelegationController::class, 'destroy'])->name('destroy');
    Route::get('received', [DelegationController::class, 'received'])->name('received');
    Route::post('{delegation}/accept', [DelegationController::class, 'accept'])->name('accept');
    Route::post('{delegation}/decline', [DelegationController::class, 'decline'])->name('decline');
});

// Admin oversight
Route::get('admin/delegations', [AdminDelegationController::class, 'index'])->name('admin.delegations.index');
```

## Database Schema

### manager_delegations
| Column | Type | Description |
|--------|------|-------------|
| id | bigint | Primary key |
| tenant_id | bigint | Foreign key to tenants |
| delegator_id | bigint | User granting delegation |
| delegate_id | bigint | User receiving delegation |
| permissions | json | Array of delegated permissions |
| scope_type | string | all, location, department, team |
| scope_ids | json | IDs of scoped entities |
| type | string | permanent, temporary, conditional |
| starts_at | timestamp | When delegation starts |
| ends_at | timestamp | When delegation ends |
| reason | text | Reason for delegation |
| requires_approval | boolean | Needs admin approval |
| approved_by | bigint | Admin who approved |
| approved_at | timestamp | When approved |
| status | string | pending, active, expired, revoked |
| created_at | timestamp | |
| updated_at | timestamp | |

### delegation_audit_logs
| Column | Type | Description |
|--------|------|-------------|
| id | bigint | Primary key |
| delegation_id | bigint | Foreign key to delegations |
| user_id | bigint | User who performed action |
| action | string | Action performed |
| entity_type | string | Model type affected |
| entity_id | bigint | Model ID affected |
| changes | json | What was changed |
| ip_address | string | Request IP |
| user_agent | string | Request user agent |
| created_at | timestamp | |

## Delegation Service

```php
class DelegationService
{
    /**
     * Check if user has permission via delegation
     */
    public function hasDelegatedPermission(
        User $user,
        string $permission,
        ?Model $entity = null
    ): bool;

    /**
     * Get all active delegations for a user
     */
    public function getActiveDelegations(User $user): Collection;

    /**
     * Get all permissions user has (direct + delegated)
     */
    public function getEffectivePermissions(User $user): array;

    /**
     * Log an action performed under delegation
     */
    public function logDelegatedAction(
        ManagerDelegation $delegation,
        string $action,
        Model $entity,
        array $changes
    ): void;

    /**
     * Check if delegation is currently active
     */
    public function isActive(ManagerDelegation $delegation): bool;

    /**
     * Expire delegations that have passed their end date
     */
    public function expireOutdatedDelegations(): int;
}
```

## Integration with Authorization

Update policies to check delegations:

```php
class LeaveRequestPolicy
{
    public function approve(User $user, LeaveRequest $leaveRequest): bool
    {
        // Check direct permission
        if ($user->can('approve-leave')) {
            return true;
        }

        // Check delegated permission
        return app(DelegationService::class)
            ->hasDelegatedPermission($user, 'approve-leave', $leaveRequest);
    }
}
```

## Tenant Settings

| Setting | Type | Default | Description |
|---------|------|---------|-------------|
| delegation_enabled | boolean | true | Enable delegation feature |
| delegation_requires_approval | boolean | false | Admin must approve |
| delegation_max_duration | integer | 90 | Max days for temporary |
| delegation_audit_enabled | boolean | true | Log delegated actions |

## Tasks

- [ ] Create manager_delegations migration
- [ ] Create delegation_audit_logs migration
- [ ] Create ManagerDelegation model with relationships
- [ ] Create DelegationAuditLog model
- [ ] Create DelegationService
- [ ] Create DelegationController
- [ ] Create Form Request classes
- [ ] Create DelegationPolicy
- [ ] Create DelegationObserver
- [ ] Create delegation management UI (index, create, edit)
- [ ] Create "received delegations" view
- [ ] Integrate delegation checks into authorization policies
- [ ] Add delegation approval workflow
- [ ] Implement audit logging for delegated actions
- [ ] Add delegation settings to tenant configuration
- [ ] Create scheduled task to expire old delegations
- [ ] Write comprehensive tests

## Tests

Planned tests for `tests/Feature/DelegationTest.php`:

1. `test_manager_can_create_delegation`
2. `test_delegation_requires_valid_permissions`
3. `test_delegation_scoped_to_location`
4. `test_delegation_scoped_to_department`
5. `test_temporary_delegation_has_date_range`
6. `test_delegate_can_accept_delegation`
7. `test_delegate_can_decline_delegation`
8. `test_delegated_permission_allows_action`
9. `test_delegated_permission_respects_scope`
10. `test_expired_delegation_no_longer_active`
11. `test_revoked_delegation_no_longer_active`
12. `test_delegated_action_logged_to_audit`
13. `test_admin_approval_workflow`
14. `test_cannot_delegate_beyond_own_permissions`

## Dependencies

- User model
- Location model
- Department model
- Permission/Role system
- Audit logging
- Scheduled tasks
