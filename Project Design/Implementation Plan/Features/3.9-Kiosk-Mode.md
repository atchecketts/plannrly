# Feature 3.9: Kiosk Mode

**Status:** Pending
**Effort:** Large
**Phase:** 3 - Time & Attendance

## Overview

Shared clock-in terminals for locations where employees don't have individual devices. This feature enables a dedicated kiosk interface that multiple employees can use to clock in/out using PIN codes, badge scans, or QR codes.

## Requirements

### Functional Requirements
| Feature | Description |
|---------|-------------|
| Kiosk Registration | Admin creates kiosks per location |
| PIN Authentication | Employees enter 4-6 digit PIN |
| Badge Scan | Optional barcode/QR badge scanning |
| QR Code Auth | Employee shows QR from their phone |
| Photo Capture | Optional photo on clock in for verification |
| Touch Interface | Large buttons for tablet/touchscreen |
| Session Timeout | Auto-logout after clock action |
| Manager Override | PIN override for corrections |
| Activity Log | Full audit trail of all kiosk events |
| Remote Lock | Admin can lock kiosk remotely |

### Kiosk Terminal Flow
```
1. Kiosk loads terminal view (authenticated via access token)
2. Employee taps "Clock In" or "Clock Out"
3. Employee authenticates (PIN/badge/QR)
4. Optional: Photo capture
5. Clock action processed
6. Confirmation shown with shift details
7. Auto-return to idle screen after timeout
```

### Security Considerations
- PINs stored as bcrypt hashes
- Kiosk access tokens are long-lived but revokable
- Failed PIN attempts trigger temporary lockout (5 attempts, 15 min lock)
- All events logged with timestamps
- Photo evidence for disputed entries
- IP/device restrictions optional

## Files

### To Create
- `app/Models/Kiosk.php`
- `app/Models/EmployeePin.php`
- `app/Models/KioskEvent.php`
- `app/Services/KioskService.php`
- `app/Http/Controllers/KioskController.php`
- `app/Http/Controllers/KioskTerminalController.php`
- `app/Http/Controllers/EmployeePinController.php`
- `app/Http/Middleware/KioskAuthentication.php`
- `app/Http/Requests/Kiosk/StoreKioskRequest.php`
- `app/Http/Requests/Kiosk/TerminalAuthenticateRequest.php`
- `app/Policies/KioskPolicy.php`
- `resources/views/kiosks/index.blade.php`
- `resources/views/kiosks/create.blade.php`
- `resources/views/kiosks/edit.blade.php`
- `resources/views/kiosk-terminal/index.blade.php`
- `resources/views/kiosk-terminal/clock.blade.php`
- `tests/Feature/KioskTest.php`
- `tests/Feature/KioskTerminalTest.php`

### Database Migrations
- `kiosks` table
- `employee_pins` table
- `kiosk_events` table

## Tasks

- [ ] Create Kiosk model with relationships
- [ ] Create EmployeePin model (stores hashed PINs)
- [ ] Create KioskEvent model for audit trail
- [ ] Create KioskService with:
  - `registerKiosk()` - Create new kiosk
  - `generateAccessToken()` - Create secure token
  - `authenticateKiosk()` - Validate kiosk token
  - `authenticateEmployee()` - Verify PIN/badge/QR
  - `processClockAction()` - Handle clock in/out
  - `setEmployeePin()` - Set/update PIN
  - `verifyPin()` - Check PIN with lockout
  - `setKioskLock()` - Remote lock/unlock
  - `getClockedInEmployees()` - List currently clocked in
  - `getActivityLog()` - Audit trail
  - `managerOverride()` - Manager correction
- [ ] Create KioskAuthentication middleware
- [ ] Create KioskController for admin management
- [ ] Create KioskTerminalController for terminal API
- [ ] Create EmployeePinController for PIN management
- [ ] Create kiosk management views:
  - Index with list of kiosks per location
  - Create/edit forms with settings
  - Activity log viewer
- [ ] Create kiosk terminal interface:
  - Full-screen touch-optimized layout
  - Large clock in/out buttons
  - PIN entry keypad
  - Photo capture (using device camera)
  - Confirmation screen with shift details
  - Idle screen with time display
- [ ] Add PIN management to employee profile/settings
- [ ] Add "Set PIN" option in user management for admins
- [ ] Create manager override flow
- [ ] Implement failed attempt lockout (5 attempts, 15 min lock)
- [ ] Add routes with kiosk middleware
- [ ] Create dedicated /kiosk-terminal route for terminals
- [ ] Write tests for authentication flows
- [ ] Write tests for clock actions
- [ ] Write tests for audit logging
- [ ] Test on tablet devices

## Database Schema

### kiosks table
- `id` (bigint unsigned, PK)
- `tenant_id` (FK to tenants)
- `location_id` (FK to locations)
- `name` (string)
- `access_token` (string, hashed)
- `is_active` (boolean)
- `is_locked` (boolean)
- `settings` (json - photo_required, etc.)
- `last_activity_at` (timestamp)
- `timestamps`

### employee_pins table
- `id` (bigint unsigned, PK)
- `user_id` (FK to users)
- `pin` (string, hashed)
- `failed_attempts` (integer)
- `locked_until` (timestamp, nullable)
- `timestamps`

### kiosk_events table
- `id` (bigint unsigned, PK)
- `kiosk_id` (FK to kiosks)
- `user_id` (FK to users, nullable)
- `event_type` (string - clock_in, clock_out, failed_auth, etc.)
- `details` (json)
- `photo_path` (string, nullable)
- `created_at` (timestamp)

## Dependencies

- TimeEntry model and controller
- User model
- Location model
- Tenant model
- Feature 3.1 (Clock In/Out Core System)
