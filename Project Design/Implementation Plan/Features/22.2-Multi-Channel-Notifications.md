# Feature 22.2: Multi-Channel Notifications

**Status:** Not Started
**Effort:** Large
**Phase:** 22 - Data Retention & Notifications

## Overview

Support for Slack, Microsoft Teams, and WhatsApp notifications in addition to email. This allows organizations to reach employees through their preferred communication channels and integrate with existing team communication tools.

## Requirements

### Supported Channels
- **Email** - Default, always available
- **Slack** - Via Slack Bot integration
- **Microsoft Teams** - Via Microsoft Graph API
- **WhatsApp** - Via WhatsApp Business API (Twilio)

### Functional Requirements
- Workspace-level integration setup
- User-level channel preferences
- Fallback to email if preferred channel fails
- Rich message formatting per channel
- Delivery status tracking

### Integration Requirements

#### Slack
- OAuth 2.0 app installation
- Bot token storage
- Channel/DM delivery options
- Interactive message support

#### Microsoft Teams
- Microsoft Entra ID app registration
- Graph API integration
- Proactive messaging to users
- Adaptive card support

#### WhatsApp
- Twilio WhatsApp Business API
- Template message approval
- Phone number verification
- Media message support

## Files

### To Create
- `app/Models/NotificationChannel.php`
- `app/Models/UserNotificationChannel.php`
- `app/Models/WorkspaceIntegration.php`
- `app/Services/NotificationChannelService.php`
- `app/Notifications/Channels/SlackNotificationChannel.php`
- `app/Notifications/Channels/TeamsNotificationChannel.php`
- `app/Notifications/Channels/WhatsAppNotificationChannel.php`
- `app/Http/Controllers/NotificationChannelController.php`
- `app/Http/Controllers/WorkspaceIntegrationController.php`
- `app/Http/Controllers/Integrations/SlackOAuthController.php`
- `app/Http/Controllers/Integrations/TeamsOAuthController.php`
- `resources/views/settings/notification-channels.blade.php`
- `resources/views/settings/integrations/slack.blade.php`
- `resources/views/settings/integrations/teams.blade.php`
- `resources/views/settings/integrations/whatsapp.blade.php`
- `resources/views/profile/notification-preferences.blade.php`
- `database/migrations/xxxx_create_notification_channels_table.php`
- `database/migrations/xxxx_create_user_notification_channels_table.php`
- `database/migrations/xxxx_create_workspace_integrations_table.php`
- `tests/Feature/NotificationChannelsTest.php`

### Routes
```php
// Admin integration setup
Route::prefix('settings/integrations')->name('settings.integrations.')->group(function () {
    Route::get('/', [WorkspaceIntegrationController::class, 'index'])->name('index');

    // Slack
    Route::get('slack', [SlackOAuthController::class, 'redirect'])->name('slack');
    Route::get('slack/callback', [SlackOAuthController::class, 'callback'])->name('slack.callback');
    Route::delete('slack', [SlackOAuthController::class, 'disconnect'])->name('slack.disconnect');

    // Teams
    Route::get('teams', [TeamsOAuthController::class, 'redirect'])->name('teams');
    Route::get('teams/callback', [TeamsOAuthController::class, 'callback'])->name('teams.callback');
    Route::delete('teams', [TeamsOAuthController::class, 'disconnect'])->name('teams.disconnect');

    // WhatsApp
    Route::get('whatsapp', [WhatsAppController::class, 'setup'])->name('whatsapp');
    Route::post('whatsapp', [WhatsAppController::class, 'configure'])->name('whatsapp.configure');
});

// User preferences
Route::get('profile/notifications', [NotificationChannelController::class, 'preferences'])->name('profile.notifications');
Route::put('profile/notifications', [NotificationChannelController::class, 'updatePreferences'])->name('profile.notifications.update');
```

## Database Schema

### notification_channels
| Column | Type | Description |
|--------|------|-------------|
| id | bigint | Primary key |
| name | string | Channel identifier |
| display_name | string | User-friendly name |
| is_active | boolean | Globally enabled |
| config | json | Default configuration |
| created_at | timestamp | |
| updated_at | timestamp | |

### workspace_integrations
| Column | Type | Description |
|--------|------|-------------|
| id | bigint | Primary key |
| tenant_id | bigint | Foreign key to tenants |
| channel | string | slack, teams, whatsapp |
| access_token | text | Encrypted OAuth token |
| refresh_token | text | Encrypted refresh token |
| token_expires_at | timestamp | Token expiration |
| workspace_id | string | External workspace ID |
| workspace_name | string | External workspace name |
| config | json | Channel-specific config |
| is_active | boolean | Integration enabled |
| connected_at | timestamp | When connected |
| created_at | timestamp | |
| updated_at | timestamp | |

### user_notification_channels
| Column | Type | Description |
|--------|------|-------------|
| id | bigint | Primary key |
| user_id | bigint | Foreign key to users |
| channel | string | slack, teams, whatsapp, email |
| is_enabled | boolean | User enabled this channel |
| identifier | string | User's ID in channel |
| preferences | json | Per-notification-type settings |
| verified_at | timestamp | Channel verified |
| created_at | timestamp | |
| updated_at | timestamp | |

## Notification Methods

Each notification class needs these methods:

```php
class ShiftPublishedNotification extends Notification
{
    public function via($notifiable): array
    {
        return $notifiable->preferredChannels('shift_published');
    }

    public function toMail($notifiable): MailMessage { ... }

    public function toSlack($notifiable): SlackMessage { ... }

    public function toTeams($notifiable): TeamsMessage { ... }

    public function toWhatsApp($notifiable): WhatsAppMessage { ... }
}
```

## Tasks

- [ ] Create notification channel migrations
- [ ] Create NotificationChannel model
- [ ] Create UserNotificationChannel model
- [ ] Create WorkspaceIntegration model
- [ ] Create NotificationChannelService
- [ ] Implement Slack OAuth flow
- [ ] Create SlackNotificationChannel driver
- [ ] Implement Teams OAuth via Graph API
- [ ] Create TeamsNotificationChannel driver
- [ ] Implement WhatsApp via Twilio
- [ ] Create WhatsAppNotificationChannel driver
- [ ] Create admin integration setup pages
- [ ] Create user notification preferences UI
- [ ] Add toSlack() to existing notifications
- [ ] Add toTeams() to existing notifications
- [ ] Add toWhatsApp() to existing notifications
- [ ] Implement delivery fallback logic
- [ ] Write comprehensive tests

## Tests

Planned tests for `tests/Feature/NotificationChannelsTest.php`:

1. `test_admin_can_view_integrations_page`
2. `test_slack_oauth_flow_connects_workspace`
3. `test_teams_oauth_flow_connects_workspace`
4. `test_whatsapp_configuration_saves`
5. `test_user_can_set_channel_preferences`
6. `test_notification_sent_via_preferred_channel`
7. `test_notification_falls_back_to_email`
8. `test_slack_notification_formats_correctly`
9. `test_teams_notification_formats_correctly`
10. `test_whatsapp_notification_formats_correctly`
11. `test_disconnecting_integration_clears_tokens`
12. `test_expired_token_triggers_refresh`

## Dependencies

- Laravel Notifications
- Slack API SDK
- Microsoft Graph SDK
- Twilio SDK
- OAuth libraries
- Encryption for token storage
