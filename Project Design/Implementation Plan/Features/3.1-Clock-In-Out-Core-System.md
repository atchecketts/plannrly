# Feature 3.1: Clock In/Out Core System

**Status:** Complete
**Effort:** Large
**Phase:** 3 - Time & Attendance
**Completed:** January 2026

## Overview

Enable employees to clock in and out of shifts with full time tracking. This is the core system for time and attendance, providing the foundation for all time tracking functionality including break management, GPS capture, and manager approval workflows.

## Requirements

### Functional Requirements
- Employees can clock in to their shifts
- Employees can clock out of their shifts
- Break tracking (start/end break)
- Manager adjustment functionality with reason
- Manager approval workflow (if tenant requires it)
- GPS location capture (if configured)
- Grace period validation for clock-in times

### Controller Actions
```
TimeEntryController:
- index()           - List time entries (admin: all, employee: own)
- show()            - View single time entry details
- clockIn()         - Employee clocks in
- clockOut()        - Employee clocks out
- startBreak()      - Start break
- endBreak()        - End break
- adjust()          - Manager adjusts time entry
- approve()         - Manager approves time entry
- currentStatus()   - Get current clock status (API)
```

## Implementation Details

### Files Created
- `app/Http/Controllers/TimeEntryController.php` - Main controller with all actions
- `app/Http/Requests/TimeEntry/ClockInRequest.php` - Clock in validation with GPS support
- `app/Http/Requests/TimeEntry/ClockOutRequest.php` - Clock out validation
- `app/Http/Requests/TimeEntry/StartBreakRequest.php` - Break start validation
- `app/Http/Requests/TimeEntry/AdjustTimeEntryRequest.php` - Adjustment validation with min 10 char reason
- `app/Policies/TimeEntryPolicy.php` - Authorization for all time entry actions
- `resources/views/time-entries/index.blade.php` - List view with filters
- `resources/views/time-entries/show.blade.php` - Detail view with adjust/approve actions
- `resources/views/time-entries/_row.blade.php` - Table row partial
- `resources/views/components/clock-widget.blade.php` - Clock in/out widget with Alpine.js timer
- `tests/Feature/ClockInOutTest.php` - Employee clock actions tests (11 tests)
- `tests/Feature/TimeEntryTest.php` - Manager approval/adjustment tests (12 tests)

### Database Migrations Created
- `2026_01_29_081412_add_approval_fields_to_time_entries_table.php`
  - `approved_by` (bigint unsigned, nullable, FK to users)
  - `approved_at` (timestamp, nullable)
  - `adjustment_reason` (text, nullable)

- `2026_01_29_081426_add_clock_settings_to_tenant_settings_table.php`
  - `clock_in_grace_minutes` (smallint, default 15)
  - `require_gps_clock_in` (boolean, default false)
  - `auto_clock_out_enabled` (boolean, default false)
  - `auto_clock_out_time` (time, nullable)
  - `overtime_threshold_minutes` (smallint, default 480)
  - `require_manager_approval` (boolean, default false)

### Files Modified
- `app/Models/TimeEntry.php` - Added approval fields, methods, and scopes
- `app/Models/TenantSettings.php` - Added clock settings fields and casts
- `app/Providers/AppServiceProvider.php` - Registered TimeEntryPolicy
- `routes/web.php` - Added time entry routes
- `resources/views/components/layouts/app.blade.php` - Added Time Clock navigation link
- `resources/views/dashboard/employee.blade.php` - Added clock widget
- `resources/views/settings/edit.blade.php` - Added clock settings UI
- `app/Http/Requests/TenantSettings/UpdateTenantSettingsRequest.php` - Added clock settings validation
- `app/Http/Controllers/TenantSettingsController.php` - Added default clock settings
- `database/factories/TimeEntryFactory.php` - Added approval states
- `database/factories/TenantSettingsFactory.php` - Added clock-in state methods

## Routes Added
```php
Route::get('time-entries', [TimeEntryController::class, 'index'])->name('time-entries.index');
Route::get('time-entries/status', [TimeEntryController::class, 'currentStatus'])->name('time-entries.status');
Route::get('time-entries/{timeEntry}', [TimeEntryController::class, 'show'])->name('time-entries.show');
Route::post('time-entries/clock-in', [TimeEntryController::class, 'clockIn'])->name('time-entries.clock-in');
Route::post('time-entries/{timeEntry}/clock-out', [TimeEntryController::class, 'clockOut'])->name('time-entries.clock-out');
Route::post('time-entries/{timeEntry}/start-break', [TimeEntryController::class, 'startBreak'])->name('time-entries.start-break');
Route::post('time-entries/{timeEntry}/end-break', [TimeEntryController::class, 'endBreak'])->name('time-entries.end-break');
Route::put('time-entries/{timeEntry}/adjust', [TimeEntryController::class, 'adjust'])->name('time-entries.adjust');
Route::post('time-entries/{timeEntry}/approve', [TimeEntryController::class, 'approve'])->name('time-entries.approve');
```

## Tasks

- [x] Create TimeEntryController with all actions
- [x] Create form request validation classes
- [x] Create TimeEntryPolicy for authorization
- [x] Implement clock-in logic with validations:
  - Check tenant has clock-in enabled
  - Check employee not already clocked in
  - Validate shift assignment
  - Capture GPS location if required
- [x] Implement clock-out logic with validations:
  - Check employee is currently clocked in
  - Calculate actual worked minutes
  - Capture GPS location if configured
- [x] Implement break tracking (start/end break)
- [x] Add manager adjustment functionality with reason
- [x] Add manager approval workflow if tenant requires it
- [x] Create time entries index view with filtering
- [x] Create clock widget component with live timer
- [x] Add routes to web.php
- [x] Add navigation link (conditional on enable_clock_in_out)
- [x] Add clock widget to employee dashboard
- [x] Add clock settings UI to tenant settings
- [x] Write comprehensive tests (23 tests, all passing)

## Test Coverage

### ClockInOutTest.php (11 tests)
- Employee can clock in to assigned shift
- Cannot clock in when already clocked in
- Cannot clock in to unassigned shift
- Cannot clock in when feature disabled
- Can clock out
- Can start break
- Can end break
- GPS required validation
- Clock in with GPS location
- Employee can view own time entries
- Employee cannot view other employees time entry

### TimeEntryTest.php (12 tests)
- Admin can view all time entries
- Admin can view employee time entry
- Admin can adjust time entry
- Adjustment requires minimum reason length
- Admin can approve time entry
- Employee cannot approve time entry
- Employee cannot adjust time entry
- Tenant isolation prevents cross-tenant access
- Cannot approve already approved entry
- Time entry requires approval when setting enabled
- Time entry does not require approval when setting disabled
- Filter pending approval time entries

## Dependencies

- TimeEntry model (existing)
- TimeEntryStatus enum (existing)
- Shift model (existing)
- User model (existing)
- TenantSettings model (updated)
- Tenant model (existing)
- HandlesSorting trait (existing)
