# Feature 6.3: Employee Availability Management

**Status:** Completed
**Effort:** Large
**Phase:** 6 - Employee Management

## Overview

Allow employees to set their availability preferences and specific date exceptions. Admins can view availability when creating schedules, and the AI scheduling system can use this data to make intelligent assignments.

## Requirements

### Functional Requirements
- Employees can set recurring weekly availability (e.g., "Mon-Fri 9am-5pm")
- Employees can mark specific dates as unavailable
- Employees can set preference levels (preferred, available, if needed, unavailable)
- Employees can set effective date ranges for availability rules
- Visual calendar showing availability
- Admins can view employee availability during scheduling
- Show availability warnings on schedule view when conflicts exist

### Business Rules
- Recurring availability applies every week unless overridden
- Specific date exceptions take precedence over recurring rules
- Availability rules can have effective date ranges
- Availability should integrate with AI scheduling for optimization

### Database Schema
```sql
CREATE TABLE user_availability (
    id BIGINT UNSIGNED PRIMARY KEY,
    user_id BIGINT UNSIGNED,
    type ENUM('recurring', 'specific_date'),
    day_of_week TINYINT NULL, -- 0=Sun to 6=Sat
    specific_date DATE NULL,
    start_time TIME NULL,
    end_time TIME NULL,
    is_available BOOLEAN DEFAULT TRUE,
    preference_level ENUM('preferred', 'available', 'if_needed', 'unavailable'),
    notes TEXT NULL,
    effective_from DATE NULL,
    effective_until DATE NULL,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

## Files

### To Create
- `database/migrations/xxxx_create_user_availability_table.php`
- `app/Models/UserAvailability.php`
- `app/Enums/AvailabilityType.php`
- `app/Enums/PreferenceLevel.php`
- `app/Http/Controllers/AvailabilityController.php`
- `app/Http/Requests/Availability/StoreAvailabilityRequest.php`
- `app/Http/Requests/Availability/UpdateAvailabilityRequest.php`
- `app/Services/AvailabilityService.php`
- `resources/views/availability/index.blade.php`
- `resources/views/availability/edit.blade.php`
- `resources/views/components/availability-calendar.blade.php`
- `tests/Feature/AvailabilityTest.php`

### Routes
```php
Route::get('availability', [AvailabilityController::class, 'index'])->name('availability.index');
Route::get('availability/edit', [AvailabilityController::class, 'edit'])->name('availability.edit');
Route::post('availability', [AvailabilityController::class, 'store'])->name('availability.store');
Route::put('availability/{availability}', [AvailabilityController::class, 'update'])->name('availability.update');
Route::delete('availability/{availability}', [AvailabilityController::class, 'destroy'])->name('availability.destroy');
Route::get('users/{user}/availability', [AvailabilityController::class, 'show'])->name('users.availability');
```

## Tasks

- [ ] Create migration for user_availability table
- [ ] Create UserAvailability model with relationships and scopes
- [ ] Create AvailabilityType enum
- [ ] Create PreferenceLevel enum
- [ ] Create AvailabilityService for checking availability at a given time
- [ ] Create AvailabilityController
- [ ] Create availability calendar component
- [ ] Build recurring availability form (weekly schedule)
- [ ] Build specific date exception form
- [ ] Show availability warnings on schedule view when conflicts exist
- [ ] Add admin view for employee availability
- [ ] Integrate with AI scheduling (Phase 7 dependency)
- [ ] Write tests

## Tests

Tests to be created in `tests/Feature/AvailabilityTest.php`:

1. `test_employee_can_view_own_availability`
2. `test_employee_can_create_recurring_availability`
3. `test_employee_can_create_specific_date_exception`
4. `test_employee_can_update_availability`
5. `test_employee_can_delete_availability`
6. `test_admin_can_view_any_employee_availability`
7. `test_availability_service_returns_correct_status_for_date`
8. `test_specific_date_overrides_recurring_rule`
9. `test_effective_date_range_is_respected`
10. `test_preference_levels_are_correctly_stored`
11. `test_schedule_view_shows_availability_warnings`
12. `test_availability_calendar_displays_correctly`

## Dependencies

- User model
- AvailabilityType enum
- PreferenceLevel enum
- AI Scheduling Service (Phase 7 - for integration)
