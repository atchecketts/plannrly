# Feature 9.2: Offline Data Storage

**Status:** Not Started
**Effort:** Large
**Phase:** 9 - Mobile Interface & Accessibility

## Overview

Enable viewing schedules and queuing actions when offline. This feature uses IndexedDB for client-side storage, allowing employees to view their schedules and queue clock events even without network connectivity.

## Requirements

### Functional Requirements
- Users can view their schedule when offline
- Clock in/out actions are queued when offline
- Sync status indicator shows current online/offline state
- Pending actions sync automatically when back online
- Conflict resolution handles simultaneous edits

### Business Rules
- Cache last 14 days of shifts for offline access
- Store user profile and preferences offline
- Offline actions have timestamps for accurate reconciliation
- Conflicts default to server-side data with user notification

## Files

### Created/Modified
- `resources/js/offline-storage.js` - IndexedDB wrapper for client-side storage
- `app/Http/Controllers/Api/SyncController.php` - Sync service for offline actions
- `database/migrations/xxxx_create_offline_sync_queue_table.php` - Queue table for offline actions

### Routes
```php
Route::prefix('api/mobile')->group(function () {
    Route::post('sync', [SyncController::class, 'sync'])->name('api.sync');
    Route::get('sync/initial', [SyncController::class, 'initial'])->name('api.sync.initial');
});
```

## Tasks

- [ ] Implement IndexedDB wrapper for client-side storage
- [ ] Create shifts store for offline schedule viewing
- [ ] Create pending actions queue for clock events
- [ ] Build sync service to reconcile offline actions
- [ ] Add online/offline status detection
- [ ] Display sync status indicator in UI
- [ ] Implement conflict resolution for simultaneous edits
- [ ] Cache last 14 days of shifts for offline access
- [ ] Store user profile and preferences offline
- [ ] Write tests for offline scenarios

## Tests

Tests to be created in `tests/Feature/OfflineStorageTest.php`:

1. `test_initial_sync_returns_required_data`
2. `test_sync_endpoint_processes_queued_actions`
3. `test_sync_handles_clock_events`
4. `test_sync_detects_conflicts`
5. `test_sync_returns_updated_shifts`
6. `test_offline_queue_stores_actions`

## Dependencies

- Feature 9.1: PWA Foundation (service worker)
- Shift model
- ClockEvent model
- User model with profile data

## Notes

- IndexedDB is preferred over localStorage for complex data
- Consider using Dexie.js as IndexedDB wrapper
- Sync should be batched to reduce API calls
- Implement exponential backoff for failed syncs
