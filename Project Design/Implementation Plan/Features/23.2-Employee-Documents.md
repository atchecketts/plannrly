# Feature 23.2: Employee Document Management

**Status:** Not Started
**Effort:** Medium
**Phase:** 23 - Offline & Self-Service

## Overview

Self-service document uploads with verification workflow. Employees can upload required documents (certifications, IDs, licenses), and managers can verify them. The system tracks expiry dates and sends notifications before documents expire.

## Requirements

### Functional Requirements
- Employees can upload documents
- Configurable document types per tenant
- Manager verification workflow
- Expiry date tracking
- Automatic expiry notifications
- Document history retention
- Secure file storage

### Document Types (Configurable)
- Right to Work documents
- Professional certifications
- Driver's license
- Food safety certificate
- First aid certificate
- Security clearance
- Custom types per tenant

### Verification States
- **Pending** - Uploaded, awaiting review
- **Verified** - Manager approved
- **Rejected** - Manager rejected (with reason)
- **Expired** - Past expiry date

### Notification Schedule
- 30 days before expiry
- 14 days before expiry
- 7 days before expiry
- On expiry date
- Manager notification for team expiring documents

## Files

### To Create
- `app/Models/EmployeeDocument.php`
- `app/Models/DocumentType.php`
- `app/Services/EmployeeDocumentService.php`
- `app/Http/Controllers/EmployeeDocumentController.php`
- `app/Http/Controllers/DocumentTypeController.php`
- `app/Http/Requests/Document/UploadDocumentRequest.php`
- `app/Http/Requests/Document/VerifyDocumentRequest.php`
- `app/Policies/EmployeeDocumentPolicy.php`
- `app/Notifications/DocumentExpiringNotification.php`
- `app/Notifications/DocumentExpiredNotification.php`
- `app/Notifications/DocumentUploadedNotification.php`
- `app/Notifications/DocumentVerifiedNotification.php`
- `app/Notifications/DocumentRejectedNotification.php`
- `app/Console/Commands/CheckDocumentExpiry.php`
- `resources/views/employee/documents/index.blade.php`
- `resources/views/employee/documents/upload.blade.php`
- `resources/views/employee/documents/show.blade.php`
- `resources/views/admin/documents/pending.blade.php`
- `resources/views/admin/documents/verify.blade.php`
- `resources/views/admin/document-types/index.blade.php`
- `resources/views/admin/document-types/create.blade.php`
- `resources/views/admin/document-types/edit.blade.php`
- `database/migrations/xxxx_create_document_types_table.php`
- `database/migrations/xxxx_create_employee_documents_table.php`
- `tests/Feature/EmployeeDocumentTest.php`

### Routes
```php
// Employee document management
Route::prefix('my-documents')->name('my-documents.')->group(function () {
    Route::get('/', [EmployeeDocumentController::class, 'index'])->name('index');
    Route::get('upload', [EmployeeDocumentController::class, 'create'])->name('create');
    Route::post('upload', [EmployeeDocumentController::class, 'store'])->name('store');
    Route::get('{document}', [EmployeeDocumentController::class, 'show'])->name('show');
    Route::delete('{document}', [EmployeeDocumentController::class, 'destroy'])->name('destroy');
});

// Admin document verification
Route::prefix('documents')->name('documents.')->group(function () {
    Route::get('pending', [EmployeeDocumentController::class, 'pending'])->name('pending');
    Route::get('{document}/verify', [EmployeeDocumentController::class, 'verifyForm'])->name('verify');
    Route::post('{document}/verify', [EmployeeDocumentController::class, 'verify'])->name('verify.store');
    Route::post('{document}/reject', [EmployeeDocumentController::class, 'reject'])->name('reject');
});

// Document type configuration
Route::resource('document-types', DocumentTypeController::class)->except(['show']);
```

## Database Schema

### document_types
| Column | Type | Description |
|--------|------|-------------|
| id | bigint | Primary key |
| tenant_id | bigint | Foreign key to tenants |
| name | string | Document type name |
| description | text | Description/instructions |
| is_required | boolean | Required for all employees |
| has_expiry | boolean | Documents have expiry dates |
| expiry_warning_days | integer | Days before expiry to warn |
| allowed_extensions | json | Allowed file types |
| max_file_size | integer | Max size in KB |
| is_active | boolean | Type is active |
| created_at | timestamp | |
| updated_at | timestamp | |

### employee_documents
| Column | Type | Description |
|--------|------|-------------|
| id | bigint | Primary key |
| tenant_id | bigint | Foreign key to tenants |
| user_id | bigint | Foreign key to users (employee) |
| document_type_id | bigint | Foreign key to document_types |
| file_path | string | Storage path |
| original_filename | string | Original file name |
| file_size | integer | File size in bytes |
| mime_type | string | File MIME type |
| issue_date | date | Document issue date |
| expiry_date | date | Document expiry date |
| status | string | pending, verified, rejected, expired |
| verified_by | bigint | User who verified |
| verified_at | timestamp | When verified |
| rejection_reason | text | Reason if rejected |
| notes | text | Additional notes |
| expiry_notified_at | timestamp | Last expiry notification |
| created_at | timestamp | |
| updated_at | timestamp | |

## File Storage

- Store in private disk (not publicly accessible)
- Path: `documents/{tenant_id}/{user_id}/{document_id}/{filename}`
- Serve via signed URLs or controller method
- Scan uploads for viruses (optional)

## Tasks

- [ ] Create document_types migration
- [ ] Create employee_documents migration
- [ ] Create DocumentType model
- [ ] Create EmployeeDocument model with relationships
- [ ] Create EmployeeDocumentService
- [ ] Create EmployeeDocumentController
- [ ] Create DocumentTypeController
- [ ] Create upload form request with validation
- [ ] Create EmployeeDocumentPolicy
- [ ] Create employee document upload UI
- [ ] Create employee document listing UI
- [ ] Create document viewer component
- [ ] Create manager verification UI
- [ ] Create document type configuration UI
- [ ] Implement secure file storage
- [ ] Create DocumentExpiringNotification
- [ ] Create DocumentExpiredNotification
- [ ] Create DocumentUploadedNotification
- [ ] Create DocumentVerifiedNotification
- [ ] Create DocumentRejectedNotification
- [ ] Create CheckDocumentExpiry command
- [ ] Schedule expiry check daily
- [ ] Write comprehensive tests

## Tests

Planned tests for `tests/Feature/EmployeeDocumentTest.php`:

1. `test_employee_can_view_their_documents`
2. `test_employee_can_upload_document`
3. `test_upload_validates_file_type`
4. `test_upload_validates_file_size`
5. `test_employee_cannot_view_others_documents`
6. `test_manager_can_view_pending_documents`
7. `test_manager_can_verify_document`
8. `test_manager_can_reject_document`
9. `test_rejection_requires_reason`
10. `test_verified_notification_sent`
11. `test_expiring_document_notification_sent`
12. `test_expired_document_status_updated`
13. `test_admin_can_create_document_type`
14. `test_admin_can_update_document_type`
15. `test_document_securely_served`

## Dependencies

- File storage (Laravel filesystem)
- User model
- Tenant model
- Notification system
- Queue system for notifications
- Scheduled tasks
