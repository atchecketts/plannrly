# Feature 29.2: Employee Offboarding

**Status:** Not Started
**Effort:** Medium
**Phase:** 29 - Employee Lifecycle & Bulk Operations

## Overview

Graceful employee departure workflow with data preservation. Provides a structured process for removing employees from the system while maintaining historical data integrity and ensuring all necessary tasks are completed.

## Requirements

### Functional Requirements

#### Offboarding Initiation
- Admin initiates offboarding for an employee
- Specify reason for departure
- Set last working day
- Optionally specify immediate effect

#### Automated Actions
- Remove from future schedules (after last day)
- Cancel pending shift assignments
- Reassign pending approval tasks
- Archive direct messages
- Revoke system access on departure date

#### Checklist Tasks
- Configurable offboarding checklist
- Equipment return tracking
- Final payroll processing note
- Knowledge transfer tasks
- Exit interview scheduling

#### Data Handling
- Soft delete employee record
- Preserve historical data (shifts, timesheets)
- Anonymize personal data per retention policy
- Export employee data on request (GDPR)

### Authorization
- Only Admins can initiate offboarding
- Admins can configure offboarding tasks
- Departing employee sees countdown/status

## Database Changes

### Tables to Create

**employee_offboardings**
| Column | Type | Description |
|--------|------|-------------|
| id | bigint | Primary key |
| tenant_id | bigint | Foreign key to tenants |
| user_id | bigint | Departing employee |
| initiated_by | bigint | Admin who started process |
| reason | string | Reason for departure |
| last_working_day | date | Final day of work |
| is_immediate | boolean | Immediate termination |
| status | string | pending/in_progress/completed |
| access_revoked_at | timestamp | When access was removed |
| completed_at | timestamp | When fully processed |
| notes | text | Additional notes |
| created_at | timestamp | |
| updated_at | timestamp | |

**offboarding_tasks**
| Column | Type | Description |
|--------|------|-------------|
| id | bigint | Primary key |
| offboarding_id | bigint | Foreign key to offboardings |
| title | string | Task title |
| description | text | Task details |
| assigned_to | bigint | Who should complete task |
| is_required | boolean | Must complete |
| status | string | pending/completed/skipped |
| completed_by | bigint | Who completed it |
| completed_at | timestamp | When completed |
| created_at | timestamp | |
| updated_at | timestamp | |

## Files

### To Create
- `app/Models/EmployeeOffboarding.php`
- `app/Models/OffboardingTask.php`
- `app/Enums/OffboardingStatus.php`
- `app/Enums/OffboardingReason.php`
- `app/Enums/OffboardingTaskStatus.php`
- `app/Services/OffboardingService.php`
- `app/Http/Controllers/OffboardingController.php`
- `app/Http/Requests/Offboarding/InitiateOffboardingRequest.php`
- `app/Notifications/OffboardingInitiatedNotification.php`
- `app/Notifications/OffboardingCompleteNotification.php`
- `app/Console/Commands/ProcessOffboardings.php`
- `app/Listeners/HandleEmployeeOffboarding.php`
- `resources/views/employees/offboarding/initiate.blade.php`
- `resources/views/employees/offboarding/show.blade.php`
- `resources/views/employees/offboarding/tasks.blade.php`
- `resources/views/settings/offboarding-tasks.blade.php`
- `database/migrations/xxxx_create_employee_offboardings_table.php`
- `database/migrations/xxxx_create_offboarding_tasks_table.php`
- `tests/Feature/OffboardingTest.php`

### Routes
```php
Route::get('employees/{employee}/offboard', [OffboardingController::class, 'create'])->name('employees.offboard.create');
Route::post('employees/{employee}/offboard', [OffboardingController::class, 'store'])->name('employees.offboard.store');
Route::get('offboarding/{offboarding}', [OffboardingController::class, 'show'])->name('offboarding.show');
Route::post('offboarding/{offboarding}/task/{task}/complete', [OffboardingController::class, 'completeTask'])->name('offboarding.task.complete');
Route::post('offboarding/{offboarding}/complete', [OffboardingController::class, 'complete'])->name('offboarding.complete');
Route::post('offboarding/{offboarding}/cancel', [OffboardingController::class, 'cancel'])->name('offboarding.cancel');
Route::get('settings/offboarding-tasks', [OffboardingController::class, 'taskSettings'])->name('settings.offboarding-tasks');
```

## Tasks

- [ ] Create database migrations for offboarding tables
- [ ] Create EmployeeOffboarding model
- [ ] Create OffboardingTask model
- [ ] Create OffboardingStatus enum (Pending, InProgress, Completed, Cancelled)
- [ ] Create OffboardingReason enum (Resignation, Termination, Retirement, etc.)
- [ ] Create OffboardingTaskStatus enum (Pending, Completed, Skipped)
- [ ] Create OffboardingService for business logic
- [ ] Create offboarding initiation workflow
- [ ] Implement removal from future schedules
- [ ] Build pending task reassignment
- [ ] Create message archival system
- [ ] Implement access revocation (soft delete)
- [ ] Add offboarding task checklist
- [ ] Create ProcessOffboardings command
- [ ] Create notifications for offboarding events
- [ ] Write tests for all offboarding scenarios

## Offboarding Enums

```php
enum OffboardingStatus: string
{
    case Pending = 'pending';
    case InProgress = 'in_progress';
    case Completed = 'completed';
    case Cancelled = 'cancelled';
}

enum OffboardingReason: string
{
    case Resignation = 'resignation';
    case Termination = 'termination';
    case Retirement = 'retirement';
    case EndOfContract = 'end_of_contract';
    case Layoff = 'layoff';
    case Other = 'other';
}

enum OffboardingTaskStatus: string
{
    case Pending = 'pending';
    case Completed = 'completed';
    case Skipped = 'skipped';
}
```

## OffboardingService

```php
class OffboardingService
{
    public function initiate(User $employee, array $data): EmployeeOffboarding
    {
        $offboarding = EmployeeOffboarding::create([
            'user_id' => $employee->id,
            'tenant_id' => $employee->tenant_id,
            // ... other fields
        ]);

        $this->createDefaultTasks($offboarding);
        $this->scheduleAutomatedActions($offboarding);

        $employee->notify(new OffboardingInitiatedNotification($offboarding));

        return $offboarding;
    }

    public function removeFromFutureSchedules(EmployeeOffboarding $offboarding): void
    {
        Shift::where('user_id', $offboarding->user_id)
            ->where('date', '>', $offboarding->last_working_day)
            ->update(['user_id' => null, 'status' => ShiftStatus::Unassigned]);
    }

    public function revokeAccess(EmployeeOffboarding $offboarding): void
    {
        $offboarding->user->update(['is_active' => false]);
        $offboarding->update(['access_revoked_at' => now()]);
    }
}
```

## Default Offboarding Tasks

1. Return company equipment
2. Handover pending work
3. Update documentation
4. Conduct exit interview
5. Process final payroll
6. Revoke system access
7. Archive email/messages

## Tests

Expected tests in `tests/Feature/OffboardingTest.php`:

1. `test_admin_can_initiate_offboarding`
2. `test_employee_cannot_initiate_offboarding`
3. `test_offboarding_removes_from_future_schedules`
4. `test_offboarding_reassigns_pending_approvals`
5. `test_immediate_offboarding_revokes_access`
6. `test_scheduled_offboarding_waits_until_last_day`
7. `test_offboarding_tasks_created`
8. `test_task_can_be_completed`
9. `test_offboarding_completion_requires_all_required_tasks`
10. `test_offboarding_can_be_cancelled`
11. `test_employee_soft_deleted_on_completion`
12. `test_historical_data_preserved`

## Dependencies

- User model with soft deletes
- Shift model
- Approval system
- Message model (for archival)
- Notification system
