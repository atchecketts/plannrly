# Feature 27.1: Advanced Shift Patterns

**Status:** Not Started
**Effort:** Large
**Phase:** 27 - Advanced Shift Features

## Overview

Support for complex shift patterns including split shifts, rotating schedules, on-call shifts, and overnight shifts that cross midnight. This enables businesses with more complex scheduling needs to accurately represent their workforce requirements.

## Requirements

### Functional Requirements

#### Split Shifts
- A shift can be split into multiple parts (e.g., 7am-11am and 4pm-8pm)
- Split shifts are linked via parent_shift_id
- Total hours calculated across all parts
- Display as single unit in some views, separate in others

#### Rotating Schedules
- Define rotation patterns (e.g., 4 days on, 3 days off)
- Assign employees to rotation groups
- Auto-generate shifts based on rotation
- Support multiple rotation lengths (weekly, bi-weekly, monthly)

#### On-Call Shifts
- Mark shifts as on-call (standby)
- Different pay rates for on-call vs active time
- Track when on-call becomes active
- On-call availability separate from scheduled shifts

#### Overnight Shifts
- Shifts can cross midnight (10pm - 6am)
- Proper date handling for overnight shifts
- Correct hour calculation across dates
- Clear visual indication of overnight shifts

### Authorization
- Admins can create all shift types
- Managers can create shifts in their department
- Employees can view their assigned shifts

## Database Changes

### Tables to Create

**shift_patterns**
| Column | Type | Description |
|--------|------|-------------|
| id | bigint | Primary key |
| tenant_id | bigint | Foreign key to tenants |
| name | string | Pattern name |
| type | string | rotation/template |
| config | json | Pattern configuration |
| is_active | boolean | Currently in use |
| created_at | timestamp | |
| updated_at | timestamp | |

**rotation_schedules**
| Column | Type | Description |
|--------|------|-------------|
| id | bigint | Primary key |
| tenant_id | bigint | Foreign key to tenants |
| name | string | Schedule name (e.g., "Week A/B") |
| rotation_length_days | integer | Length of one rotation |
| pattern | json | Array of daily patterns |
| start_date | date | When rotation begins |
| is_active | boolean | Currently in use |
| created_at | timestamp | |
| updated_at | timestamp | |

**rotation_assignments**
| Column | Type | Description |
|--------|------|-------------|
| id | bigint | Primary key |
| rotation_schedule_id | bigint | Foreign key to rotation_schedules |
| user_id | bigint | Assigned employee |
| rotation_group | string | Which group (A, B, C, etc.) |
| effective_from | date | Start date for this assignment |
| effective_until | date | End date (nullable for ongoing) |
| created_at | timestamp | |
| updated_at | timestamp | |

### Columns to Add to shifts table
| Column | Type | Description |
|--------|------|-------------|
| shift_type | string | standard/split/on_call |
| parent_shift_id | bigint | For split shifts, links to parent |
| is_on_call | boolean | Whether shift is on-call |
| on_call_rate | decimal | Pay rate for on-call hours |
| crosses_midnight | boolean | Whether shift spans two days |

## Files

### To Create
- `app/Models/ShiftPattern.php`
- `app/Models/RotationSchedule.php`
- `app/Models/RotationAssignment.php`
- `app/Enums/ShiftType.php`
- `app/Services/ShiftPatternService.php`
- `app/Services/RotationService.php`
- `app/Http/Controllers/ShiftPatternController.php`
- `app/Http/Controllers/RotationController.php`
- `app/Http/Requests/RotationSchedule/StoreRotationRequest.php`
- `app/Http/Requests/RotationSchedule/UpdateRotationRequest.php`
- `app/Console/Commands/GenerateRotationShifts.php`
- `resources/views/shift-patterns/index.blade.php`
- `resources/views/shift-patterns/create.blade.php`
- `resources/views/rotations/index.blade.php`
- `resources/views/rotations/create.blade.php`
- `resources/views/rotations/assignments.blade.php`
- `database/migrations/xxxx_create_shift_patterns_table.php`
- `database/migrations/xxxx_create_rotation_schedules_table.php`
- `database/migrations/xxxx_create_rotation_assignments_table.php`
- `database/migrations/xxxx_add_advanced_shift_columns_to_shifts_table.php`
- `tests/Feature/ShiftPatternTest.php`
- `tests/Feature/RotationTest.php`
- `tests/Feature/OvernightShiftTest.php`

### Routes
```php
Route::resource('shift-patterns', ShiftPatternController::class);
Route::resource('rotations', RotationController::class);
Route::get('rotations/{rotation}/assignments', [RotationController::class, 'assignments'])->name('rotations.assignments');
Route::post('rotations/{rotation}/assignments', [RotationController::class, 'assignEmployee'])->name('rotations.assign');
Route::delete('rotations/{rotation}/assignments/{assignment}', [RotationController::class, 'removeAssignment'])->name('rotations.unassign');
Route::post('rotations/{rotation}/generate', [RotationController::class, 'generateShifts'])->name('rotations.generate');
```

## Tasks

- [ ] Create database migrations for new tables and shift columns
- [ ] Create ShiftPattern model
- [ ] Create RotationSchedule model
- [ ] Create RotationAssignment model
- [ ] Create ShiftType enum (Standard, Split, OnCall)
- [ ] Create ShiftPatternService for pattern management
- [ ] Create RotationService for rotation logic
- [ ] Implement split shift creation linking child shifts to parent
- [ ] Implement rotation schedule builder UI
- [ ] Create rotation assignment interface
- [ ] Handle overnight shifts crossing midnight in calculations
- [ ] Add on-call shift support with special rates
- [ ] Update schedule views to display new shift types correctly
- [ ] Create GenerateRotationShifts command
- [ ] Write comprehensive tests for all patterns

## ShiftType Enum

```php
enum ShiftType: string
{
    case Standard = 'standard';
    case Split = 'split';
    case OnCall = 'on_call';
}
```

## Rotation Pattern Example

```json
{
  "name": "Week A/B Rotation",
  "rotation_length_days": 14,
  "groups": ["A", "B"],
  "pattern": [
    {"day": 1, "group_a": "day", "group_b": "off"},
    {"day": 2, "group_a": "day", "group_b": "off"},
    {"day": 3, "group_a": "day", "group_b": "off"},
    {"day": 4, "group_a": "day", "group_b": "off"},
    {"day": 5, "group_a": "off", "group_b": "day"},
    {"day": 6, "group_a": "off", "group_b": "day"},
    {"day": 7, "group_a": "off", "group_b": "day"}
  ]
}
```

## Tests

Expected tests in `tests/Feature/ShiftPatternTest.php`:

1. `test_admin_can_create_split_shift`
2. `test_split_shift_links_to_parent`
3. `test_split_shift_calculates_total_hours`
4. `test_admin_can_create_rotation_schedule`
5. `test_admin_can_assign_employee_to_rotation`
6. `test_rotation_generates_correct_shifts`
7. `test_overnight_shift_crosses_midnight`
8. `test_overnight_shift_calculates_hours_correctly`
9. `test_on_call_shift_has_different_rate`
10. `test_schedule_view_displays_shift_types_correctly`
11. `test_rotation_respects_effective_dates`
12. `test_employee_can_view_rotation_assignment`

## Dependencies

- Shift model (existing)
- User model
- Tenant model
- Schedule views (existing)
