# Feature 6.4: Leave Calendar View

**Status:** Complete
**Effort:** Medium
**Phase:** 6 - Employee Management
**Completed:** January 2026

## Overview

Integrate leave request display into the existing schedule views (week and day views) to show approved leave alongside shifts. This approach allows managers and admins to see staffing availability at a glance within the same view they use for scheduling.

## Implementation Approach

Rather than creating a separate leave calendar view, leave is now displayed directly in:
- **Week Schedule View** (`/schedule`) - Shows leave as colored blocks in the day cells
- **Day Schedule View** (`/schedule/day`) - Shows leave as colored bars positioned by time

### Key Features
- Leave blocks use the leave type's configured color for easy visual identification
- Half-day leave (AM/PM) is displayed appropriately:
  - Week view: Shows half-filled cells (left half for AM, right half for PM)
  - Day view: Shows positioned bars covering the appropriate hours (start of day to noon for AM, noon to end of day for PM)
- Full-day leave shows across the entire cell/timeline

## Requirements

### Functional Requirements
- [x] Display approved leave requests in schedule views
- [x] Color-code leave entries by leave type (uses `LeaveType.color` field)
- [x] Support half-day leave display (AM/PM)
- [x] Show leave alongside shifts on the same calendar view
- [x] Eager load leave type relationship for performance

### Business Rules
- Only approved leave requests are shown on the schedule
- Leave type colors are defined in the LeaveType model
- Half-day leave interpretation:
  - `start_half_day = true`: Leave starts in the afternoon (PM only)
  - `end_half_day = true`: Leave ends in the morning (AM only)
- Midday is defined as 12:00 PM for AM/PM split

## Files Modified

### Controllers
- `app/Http/Controllers/ScheduleController.php`
  - Added eager loading of `leaveType` relationship on leave requests
  - Week view: `index()` method
  - Day view: `day()` method

### Views
- `resources/views/schedule/index.blade.php` (Week View)
  - Updated leave block rendering to use leave type color
  - Added half-day display logic (AM/PM split cells)

- `resources/views/schedule/day.blade.php` (Day View)
  - Updated leave block rendering to use leave type color
  - Added half-day positioning logic (positioned based on hours)

### Factories
- `database/factories/LeaveRequestFactory.php`
  - Added `startHalfDay()` state
  - Added `endHalfDay()` state

### Tests
- `tests/Feature/LeaveCalendarViewTest.php` (new file - 15 tests)

## Technical Implementation

### Week View Leave Display

The week view shows leave in day cells. For half-day leave:

```blade
@if($showPmOnly)
    {{-- Start date with half day: only PM (right half) is on leave --}}
    <div class="w-1/2"></div>
    <div class="w-1/2" style="background-color: {{ $leaveColor }}33;">PM</div>
@elseif($showAmOnly)
    {{-- End date with half day: only AM (left half) is on leave --}}
    <div class="w-1/2" style="background-color: {{ $leaveColor }}33;">AM</div>
    <div class="w-1/2"></div>
@else
    {{-- Full day leave --}}
    <div class="w-full" style="background-color: {{ $leaveColor }}33;">{{ Leave Type Name }}</div>
@endif
```

### Day View Leave Display

The day view positions leave on a timeline. For half-day leave:

```php
// Calculate positioning for half-day leave
$midday = 12;
if ($showPmOnly) {
    // PM only: from noon to end of day
    $leaveLeftPercent = (($midday - $dayStartHour) / $numHours) * 100;
    $leaveWidthPercent = 100 - $leaveLeftPercent;
} elseif ($showAmOnly) {
    // AM only: from start of day to noon
    $leaveLeftPercent = 0;
    $leaveWidthPercent = (($midday - $dayStartHour) / $numHours) * 100;
}
```

### Color System

Leave blocks use the hex color stored in `LeaveType.color`:
- Background: `{{ $leaveColor }}33` (20% opacity)
- Border: `{{ $leaveColor }}80` (50% opacity)
- Text: Full color

Example colors by leave type:
- Annual Leave: `#3B82F6` (blue)
- Sick Leave: `#EF4444` (red)
- Unpaid Leave: `#6B7280` (gray)

## Tasks

- [x] Update ScheduleController to eager load leaveType relationship
- [x] Update week view leave blocks to use leave type colors
- [x] Implement half-day display in week view (AM/PM split cells)
- [x] Update day view leave blocks to use leave type colors
- [x] Implement half-day positioning in day view (time-based positioning)
- [x] Add factory states for half-day leave testing
- [x] Write tests for leave calendar view integration

## Tests

Tests created in `tests/Feature/LeaveCalendarViewTest.php`:

1. `test_week_schedule_shows_approved_leave_in_lookup`
2. `test_week_schedule_does_not_show_draft_leave`
3. `test_week_schedule_leave_lookup_includes_leave_type`
4. `test_day_schedule_shows_approved_leave_in_lookup`
5. `test_day_schedule_leave_lookup_includes_leave_type`
6. `test_leave_request_half_day_flags_are_accessible`
7. `test_leave_request_end_half_day_flags_are_accessible`
8. `test_multiple_leave_types_have_different_colors`
9. `test_week_schedule_renders_without_errors_with_leave`
10. `test_day_schedule_renders_without_errors_with_leave`
11. `test_week_schedule_renders_with_half_day_start_leave`
12. `test_week_schedule_renders_with_half_day_end_leave`
13. `test_day_schedule_renders_with_half_day_pm_leave`
14. `test_day_schedule_renders_with_half_day_am_leave`
15. `test_multiple_leave_types_have_different_colors`

## Dependencies

- LeaveRequest model (existing)
- LeaveType model with color field (existing)
- Schedule views (existing)
- ScheduleController (existing)
