# Feature 28.1: Configurable Approval Workflows

**Status:** Not Started
**Effort:** Large
**Phase:** 28 - Workflows & Visibility

## Overview

Tenant-defined approval chains for various actions. Allows administrators to configure multi-step approval processes for leave requests, shift swaps, overtime, expenses, and other approvable items based on conditions like amount, duration, or employee role.

## Requirements

### Functional Requirements

#### Workflow Configuration
- Define approval workflows per action type
- Support multi-step approval chains
- Configure approvers by role, specific user, or reporting manager
- Set conditions for workflow matching (e.g., leave > 3 days)
- Enable/disable workflows

#### Approval Process
- Route requests through configured workflow
- Track approval status at each step
- Allow approve/reject with comments
- Support delegation when approver is unavailable
- Escalation on timeout (configurable)

#### Supported Action Types
- Leave requests
- Shift swaps
- Overtime requests
- Expense claims
- Schedule changes
- Time corrections

#### Dashboard
- View all pending approvals
- Filter by type, status, urgency
- Bulk approve/reject
- Approval history

### Authorization
- Admins can configure workflows
- Approvers see items assigned to them
- Employees can view their request status

## Database Changes

### Tables to Create

**approval_workflows**
| Column | Type | Description |
|--------|------|-------------|
| id | bigint | Primary key |
| tenant_id | bigint | Foreign key to tenants |
| name | string | Workflow name |
| action_type | string | leave/swap/overtime/expense |
| conditions | json | When this workflow applies |
| steps | json | Approval steps configuration |
| timeout_hours | integer | Hours before escalation |
| is_active | boolean | Currently enabled |
| priority | integer | Order when multiple match |
| created_at | timestamp | |
| updated_at | timestamp | |

**approval_requests**
| Column | Type | Description |
|--------|------|-------------|
| id | bigint | Primary key |
| approval_workflow_id | bigint | Foreign key to workflows |
| approvable_type | string | Model class being approved |
| approvable_id | bigint | Model ID being approved |
| requester_id | bigint | User who submitted request |
| current_step | integer | Current approval step |
| status | string | pending/approved/rejected/cancelled |
| completed_at | timestamp | When fully processed |
| created_at | timestamp | |
| updated_at | timestamp | |

**approval_actions**
| Column | Type | Description |
|--------|------|-------------|
| id | bigint | Primary key |
| approval_request_id | bigint | Foreign key to requests |
| step_number | integer | Which step this action is for |
| approver_id | bigint | User who took action |
| action | string | approved/rejected/delegated |
| comments | text | Optional comments |
| created_at | timestamp | |

## Files

### To Create
- `app/Models/ApprovalWorkflow.php`
- `app/Models/ApprovalRequest.php`
- `app/Models/ApprovalAction.php`
- `app/Enums/ApprovalStatus.php`
- `app/Enums/ApprovalActionType.php`
- `app/Enums/ApprovableType.php`
- `app/Services/ApprovalWorkflowService.php`
- `app/Services/ApprovalRoutingService.php`
- `app/Traits/Approvable.php`
- `app/Http/Controllers/ApprovalWorkflowController.php`
- `app/Http/Controllers/ApprovalController.php`
- `app/Http/Requests/ApprovalWorkflow/StoreWorkflowRequest.php`
- `app/Http/Requests/ApprovalWorkflow/UpdateWorkflowRequest.php`
- `app/Notifications/ApprovalRequiredNotification.php`
- `app/Notifications/ApprovalDecisionNotification.php`
- `app/Console/Commands/EscalateApprovals.php`
- `resources/views/settings/approval-workflows/index.blade.php`
- `resources/views/settings/approval-workflows/create.blade.php`
- `resources/views/settings/approval-workflows/edit.blade.php`
- `resources/views/approvals/index.blade.php`
- `resources/views/approvals/show.blade.php`
- `resources/views/components/approval-status.blade.php`
- `database/migrations/xxxx_create_approval_workflows_table.php`
- `database/migrations/xxxx_create_approval_requests_table.php`
- `database/migrations/xxxx_create_approval_actions_table.php`
- `tests/Feature/ApprovalWorkflowTest.php`
- `tests/Feature/ApprovalProcessTest.php`

### Routes
```php
Route::resource('settings/approval-workflows', ApprovalWorkflowController::class);
Route::get('approvals', [ApprovalController::class, 'index'])->name('approvals.index');
Route::get('approvals/{approval}', [ApprovalController::class, 'show'])->name('approvals.show');
Route::post('approvals/{approval}/approve', [ApprovalController::class, 'approve'])->name('approvals.approve');
Route::post('approvals/{approval}/reject', [ApprovalController::class, 'reject'])->name('approvals.reject');
Route::post('approvals/{approval}/delegate', [ApprovalController::class, 'delegate'])->name('approvals.delegate');
Route::post('approvals/bulk-approve', [ApprovalController::class, 'bulkApprove'])->name('approvals.bulk-approve');
```

## Tasks

- [ ] Create database migrations for workflow tables
- [ ] Create ApprovalWorkflow model with JSON configs
- [ ] Create ApprovalRequest model with polymorphic relationship
- [ ] Create ApprovalAction model
- [ ] Create ApprovalStatus enum (Pending, Approved, Rejected, Cancelled)
- [ ] Create ApprovalActionType enum (Approved, Rejected, Delegated)
- [ ] Create ApprovableType enum (Leave, Swap, Overtime, Expense)
- [ ] Create Approvable trait for models
- [ ] Create ApprovalWorkflowService for configuration
- [ ] Create ApprovalRoutingService for request routing
- [ ] Build workflow designer UI with steps
- [ ] Implement multi-step approval chains
- [ ] Add condition-based workflow matching
- [ ] Integrate with leave requests
- [ ] Integrate with shift swaps
- [ ] Integrate with overtime requests
- [ ] Create approval dashboard
- [ ] Implement delegation functionality
- [ ] Add EscalateApprovals command for timeout handling
- [ ] Write tests

## Workflow Configuration Example

```json
{
  "name": "Extended Leave Approval",
  "action_type": "leave",
  "conditions": {
    "operator": "and",
    "rules": [
      {"field": "duration_days", "operator": ">", "value": 3}
    ]
  },
  "steps": [
    {
      "step": 1,
      "approver_type": "reporting_manager",
      "approver_id": null
    },
    {
      "step": 2,
      "approver_type": "role",
      "approver_id": "hr_manager"
    }
  ],
  "timeout_hours": 48
}
```

## Approvable Trait

```php
trait Approvable
{
    public function approvalRequest(): MorphOne
    {
        return $this->morphOne(ApprovalRequest::class, 'approvable');
    }

    public function submitForApproval(): ApprovalRequest
    {
        return app(ApprovalWorkflowService::class)->submitForApproval($this);
    }

    public function isApproved(): bool
    {
        return $this->approvalRequest?->status === ApprovalStatus::Approved;
    }
}
```

## Tests

Expected tests in `tests/Feature/ApprovalWorkflowTest.php`:

1. `test_admin_can_create_approval_workflow`
2. `test_workflow_requires_at_least_one_step`
3. `test_admin_can_edit_workflow`
4. `test_admin_can_delete_unused_workflow`
5. `test_correct_workflow_matched_by_conditions`
6. `test_request_routed_to_first_approver`
7. `test_approval_moves_to_next_step`
8. `test_rejection_ends_workflow`
9. `test_final_approval_completes_request`
10. `test_approver_can_delegate`
11. `test_escalation_on_timeout`
12. `test_bulk_approve_works`
13. `test_employee_sees_request_status`

## Dependencies

- LeaveRequest model (with Approvable trait)
- ShiftSwapRequest model (with Approvable trait)
- User model with reporting manager relationship
- Notification system
- Scheduler for escalation command
