# Feature 20.2: Data Import

**Status:** Not Started
**Effort:** Medium
**Phase:** 20 - Onboarding & Import

## Overview

Import employees and data from CSV and Excel files. This feature enables bulk data import with field mapping, validation preview, and error handling for smooth data migration.

## Requirements

### Functional Requirements
- Support CSV and Excel (XLSX) file uploads
- Interactive field mapping interface
- Data validation before import
- Preview with validation errors highlighted
- Import with mapped fields
- Error reporting with line numbers
- Support partial import (skip errors)
- Import history and status tracking

### Supported Import Types
- Employees
- Locations (future)
- Departments (future)
- Business roles (future)

### Field Mapping
- Auto-detect common column names
- Manual mapping interface
- Save mapping templates
- Transform data during import

### Validation Rules
- Required fields check
- Email format validation
- Duplicate detection
- Foreign key validation (location, department)

## Files

### To Create
- `app/Services/DataImportService.php`
- `app/Services/Import/EmployeeImporter.php`
- `app/Http/Controllers/ImportController.php`
- `app/Http/Requests/Import/UploadFileRequest.php`
- `app/Http/Requests/Import/MappingRequest.php`
- `app/Jobs/ProcessImportJob.php`
- `app/Models/ImportHistory.php`
- `resources/views/import/index.blade.php`
- `resources/views/import/upload.blade.php`
- `resources/views/import/mapping.blade.php`
- `resources/views/import/preview.blade.php`
- `resources/views/import/results.blade.php`
- `database/migrations/xxxx_create_import_history_table.php`
- `tests/Feature/DataImportTest.php`

### Routes
```php
Route::prefix('import')->name('import.')->group(function () {
    Route::get('/', [ImportController::class, 'index'])->name('index');
    Route::get('employees', [ImportController::class, 'employees'])->name('employees');
    Route::post('upload', [ImportController::class, 'upload'])->name('upload');
    Route::get('mapping/{importId}', [ImportController::class, 'mapping'])->name('mapping');
    Route::post('mapping/{importId}', [ImportController::class, 'saveMapping'])->name('save-mapping');
    Route::get('preview/{importId}', [ImportController::class, 'preview'])->name('preview');
    Route::post('execute/{importId}', [ImportController::class, 'execute'])->name('execute');
    Route::get('results/{importId}', [ImportController::class, 'results'])->name('results');
    Route::get('template/{type}', [ImportController::class, 'template'])->name('template');
});
```

## Database Schema

### import_history
| Column | Type | Description |
|--------|------|-------------|
| id | bigint | Primary key |
| tenant_id | bigint | Foreign key to tenants |
| user_id | bigint | User who initiated import |
| type | string | Import type (employees, etc.) |
| filename | string | Original filename |
| file_path | string | Stored file path |
| mapping | json | Field mapping configuration |
| total_rows | integer | Total rows in file |
| processed_rows | integer | Rows processed |
| success_count | integer | Successfully imported |
| error_count | integer | Failed imports |
| errors | json | Error details with line numbers |
| status | string | pending, processing, completed, failed |
| started_at | timestamp | Processing start time |
| completed_at | timestamp | Processing end time |
| created_at | timestamp | |
| updated_at | timestamp | |

## Import Workflow

1. **Upload** - User uploads CSV/Excel file
2. **Parse** - System reads file and detects columns
3. **Map** - User maps file columns to system fields
4. **Validate** - System validates all rows
5. **Preview** - User reviews data with errors highlighted
6. **Import** - User confirms and import executes
7. **Results** - User views success/failure summary

## Employee Import Fields

| System Field | Required | Description |
|--------------|----------|-------------|
| first_name | Yes | Employee first name |
| last_name | Yes | Employee last name |
| email | Yes | Unique email address |
| phone | No | Phone number |
| employee_id | No | Custom employee identifier |
| department | No | Department name (matched) |
| location | No | Location name (matched) |
| business_role | No | Role name (matched) |
| hourly_rate | No | Pay rate |
| start_date | No | Employment start date |

## Tasks

- [ ] Create import_history migration
- [ ] Create ImportHistory model
- [ ] Create DataImportService base class
- [ ] Create EmployeeImporter service
- [ ] Create ImportController with workflow steps
- [ ] Create file upload handling (CSV/Excel)
- [ ] Create field mapping interface
- [ ] Implement auto-detect for common columns
- [ ] Create validation with error collection
- [ ] Create preview page with error highlighting
- [ ] Create ProcessImportJob for async processing
- [ ] Implement partial import (skip errors)
- [ ] Report errors with line numbers
- [ ] Create downloadable import template
- [ ] Create import results page
- [ ] Write comprehensive tests

## Tests

Planned tests for `tests/Feature/DataImportTest.php`:

1. `test_admin_can_view_import_page`
2. `test_employee_cannot_access_import`
3. `test_can_upload_csv_file`
4. `test_can_upload_excel_file`
5. `test_rejects_invalid_file_type`
6. `test_mapping_interface_shows_columns`
7. `test_auto_detects_common_columns`
8. `test_validation_catches_missing_required`
9. `test_validation_catches_invalid_email`
10. `test_validation_catches_duplicates`
11. `test_preview_shows_errors_with_line_numbers`
12. `test_can_import_valid_employees`
13. `test_partial_import_skips_errors`
14. `test_import_results_show_summary`
15. `test_can_download_import_template`

## Dependencies

- Laravel Excel package (maatwebsite/excel)
- Tenant model
- User/Employee model
- Department model
- Location model
- BusinessRole model
- Queue system for async processing
