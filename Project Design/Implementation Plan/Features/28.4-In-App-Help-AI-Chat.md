# Feature 28.4: In-App Help & AI Chat

**Status:** Not Started
**Effort:** Large
**Phase:** 28 - Workflows & Visibility

## Overview

Contextual help and AI assistant for admins. Provides tooltips and help content throughout the application, plus an AI-powered chat assistant that can answer questions about using the system, explain features, and help troubleshoot issues.

## Requirements

### Functional Requirements

#### Contextual Help Tooltips
- Help icons (?) next to complex features
- Hover/click to see explanation
- Links to relevant documentation
- Dismissable "first time" tutorials

#### Searchable Knowledge Base
- Built-in help documentation
- Full-text search
- Organized by feature area
- Step-by-step guides

#### AI Chat Assistant
- Natural language questions about the system
- Context-aware responses (knows current page)
- Can explain features and workflows
- Troubleshooting assistance
- Available via chat widget

#### Tier Restrictions
- Contextual tooltips: All tiers
- Knowledge base: All tiers
- AI chat: Professional tier and above
- AI chat without limits: Enterprise tier

### AI Assistant Capabilities
- Answer "How do I...?" questions
- Explain error messages
- Suggest workflow improvements
- Guide through complex processes
- Remember conversation context

### Authorization
- All users see contextual help
- All users access knowledge base
- AI chat restricted to business admins (Professional+)

## Files

### To Create
- `app/Services/HelpService.php`
- `app/Services/AIChatService.php`
- `app/Services/KnowledgeBaseService.php`
- `app/Http/Controllers/HelpController.php`
- `app/Http/Controllers/AIChatController.php`
- `app/Http/Requests/AIChat/SendMessageRequest.php`
- `app/Data/HelpArticle.php`
- `app/Data/ChatMessage.php`
- `resources/views/components/help-tooltip.blade.php`
- `resources/views/components/help-icon.blade.php`
- `resources/views/components/ai-chat-widget.blade.php`
- `resources/views/help/index.blade.php`
- `resources/views/help/article.blade.php`
- `resources/views/help/search.blade.php`
- `resources/content/help/*.md` (help articles in markdown)
- `tests/Feature/HelpSystemTest.php`
- `tests/Feature/AIChatTest.php`

### Routes
```php
Route::get('help', [HelpController::class, 'index'])->name('help.index');
Route::get('help/search', [HelpController::class, 'search'])->name('help.search');
Route::get('help/{slug}', [HelpController::class, 'show'])->name('help.show');
Route::get('help/context/{feature}', [HelpController::class, 'contextual'])->name('help.contextual');

Route::post('ai-chat/message', [AIChatController::class, 'sendMessage'])->name('ai-chat.send');
Route::get('ai-chat/history', [AIChatController::class, 'history'])->name('ai-chat.history');
Route::delete('ai-chat/history', [AIChatController::class, 'clearHistory'])->name('ai-chat.clear');
```

## Tasks

- [ ] Create HelpService for managing help content
- [ ] Create KnowledgeBaseService for documentation
- [ ] Create help-tooltip Blade component
- [ ] Create help-icon component with click handler
- [ ] Build searchable knowledge base interface
- [ ] Write help content for major features
- [ ] Create AIChatService for AI integration
- [ ] Integrate AI API (OpenAI GPT-4 or Claude)
- [ ] Build AI chat widget component
- [ ] Implement conversation history
- [ ] Add context injection (current page, user role)
- [ ] Tier-gate AI chat (Professional+)
- [ ] Rate limit AI chat requests
- [ ] Create contextual help API endpoint
- [ ] Write tests

## Help Tooltip Component

```blade
<x-help-tooltip feature="shift-swap">
    <p>Shift swaps allow employees to exchange shifts with each other.</p>
    <a href="{{ route('help.show', 'shift-swaps') }}">Learn more</a>
</x-help-tooltip>
```

## AIChatService

```php
class AIChatService
{
    public function __construct(
        private OpenAI $client,
        private KnowledgeBaseService $knowledgeBase,
    ) {}

    public function sendMessage(User $user, string $message, array $context = []): ChatMessage
    {
        // Check tier access
        if (!$user->tenant->canAccessFeature('ai_chat')) {
            throw new FeatureNotAvailableException('AI Chat requires Professional tier');
        }

        // Build system prompt with context
        $systemPrompt = $this->buildSystemPrompt($user, $context);

        // Get relevant knowledge base articles
        $relevantDocs = $this->knowledgeBase->searchRelevant($message);

        // Send to AI API
        $response = $this->client->chat()->create([
            'model' => 'gpt-4',
            'messages' => [
                ['role' => 'system', 'content' => $systemPrompt],
                ['role' => 'user', 'content' => $message],
            ],
        ]);

        return new ChatMessage(
            role: 'assistant',
            content: $response->choices[0]->message->content,
        );
    }
}
```

## AI Context Injection

```json
{
  "current_page": "schedules.index",
  "user_role": "admin",
  "tenant_tier": "professional",
  "recent_actions": ["created_shift", "viewed_employee"],
  "relevant_help_articles": ["scheduling-basics", "shift-management"]
}
```

## Help Content Structure

```
resources/content/help/
├── getting-started/
│   ├── introduction.md
│   ├── first-steps.md
│   └── quick-tour.md
├── scheduling/
│   ├── creating-shifts.md
│   ├── shift-templates.md
│   └── shift-swaps.md
├── employees/
│   ├── adding-employees.md
│   ├── roles-permissions.md
│   └── availability.md
└── ...
```

## Tests

Expected tests in `tests/Feature/AIChatTest.php`:

1. `test_professional_tier_can_access_ai_chat`
2. `test_free_tier_cannot_access_ai_chat`
3. `test_ai_chat_returns_response`
4. `test_ai_chat_includes_context`
5. `test_chat_history_is_stored`
6. `test_user_can_clear_chat_history`
7. `test_rate_limiting_applied`
8. `test_help_tooltip_renders_content`
9. `test_knowledge_base_search_works`
10. `test_contextual_help_returns_relevant_content`
11. `test_help_article_renders_markdown`

## Dependencies

- OpenAI PHP SDK or Claude API
- Markdown parser for help articles
- User model with tenant relationship
- Subscription tier system
- Rate limiting (Laravel's built-in)
