# Feature 12.2: Checkout & Subscription Flow

**Status:** Not Started
**Effort:** Large
**Phase:** 12 - Stripe Payment Integration

## Overview

Subscription purchase and management. This feature implements the complete subscription lifecycle including checkout, plan changes, cancellation, and trial periods.

## Requirements

### Functional Requirements
- Subscription overview page
- Stripe Checkout for new subscriptions
- Success/cancel return pages
- Plan upgrade/downgrade with proration
- Subscription cancellation
- Subscription resume (before end date)
- Trial period support

### Business Rules
- Proration applied for mid-cycle changes
- Downgrade takes effect at end of billing period
- Upgrade takes effect immediately
- Trial period configurable per plan

## Files

### Created/Modified
- `resources/views/subscription/index.blade.php` - Subscription overview
- `resources/views/subscription/checkout.blade.php` - Checkout page
- `resources/views/subscription/success.blade.php` - Success page
- `resources/views/subscription/manage.blade.php` - Manage subscription

### Routes
```php
Route::middleware('auth')->prefix('subscription')->group(function () {
    Route::get('/', [SubscriptionController::class, 'index'])
        ->name('subscription.index');
    Route::get('/checkout/{plan}', [SubscriptionController::class, 'checkout'])
        ->name('subscription.checkout');
    Route::post('/checkout', [SubscriptionController::class, 'processCheckout'])
        ->name('subscription.checkout.process');
    Route::get('/success', [SubscriptionController::class, 'success'])
        ->name('subscription.success');
    Route::get('/cancel', [SubscriptionController::class, 'cancelPage'])
        ->name('subscription.cancel-page');
    Route::post('/change-plan', [SubscriptionController::class, 'changePlan'])
        ->name('subscription.change-plan');
    Route::post('/cancel', [SubscriptionController::class, 'cancel'])
        ->name('subscription.cancel');
    Route::post('/resume', [SubscriptionController::class, 'resume'])
        ->name('subscription.resume');
});
```

## Tasks

- [ ] Create subscription overview page
- [ ] Implement Stripe Checkout for new subscriptions
- [ ] Create success/cancel return pages
- [ ] Implement plan change (upgrade/downgrade)
- [ ] Handle proration for mid-cycle changes
- [ ] Implement subscription cancellation
- [ ] Implement subscription resume (before end date)
- [ ] Add trial period support
- [ ] Write integration tests

## Tests

Tests to be created in `tests/Feature/SubscriptionFlowTest.php`:

1. `test_subscription_index_shows_current_plan`
2. `test_user_can_start_checkout`
3. `test_checkout_redirects_to_stripe`
4. `test_success_page_shows_confirmation`
5. `test_user_can_upgrade_plan`
6. `test_user_can_downgrade_plan`
7. `test_proration_calculated_on_upgrade`
8. `test_user_can_cancel_subscription`
9. `test_user_can_resume_cancelled_subscription`
10. `test_trial_period_works`

## Dependencies

- Feature 12.1: Stripe Setup & Customer Management
- Tenant model with Billable trait

## Notes

### Stripe Checkout Implementation
```php
public function checkout(Request $request, string $plan)
{
    $tenant = $request->user()->tenant;
    $priceId = config("stripe.plans.{$plan}.monthly");

    return $tenant->newSubscription('default', $priceId)
        ->trialDays(14)
        ->checkout([
            'success_url' => route('subscription.success'),
            'cancel_url' => route('subscription.cancel-page'),
        ]);
}
```

### Plan Change
```php
public function changePlan(Request $request)
{
    $tenant = $request->user()->tenant;
    $newPriceId = config("stripe.plans.{$request->plan}.monthly");

    $tenant->subscription('default')
        ->swap($newPriceId);
}
```

### Cancellation
```php
public function cancel(Request $request)
{
    $tenant = $request->user()->tenant;

    // Cancel at end of period
    $tenant->subscription('default')->cancel();

    // Or cancel immediately
    // $tenant->subscription('default')->cancelNow();
}
```
