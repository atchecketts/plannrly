# Feature 20.3: Competitor Import

**Status:** Not Started
**Effort:** Large
**Phase:** 20 - Onboarding & Import

## Overview

Import data from competitor scheduling systems. This feature enables easy migration from Deputy, When I Work, and 7shifts by understanding their export formats and mapping data to Plannrly's structure.

## Requirements

### Functional Requirements
- Import from Deputy, When I Work, and 7shifts
- Auto-detect file format from competitor
- Map competitor fields to Plannrly fields
- Handle data transformations
- Guided import wizard per competitor
- Preserve historical data where possible

### Supported Competitors

#### Deputy
- Employee export (CSV)
- Timesheet export (CSV)
- Location/Area export

#### When I Work
- Employee export (CSV/Excel)
- Schedule export
- Time entries export

#### 7shifts
- Employee export (CSV)
- Schedule export (CSV)
- Roles export

### Data Mapping

| Plannrly Field | Deputy | When I Work | 7shifts |
|----------------|--------|-------------|---------|
| first_name | FirstName | First Name | first_name |
| last_name | LastName | Last Name | last_name |
| email | Email | Email | email |
| phone | Phone | Phone | phone_number |
| hourly_rate | PayRate | Pay Rate | wage |
| department | Area | Position | role |

## Files

### To Create
- `app/Contracts/CompetitorImporter.php`
- `app/Services/Import/DeputyImporter.php`
- `app/Services/Import/WhenIWorkImporter.php`
- `app/Services/Import/SevenShiftsImporter.php`
- `app/Services/Import/CompetitorDetectorService.php`
- `app/Http/Controllers/CompetitorImportController.php`
- `resources/views/import/competitor/index.blade.php`
- `resources/views/import/competitor/deputy.blade.php`
- `resources/views/import/competitor/when-i-work.blade.php`
- `resources/views/import/competitor/seven-shifts.blade.php`
- `resources/views/import/competitor/mapping.blade.php`
- `resources/views/import/competitor/preview.blade.php`
- `tests/Feature/CompetitorImportTest.php`

### Routes
```php
Route::prefix('import/competitor')->name('import.competitor.')->group(function () {
    Route::get('/', [CompetitorImportController::class, 'index'])->name('index');
    Route::get('{competitor}', [CompetitorImportController::class, 'show'])->name('show');
    Route::post('{competitor}/upload', [CompetitorImportController::class, 'upload'])->name('upload');
    Route::get('{competitor}/mapping/{importId}', [CompetitorImportController::class, 'mapping'])->name('mapping');
    Route::post('{competitor}/mapping/{importId}', [CompetitorImportController::class, 'saveMapping'])->name('save-mapping');
    Route::get('{competitor}/preview/{importId}', [CompetitorImportController::class, 'preview'])->name('preview');
    Route::post('{competitor}/execute/{importId}', [CompetitorImportController::class, 'execute'])->name('execute');
    Route::post('detect', [CompetitorImportController::class, 'detect'])->name('detect');
});
```

## Competitor Importer Interface

```php
interface CompetitorImporter
{
    /**
     * Get the competitor name
     */
    public function name(): string;

    /**
     * Detect if file matches this competitor's format
     */
    public function detect(string $filePath): bool;

    /**
     * Get available import types for this competitor
     */
    public function availableTypes(): array;

    /**
     * Parse the file and return normalized data
     */
    public function parse(string $filePath, string $type): array;

    /**
     * Get field mapping for the import type
     */
    public function getFieldMapping(string $type): array;

    /**
     * Transform a row from competitor format to Plannrly format
     */
    public function transform(array $row, string $type): array;
}
```

## Import Types per Competitor

### Deputy
| Type | Description |
|------|-------------|
| employees | Staff/team members |
| timesheets | Clock in/out records |
| locations | Areas/locations |

### When I Work
| Type | Description |
|------|-------------|
| employees | Team members |
| schedules | Published schedules |
| time_entries | Time tracking data |

### 7shifts
| Type | Description |
|------|-------------|
| employees | Staff members |
| schedules | Shift schedules |
| roles | Job roles/positions |

## Tasks

- [ ] Create CompetitorImporter interface
- [ ] Create CompetitorDetectorService for auto-detection
- [ ] Implement DeputyImporter
  - [ ] Employee import
  - [ ] Timesheet import
  - [ ] Location import
- [ ] Implement WhenIWorkImporter
  - [ ] Employee import
  - [ ] Schedule import
  - [ ] Time entries import
- [ ] Implement SevenShiftsImporter
  - [ ] Employee import
  - [ ] Schedule import
  - [ ] Roles import
- [ ] Create CompetitorImportController
- [ ] Create competitor selection page
- [ ] Create per-competitor wizard views
- [ ] Implement auto-detect file format
- [ ] Create mapping interface with pre-filled defaults
- [ ] Handle data transformations
- [ ] Create preview with competitor-specific validation
- [ ] Write comprehensive tests

## Tests

Planned tests for `tests/Feature/CompetitorImportTest.php`:

1. `test_admin_can_view_competitor_import_page`
2. `test_can_detect_deputy_file_format`
3. `test_can_detect_when_i_work_file_format`
4. `test_can_detect_seven_shifts_file_format`
5. `test_deputy_employee_import_maps_correctly`
6. `test_when_i_work_employee_import_maps_correctly`
7. `test_seven_shifts_employee_import_maps_correctly`
8. `test_deputy_timesheet_import`
9. `test_handles_missing_optional_fields`
10. `test_transforms_date_formats_correctly`
11. `test_transforms_phone_formats_correctly`
12. `test_preview_shows_transformed_data`
13. `test_import_creates_employees`
14. `test_import_creates_related_entities`

## Dependencies

- DataImportService (from 20.2)
- ImportHistory model
- Laravel Excel package
- Tenant model
- User/Employee model
- Department/Location models
