# Feature 12.1: Stripe Setup & Customer Management

**Status:** Not Started
**Effort:** Large
**Phase:** 12 - Stripe Payment Integration

## Overview

Core Stripe integration for payments. This feature sets up Laravel Cashier and establishes the foundation for all payment functionality including customer creation and subscription management.

## Requirements

### Functional Requirements
- Laravel Cashier installed and configured
- Stripe products and prices created
- Customer created automatically on tenant registration
- Config file with plan/price mappings

### Technical Requirements
- Stripe API keys configured
- Webhook secret configured
- Billable trait added to Tenant model
- Cashier migrations run

### Dependencies
- Install Laravel Cashier: `composer require laravel/cashier`

## Environment Variables

```env
STRIPE_KEY=pk_...
STRIPE_SECRET=sk_...
STRIPE_WEBHOOK_SECRET=whsec_...
CASHIER_CURRENCY=usd
```

## Database Changes

Run Cashier migrations which create:
- `customers` table
- `subscriptions` table
- `subscription_items` table

## Files

### Created/Modified
- `app/Services/StripeService.php` - Stripe wrapper service
- `app/Http/Controllers/SubscriptionController.php` - Subscription controller
- `app/Http/Controllers/StripeWebhookController.php` - Webhook handler
- `config/stripe.php` - Plan/price configuration

### Routes
```php
Route::middleware('auth')->group(function () {
    Route::get('subscription', [SubscriptionController::class, 'index'])
        ->name('subscription.index');
});
```

## Tasks

- [ ] Install and configure Laravel Cashier
- [ ] Create Stripe products and prices in Stripe Dashboard
- [ ] Create StripeService wrapper class
- [ ] Add Billable trait to Tenant model
- [ ] Create customer on tenant registration
- [ ] Create config file with plan/price mappings
- [ ] Write unit tests for Stripe service

## Tests

Tests to be created in `tests/Feature/StripeSetupTest.php`:

1. `test_tenant_has_billable_trait`
2. `test_stripe_customer_created_on_registration`
3. `test_stripe_service_instantiates`
4. `test_config_has_plan_mappings`
5. `test_can_retrieve_stripe_customer`

## Dependencies

- Tenant model
- User registration flow

## Notes

### Config File Structure
```php
// config/stripe.php
return [
    'plans' => [
        'starter' => [
            'monthly' => 'price_xxx',
            'yearly' => 'price_xxx',
        ],
        'professional' => [
            'monthly' => 'price_xxx',
            'yearly' => 'price_xxx',
        ],
        'enterprise' => [
            'monthly' => 'price_xxx',
            'yearly' => 'price_xxx',
        ],
    ],
    'addons' => [
        'advanced_analytics' => 'price_xxx',
        'geofencing' => 'price_xxx',
        'payroll_integrations' => 'price_xxx',
    ],
];
```

### Billable Trait
```php
use Laravel\Cashier\Billable;

class Tenant extends Model
{
    use Billable;
}
```

### Customer Creation on Registration
```php
// In tenant creation logic
$tenant->createAsStripeCustomer([
    'name' => $tenant->name,
    'email' => $tenant->owner->email,
]);
```
