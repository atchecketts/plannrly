# Feature 29.3: Bulk Operations

**Status:** Not Started
**Effort:** Large
**Phase:** 29 - Employee Lifecycle & Bulk Operations

## Overview

Efficient management of large-scale actions across entities. Provides bulk operations for shifts, employees, and approvals to save time when managing larger teams and schedules.

## Requirements

### Functional Requirements

#### Bulk Shift Operations
- Bulk create shifts from template
- Bulk assign/unassign employees to shifts
- Bulk publish/unpublish shifts
- Bulk delete shifts
- Copy week to another week
- Apply template to date range

#### Bulk Employee Operations
- Bulk update employee details (role, department)
- Bulk role assignment
- Bulk deactivation for offboarding
- Bulk reactivation
- CSV export of employee data

#### Bulk Approval Operations
- Bulk approve leave requests
- Bulk approve timesheets
- Bulk reject with reason

#### UI Components
- Select all / select visible
- Selection counter
- Action bar appears on selection
- Confirmation for destructive actions
- Progress indicator for long operations

### Authorization
- Admins can perform all bulk operations
- Managers can bulk manage their department
- All bulk operations logged for audit

## Files

### To Create
- `app/Services/BulkOperationsService.php`
- `app/Services/BulkShiftService.php`
- `app/Services/BulkEmployeeService.php`
- `app/Http/Controllers/BulkShiftController.php`
- `app/Http/Controllers/BulkEmployeeController.php`
- `app/Http/Controllers/BulkApprovalController.php`
- `app/Http/Requests/BulkShiftRequest.php`
- `app/Http/Requests/BulkEmployeeRequest.php`
- `app/Http/Requests/BulkApprovalRequest.php`
- `app/Jobs/ProcessBulkOperation.php`
- `app/Data/BulkOperationResult.php`
- `app/Exports/EmployeesExport.php`
- `resources/views/components/bulk-action-bar.blade.php`
- `resources/views/components/bulk-selection.blade.php`
- `resources/views/components/bulk-confirmation-modal.blade.php`
- `tests/Feature/BulkOperationsTest.php`
- `tests/Feature/BulkShiftTest.php`
- `tests/Feature/BulkEmployeeTest.php`

### Routes
```php
// Bulk shift routes
Route::post('shifts/bulk/assign', [BulkShiftController::class, 'assign'])->name('shifts.bulk.assign');
Route::post('shifts/bulk/unassign', [BulkShiftController::class, 'unassign'])->name('shifts.bulk.unassign');
Route::post('shifts/bulk/publish', [BulkShiftController::class, 'publish'])->name('shifts.bulk.publish');
Route::post('shifts/bulk/unpublish', [BulkShiftController::class, 'unpublish'])->name('shifts.bulk.unpublish');
Route::post('shifts/bulk/delete', [BulkShiftController::class, 'delete'])->name('shifts.bulk.delete');
Route::post('shifts/bulk/copy-week', [BulkShiftController::class, 'copyWeek'])->name('shifts.bulk.copy-week');
Route::post('shifts/bulk/from-template', [BulkShiftController::class, 'fromTemplate'])->name('shifts.bulk.from-template');

// Bulk employee routes
Route::post('employees/bulk/update', [BulkEmployeeController::class, 'update'])->name('employees.bulk.update');
Route::post('employees/bulk/assign-role', [BulkEmployeeController::class, 'assignRole'])->name('employees.bulk.assign-role');
Route::post('employees/bulk/deactivate', [BulkEmployeeController::class, 'deactivate'])->name('employees.bulk.deactivate');
Route::post('employees/bulk/reactivate', [BulkEmployeeController::class, 'reactivate'])->name('employees.bulk.reactivate');
Route::get('employees/export', [BulkEmployeeController::class, 'export'])->name('employees.export');

// Bulk approval routes
Route::post('approvals/bulk/approve', [BulkApprovalController::class, 'approve'])->name('approvals.bulk.approve');
Route::post('approvals/bulk/reject', [BulkApprovalController::class, 'reject'])->name('approvals.bulk.reject');
```

## Tasks

- [ ] Create BulkOperationsService base class
- [ ] Create BulkShiftService for shift operations
- [ ] Create BulkEmployeeService for employee operations
- [ ] Implement bulk shift creation from template
- [ ] Add bulk assign/unassign employees to shifts
- [ ] Create bulk publish/unpublish functionality
- [ ] Implement bulk delete with confirmation
- [ ] Build copy week to another week
- [ ] Add bulk employee update capabilities
- [ ] Implement bulk role assignment
- [ ] Create bulk deactivation for offboarding
- [ ] Add bulk leave/timesheet approval
- [ ] Implement CSV export for employees
- [ ] Create BulkOperationResult tracking class
- [ ] Create ProcessBulkOperation job for async operations
- [ ] Build bulk-action-bar component
- [ ] Write comprehensive tests

## BulkOperationResult

```php
class BulkOperationResult
{
    public function __construct(
        public string $operation,
        public int $total,
        public int $successful,
        public int $failed,
        public array $errors = [],
        public array $warnings = [],
    ) {}

    public function isFullySuccessful(): bool
    {
        return $this->failed === 0;
    }

    public function hasPartialSuccess(): bool
    {
        return $this->successful > 0 && $this->failed > 0;
    }

    public function toArray(): array
    {
        return [
            'operation' => $this->operation,
            'total' => $this->total,
            'successful' => $this->successful,
            'failed' => $this->failed,
            'errors' => $this->errors,
            'warnings' => $this->warnings,
        ];
    }
}
```

## BulkShiftService

```php
class BulkShiftService
{
    public function assignEmployees(array $shiftIds, int $employeeId): BulkOperationResult
    {
        $total = count($shiftIds);
        $successful = 0;
        $errors = [];

        foreach ($shiftIds as $shiftId) {
            try {
                $shift = Shift::findOrFail($shiftId);
                $shift->update(['user_id' => $employeeId]);
                $successful++;
            } catch (\Exception $e) {
                $errors[] = "Shift {$shiftId}: {$e->getMessage()}";
            }
        }

        return new BulkOperationResult(
            operation: 'assign_employees',
            total: $total,
            successful: $successful,
            failed: $total - $successful,
            errors: $errors,
        );
    }

    public function copyWeek(Carbon $sourceWeek, Carbon $targetWeek): BulkOperationResult
    {
        $shifts = Shift::whereBetween('date', [
            $sourceWeek->startOfWeek(),
            $sourceWeek->endOfWeek(),
        ])->get();

        $daysDiff = $sourceWeek->diffInDays($targetWeek);
        $created = 0;
        $errors = [];

        foreach ($shifts as $shift) {
            try {
                $newShift = $shift->replicate();
                $newShift->date = $shift->date->addDays($daysDiff);
                $newShift->save();
                $created++;
            } catch (\Exception $e) {
                $errors[] = "Shift {$shift->id}: {$e->getMessage()}";
            }
        }

        return new BulkOperationResult(
            operation: 'copy_week',
            total: $shifts->count(),
            successful: $created,
            failed: $shifts->count() - $created,
            errors: $errors,
        );
    }
}
```

## Bulk Action Bar Component

```blade
<div x-data="bulkActions" x-show="selectedCount > 0" class="fixed bottom-0 left-0 right-0 bg-white shadow-lg p-4">
    <div class="flex items-center justify-between max-w-7xl mx-auto">
        <span x-text="selectedCount + ' items selected'"></span>
        <div class="flex gap-2">
            {{ $slot }}
            <button @click="clearSelection" class="btn btn-secondary">Cancel</button>
        </div>
    </div>
</div>
```

## Tests

Expected tests in `tests/Feature/BulkOperationsTest.php`:

1. `test_admin_can_bulk_assign_shifts`
2. `test_admin_can_bulk_unassign_shifts`
3. `test_admin_can_bulk_publish_shifts`
4. `test_admin_can_bulk_delete_shifts`
5. `test_copy_week_duplicates_all_shifts`
6. `test_bulk_create_from_template`
7. `test_admin_can_bulk_update_employees`
8. `test_admin_can_bulk_assign_roles`
9. `test_admin_can_bulk_deactivate_employees`
10. `test_admin_can_bulk_approve_leave`
11. `test_bulk_operation_returns_result_summary`
12. `test_partial_failure_reports_errors`
13. `test_employee_export_generates_csv`
14. `test_manager_can_only_bulk_manage_department`

## Dependencies

- Shift model
- User model
- LeaveRequest model
- Timesheet model
- Laravel Excel for CSV export
- Alpine.js for bulk selection UI
