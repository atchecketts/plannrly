# Feature 12.8: Ad-Hoc Invoice Management

**Status:** Not Started
**Effort:** Large
**Phase:** 12 - Stripe Payment Integration

## Overview

Create manual invoices with sequential numbering for regulatory compliance. This feature enables SuperAdmins to create ad-hoc invoices for custom billing scenarios, separate from Stripe's automatic subscription invoices.

## Requirements

### Functional Requirements
- Create invoices with line items
- Sequential invoice numbering (2026-001 format)
- Invoice status management (draft, sent, paid, etc.)
- PDF invoice generation
- Send invoice via email
- Record manual payments
- Credit note creation
- Invoice void with reason

### Business Rules
- Invoice numbers are sequential per year
- Numbers cannot be reused or skipped
- Platform company details on all invoices
- Support for partial payments
- Audit trail for all invoice actions

## Platform Company Details

```
Company: Checketts Propiedad SL
Tax ID: ESB42691550
Address: Calle Francisco Salzillo 9, Orihuela Costa, Alicante, 03189, Spain
```

## Environment Variables

```env
BILLING_COMPANY_NAME="Checketts Propiedad SL"
BILLING_TAX_ID="ESB42691550"
BILLING_ADDRESS_LINE1="Calle Francisco Salzillo 9"
BILLING_CITY="Orihuela Costa"
BILLING_STATE="Alicante"
BILLING_POSTAL_CODE="03189"
BILLING_COUNTRY="Spain"
BILLING_COUNTRY_CODE="ES"
BILLING_DEFAULT_CURRENCY="EUR"
BILLING_DEFAULT_TAX_RATE="21.00"
```

## Database Changes

```php
Schema::create('invoice_number_sequences', function (Blueprint $table) {
    $table->id();
    $table->integer('year');
    $table->string('type')->default('invoice');
    $table->string('prefix')->nullable();
    $table->integer('last_number')->default(0);
    $table->timestamps();
    $table->unique(['year', 'type', 'prefix']);
});

Schema::create('invoices', function (Blueprint $table) {
    $table->id();
    $table->foreignId('tenant_id')->constrained()->cascadeOnDelete();
    $table->string('invoice_number')->unique();
    $table->string('type')->default('invoice');
    $table->string('status');
    $table->foreignId('customer_tenant_id')->nullable()->constrained('tenants');
    $table->string('customer_name');
    $table->string('customer_email');
    $table->text('customer_address')->nullable();
    $table->string('customer_tax_id')->nullable();
    $table->date('issue_date');
    $table->date('due_date');
    $table->string('currency', 3)->default('USD');
    $table->decimal('subtotal', 12, 2);
    $table->decimal('tax_amount', 12, 2)->default(0);
    $table->decimal('discount_amount', 12, 2)->default(0);
    $table->decimal('total', 12, 2);
    $table->decimal('amount_paid', 12, 2)->default(0);
    $table->decimal('amount_due', 12, 2);
    $table->decimal('tax_rate', 5, 2)->default(0);
    $table->text('notes')->nullable();
    $table->text('terms')->nullable();
    $table->string('reference')->nullable();
    $table->timestamp('sent_at')->nullable();
    $table->timestamp('paid_at')->nullable();
    $table->timestamps();
    $table->softDeletes();
});

Schema::create('invoice_items', function (Blueprint $table) {
    $table->id();
    $table->foreignId('invoice_id')->constrained()->cascadeOnDelete();
    $table->string('description');
    $table->decimal('quantity', 10, 2);
    $table->string('unit')->default('unit');
    $table->decimal('unit_price', 12, 2);
    $table->decimal('tax_rate', 5, 2)->default(0);
    $table->decimal('tax_amount', 12, 2)->default(0);
    $table->decimal('discount_percent', 5, 2)->default(0);
    $table->decimal('discount_amount', 12, 2)->default(0);
    $table->decimal('line_total', 12, 2);
    $table->integer('sort_order')->default(0);
    $table->timestamps();
});

Schema::create('invoice_payments', function (Blueprint $table) {
    $table->id();
    $table->foreignId('invoice_id')->constrained()->cascadeOnDelete();
    $table->decimal('amount', 12, 2);
    $table->string('payment_method');
    $table->string('reference')->nullable();
    $table->date('payment_date');
    $table->text('notes')->nullable();
    $table->foreignId('recorded_by')->constrained('users');
    $table->timestamps();
});
```

## Files

### Created/Modified
- `config/billing.php` - Platform company details
- `app/Models/Invoice.php` - Invoice model
- `app/Models/InvoiceItem.php` - Line item model
- `app/Models/InvoicePayment.php` - Payment model
- `app/Models/InvoiceNumberSequence.php` - Sequence model
- `app/Services/InvoiceService.php` - Invoice operations
- `app/Services/InvoiceNumberGenerator.php` - Number generation
- `app/Http/Controllers/SuperAdmin/InvoiceController.php` - Controller
- `app/Http/Requests/InvoiceRequest.php` - Validation
- `resources/views/super-admin/invoices/index.blade.php` - List view
- `resources/views/super-admin/invoices/create.blade.php` - Create form
- `resources/views/super-admin/invoices/show.blade.php` - Detail view
- `resources/views/super-admin/invoices/edit.blade.php` - Edit form
- `resources/views/super-admin/invoices/pdf.blade.php` - PDF template

### Routes
```php
Route::middleware(['auth', 'super-admin'])->prefix('super-admin/invoices')->group(function () {
    Route::get('/', [InvoiceController::class, 'index'])->name('super-admin.invoices.index');
    Route::get('/create', [InvoiceController::class, 'create'])->name('super-admin.invoices.create');
    Route::post('/', [InvoiceController::class, 'store'])->name('super-admin.invoices.store');
    Route::get('/{invoice}', [InvoiceController::class, 'show'])->name('super-admin.invoices.show');
    Route::get('/{invoice}/edit', [InvoiceController::class, 'edit'])->name('super-admin.invoices.edit');
    Route::put('/{invoice}', [InvoiceController::class, 'update'])->name('super-admin.invoices.update');
    Route::get('/{invoice}/pdf', [InvoiceController::class, 'pdf'])->name('super-admin.invoices.pdf');
    Route::post('/{invoice}/send', [InvoiceController::class, 'send'])->name('super-admin.invoices.send');
    Route::post('/{invoice}/payment', [InvoiceController::class, 'recordPayment'])->name('super-admin.invoices.payment');
    Route::post('/{invoice}/void', [InvoiceController::class, 'void'])->name('super-admin.invoices.void');
    Route::post('/{invoice}/credit-note', [InvoiceController::class, 'creditNote'])->name('super-admin.invoices.credit-note');
});
```

## Tasks

- [ ] Create `config/billing.php` with platform company details
- [ ] Add billing environment variables to `.env.example`
- [ ] Create migrations for invoice tables
- [ ] Create Invoice model with relationships and scopes
- [ ] Create InvoiceItem model
- [ ] Create InvoicePayment model
- [ ] Create InvoiceNumberSequence model
- [ ] Create InvoiceNumberGenerator service with locking
- [ ] Create InvoiceService for invoice operations
- [ ] Create InvoiceController with CRUD
- [ ] Create InvoiceRequest with validation
- [ ] Create invoice list view with filtering
- [ ] Create invoice create/edit form with line items
- [ ] Implement dynamic line item addition (Alpine.js)
- [ ] Auto-calculate subtotal, tax, and total
- [ ] Create invoice detail view
- [ ] Create PDF invoice template with platform company details
- [ ] Include company name, tax ID, and address from config
- [ ] Implement invoice PDF generation (DomPDF)
- [ ] Implement send invoice via email
- [ ] Implement record payment functionality
- [ ] Create payment recording form
- [ ] Implement invoice status transitions
- [ ] Implement credit note creation (linked to original invoice)
- [ ] Implement invoice void (with reason)
- [ ] Create overdue invoice report
- [ ] Add invoice search and filtering
- [ ] Write comprehensive feature tests

## Tests

Tests to be created in `tests/Feature/AdHocInvoiceTest.php`:

1. `test_invoice_list_loads`
2. `test_invoice_can_be_created`
3. `test_invoice_number_sequential`
4. `test_invoice_number_unique`
5. `test_line_items_calculated_correctly`
6. `test_invoice_can_be_sent`
7. `test_payment_can_be_recorded`
8. `test_partial_payment_updates_amount_due`
9. `test_full_payment_marks_paid`
10. `test_invoice_can_be_voided`
11. `test_credit_note_created`
12. `test_pdf_generates_correctly`
13. `test_platform_details_on_invoice`

## Dependencies

- DomPDF for PDF generation
- Tenant model
- User model

## Notes

### Invoice Number Generator
```php
class InvoiceNumberGenerator
{
    public function getNext(int $year = null, string $type = 'invoice'): string
    {
        $year = $year ?? now()->year;

        return DB::transaction(function () use ($year, $type) {
            $sequence = InvoiceNumberSequence::lockForUpdate()
                ->firstOrCreate(
                    ['year' => $year, 'type' => $type, 'prefix' => null],
                    ['last_number' => 0]
                );

            $sequence->increment('last_number');
            $number = str_pad($sequence->last_number, 3, '0', STR_PAD_LEFT);

            return "{$year}-{$number}";
        });
    }
}
```

### Invoice Statuses
```php
enum InvoiceStatus: string
{
    case Draft = 'draft';
    case Sent = 'sent';
    case Paid = 'paid';
    case PartiallyPaid = 'partially_paid';
    case Overdue = 'overdue';
    case Cancelled = 'cancelled';
    case Void = 'void';
}
```
