# Feature 12.7: Tenant Billing Details

**Status:** Not Started
**Effort:** Medium
**Phase:** 12 - Stripe Payment Integration

## Overview

Capture and manage tenant financial information for invoicing compliance. This feature allows tenants to provide their billing details including legal name, tax ID, and address for proper invoice generation.

## Requirements

### Functional Requirements
- Billing details form
- Legal name and company registration
- Tax ID with type (VAT, GST, TIN, etc.)
- Billing address
- Tax exempt status with certificate
- Currency and payment terms
- Invoice notes

### Business Rules
- Tax ID validated by format per country
- Billing details required before invoice generation
- Pre-populate from Stripe customer data if available

## Database Changes

```php
Schema::create('tenant_billing_details', function (Blueprint $table) {
    $table->id();
    $table->foreignId('tenant_id')->constrained()->cascadeOnDelete();
    $table->string('legal_name');
    $table->string('tax_id')->nullable(); // VAT/GST/TIN number
    $table->string('tax_id_type')->nullable(); // VAT, GST, TIN, etc.
    $table->string('company_registration_number')->nullable();
    $table->string('billing_email');
    $table->string('billing_phone')->nullable();
    $table->text('billing_address_line_1');
    $table->text('billing_address_line_2')->nullable();
    $table->string('billing_city');
    $table->string('billing_state')->nullable();
    $table->string('billing_postal_code');
    $table->string('billing_country', 2); // ISO country code
    $table->decimal('default_tax_rate', 5, 2)->default(0);
    $table->boolean('is_tax_exempt')->default(false);
    $table->string('tax_exempt_certificate')->nullable();
    $table->string('currency', 3)->default('USD');
    $table->string('payment_terms')->default('net_30');
    $table->text('invoice_notes')->nullable();
    $table->timestamps();
});
```

## Files

### Created/Modified
- `app/Models/TenantBillingDetail.php` - Billing details model
- `app/Http/Controllers/TenantBillingController.php` - Controller
- `app/Http/Requests/TenantBillingRequest.php` - Validation
- `resources/views/settings/billing-details.blade.php` - Form view

### Routes
```php
Route::middleware('auth')->prefix('settings')->group(function () {
    Route::get('/billing-details', [TenantBillingController::class, 'edit'])
        ->name('settings.billing-details');
    Route::put('/billing-details', [TenantBillingController::class, 'update'])
        ->name('settings.billing-details.update');
});
```

## Tasks

- [ ] Create migration for tenant_billing_details table
- [ ] Create TenantBillingDetail model with Tenant relationship
- [ ] Create TenantBillingRequest with validation rules
- [ ] Create TenantBillingController with CRUD operations
- [ ] Create billing details form view
- [ ] Add tax ID validation (format per country)
- [ ] Support multiple tax ID types (VAT, GST, TIN, etc.)
- [ ] Add billing details to tenant settings navigation
- [ ] Pre-populate from Stripe customer data if available
- [ ] Write feature tests

## Tests

Tests to be created in `tests/Feature/TenantBillingDetailsTest.php`:

1. `test_billing_details_page_loads`
2. `test_billing_details_can_be_saved`
3. `test_billing_details_validation`
4. `test_tax_id_format_validated`
5. `test_pre_populated_from_stripe`
6. `test_tax_exempt_requires_certificate`
7. `test_billing_details_required_for_invoices`

## Dependencies

- Feature 12.1: Stripe Setup & Customer Management
- Tenant model

## Notes

### Tax ID Types
```php
enum TaxIdType: string
{
    case VAT = 'vat';      // EU VAT
    case GST = 'gst';      // Australia, India, etc.
    case TIN = 'tin';      // US Tax Identification
    case ABN = 'abn';      // Australia Business Number
    case GSTIN = 'gstin';  // India GST
    case Other = 'other';
}
```

### VAT Format Validation
```php
public function validateVatNumber(string $country, string $number): bool
{
    $patterns = [
        'ES' => '/^ES[A-Z0-9]\d{7}[A-Z0-9]$/',
        'GB' => '/^GB\d{9}$|^GB\d{12}$/',
        'DE' => '/^DE\d{9}$/',
        'FR' => '/^FR[A-Z0-9]{2}\d{9}$/',
        // ... more countries
    ];

    if (!isset($patterns[$country])) {
        return true; // Allow if no pattern defined
    }

    return preg_match($patterns[$country], strtoupper($number));
}
```

### Pre-populate from Stripe
```php
public function edit(Request $request)
{
    $tenant = $request->user()->tenant;
    $billingDetails = $tenant->billingDetails;

    if (!$billingDetails && $tenant->hasStripeId()) {
        $customer = $tenant->asStripeCustomer();
        $billingDetails = new TenantBillingDetail([
            'legal_name' => $customer->name,
            'billing_email' => $customer->email,
            'billing_address_line_1' => $customer->address?->line1,
            'billing_city' => $customer->address?->city,
            // ...
        ]);
    }

    return view('settings.billing-details', compact('billingDetails'));
}
```
