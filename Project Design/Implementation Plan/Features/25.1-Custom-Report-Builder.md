# Feature 25.1: Custom Report Builder

**Status:** Not Started
**Effort:** Large
**Phase:** 25 - Custom Reports

## Overview

Drag-and-drop report creation for managers. Allows users to build custom reports by selecting data sources, columns, filters, groupings, and visualizations without writing code.

## Requirements

### Functional Requirements
- Managers can create custom reports using a visual builder
- Reports can include multiple data sources (employees, shifts, timesheets, leave)
- Drag-and-drop column selection from available fields
- Filter builder with multiple conditions (AND/OR logic)
- Grouping and aggregation options (SUM, AVG, COUNT, MIN, MAX)
- Multiple visualization types (table, bar chart, line chart, pie chart)
- Reports can be saved and reused
- Reports can be exported to PDF and Excel formats
- Scheduled report delivery via email

### Data Sources
- Employees (name, role, department, start date, status)
- Shifts (date, time, duration, status, employee)
- Timesheets (hours worked, overtime, breaks)
- Leave requests (type, duration, status)
- Attendance (clock in/out, late arrivals)

### Authorization
- Only Admins and Managers can access the report builder
- Reports are tenant-scoped
- Employees cannot view custom reports unless shared

## Database Changes

### Tables to Create

**custom_reports**
| Column | Type | Description |
|--------|------|-------------|
| id | bigint | Primary key |
| tenant_id | bigint | Foreign key to tenants |
| user_id | bigint | Creator of the report |
| name | string | Report name |
| description | text | Optional description |
| config | json | Report configuration (columns, filters, etc.) |
| visualization | string | Chart type or table |
| is_scheduled | boolean | Whether report is scheduled |
| schedule_frequency | string | daily/weekly/monthly |
| schedule_recipients | json | Email addresses for delivery |
| last_run_at | timestamp | Last execution time |
| created_at | timestamp | |
| updated_at | timestamp | |

**report_executions**
| Column | Type | Description |
|--------|------|-------------|
| id | bigint | Primary key |
| custom_report_id | bigint | Foreign key to custom_reports |
| executed_by | bigint | User who ran the report |
| parameters | json | Runtime parameters |
| result_summary | json | Summary of results |
| row_count | integer | Number of rows returned |
| execution_time_ms | integer | How long it took to run |
| created_at | timestamp | |

## Files

### To Create
- `app/Models/CustomReport.php`
- `app/Models/ReportExecution.php`
- `app/Services/ReportBuilderService.php`
- `app/Services/ReportDataSourceService.php`
- `app/Http/Controllers/CustomReportController.php`
- `app/Http/Controllers/ReportExecutionController.php`
- `app/Http/Requests/CustomReport/StoreCustomReportRequest.php`
- `app/Http/Requests/CustomReport/UpdateCustomReportRequest.php`
- `app/Policies/CustomReportPolicy.php`
- `app/Console/Commands/SendScheduledReports.php`
- `app/Mail/ScheduledReportMail.php`
- `app/Exports/CustomReportExport.php`
- `resources/views/reports/builder/index.blade.php`
- `resources/views/reports/builder/create.blade.php`
- `resources/views/reports/builder/edit.blade.php`
- `resources/views/reports/builder/view.blade.php`
- `resources/views/reports/builder/components/column-selector.blade.php`
- `resources/views/reports/builder/components/filter-builder.blade.php`
- `resources/views/reports/builder/components/visualization-preview.blade.php`
- `database/migrations/xxxx_create_custom_reports_table.php`
- `database/migrations/xxxx_create_report_executions_table.php`
- `tests/Feature/CustomReportTest.php`
- `tests/Feature/ReportBuilderTest.php`

### Routes
```php
Route::resource('reports/custom', CustomReportController::class);
Route::post('reports/custom/{report}/run', [CustomReportController::class, 'run'])->name('reports.custom.run');
Route::post('reports/custom/{report}/export/pdf', [CustomReportController::class, 'exportPdf'])->name('reports.custom.export.pdf');
Route::post('reports/custom/{report}/export/excel', [CustomReportController::class, 'exportExcel'])->name('reports.custom.export.excel');
Route::post('reports/custom/{report}/schedule', [CustomReportController::class, 'schedule'])->name('reports.custom.schedule');
Route::get('reports/custom/{report}/executions', [ReportExecutionController::class, 'index'])->name('reports.custom.executions');
```

## Tasks

- [ ] Create database migrations for custom_reports and report_executions tables
- [ ] Create CustomReport model with JSON config storage
- [ ] Create ReportExecution model
- [ ] Create ReportBuilderService for query building from config
- [ ] Create ReportDataSourceService for available fields per data source
- [ ] Build drag-and-drop column selector UI component
- [ ] Implement filter builder with conditions (equals, contains, greater than, etc.)
- [ ] Add grouping and aggregation options
- [ ] Create chart visualization components (table, bar, line, pie)
- [ ] Implement PDF export using DomPDF
- [ ] Implement Excel export using Laravel Excel
- [ ] Create scheduled report command and mail class
- [ ] Register scheduled command in console routes
- [ ] Create CustomReportPolicy for authorization
- [ ] Write tests for report building and execution

## Report Configuration Schema

```json
{
  "data_source": "shifts",
  "columns": [
    {"field": "employee.name", "label": "Employee"},
    {"field": "date", "label": "Date"},
    {"field": "duration", "label": "Hours", "aggregate": "sum"}
  ],
  "filters": [
    {"field": "date", "operator": ">=", "value": "2024-01-01"},
    {"field": "status", "operator": "=", "value": "completed"}
  ],
  "group_by": ["employee.name"],
  "order_by": [{"field": "duration", "direction": "desc"}]
}
```

## Tests

Expected tests in `tests/Feature/CustomReportTest.php`:

1. `test_admin_can_view_custom_reports_index`
2. `test_employee_cannot_view_custom_reports_index`
3. `test_admin_can_create_custom_report`
4. `test_report_requires_name_and_config`
5. `test_admin_can_update_custom_report`
6. `test_admin_can_delete_custom_report`
7. `test_admin_can_run_custom_report`
8. `test_report_execution_is_recorded`
9. `test_admin_can_export_report_to_pdf`
10. `test_admin_can_export_report_to_excel`
11. `test_admin_can_schedule_report`
12. `test_scheduled_report_sends_email`
13. `test_admin_cannot_view_another_tenant_report`

## Dependencies

- Tenant model
- User model with role system
- DomPDF package for PDF export
- Laravel Excel package for Excel export
- Chart.js or similar for visualizations
