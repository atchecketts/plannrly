# Feature 21.2: Per-Employee Pricing

**Status:** Not Started
**Effort:** Medium
**Phase:** 21 - Business Model

## Overview

Usage-based pricing component that charges based on active employees per billing period. This ensures fair pricing for businesses of all sizes while providing predictable revenue based on actual usage.

## Requirements

### Active Employee Definition
An employee is considered "active" if during the billing period they:
- Were scheduled for at least one shift, OR
- Clocked in at least once, OR
- Had approved leave

### Pricing Model
- Base subscription fee (per tier)
- Plus per-active-employee fee
- Calculated monthly, charged at period end
- Prorated for mid-cycle changes

### Functional Requirements
- Track active employees per billing period
- Calculate monthly usage for billing
- Integrate with Stripe metered billing
- Display usage in billing dashboard
- Send usage reports to tenants
- Historical usage data retention

## Files

### To Create
- `app/Models/EmployeeUsage.php`
- `app/Services/UsageTrackingService.php`
- `app/Services/UsageCalculationService.php`
- `app/Console/Commands/CalculateMonthlyUsage.php`
- `app/Http/Controllers/BillingUsageController.php`
- `app/Notifications/MonthlyUsageReportNotification.php`
- `resources/views/billing/usage.blade.php`
- `database/migrations/xxxx_create_employee_usage_table.php`
- `tests/Feature/PerEmployeePricingTest.php`

### Routes
```php
Route::get('billing/usage', [BillingUsageController::class, 'index'])->name('billing.usage');
Route::get('billing/usage/{period}', [BillingUsageController::class, 'period'])->name('billing.usage.period');
```

## Database Schema

### employee_usage
| Column | Type | Description |
|--------|------|-------------|
| id | bigint | Primary key |
| tenant_id | bigint | Foreign key to tenants |
| user_id | bigint | Foreign key to users (employee) |
| billing_period | string | YYYY-MM format |
| was_scheduled | boolean | Had scheduled shifts |
| was_clocked_in | boolean | Clocked in at least once |
| had_leave | boolean | Had approved leave |
| is_active | boolean | Computed: any of above true |
| shifts_count | integer | Number of shifts |
| hours_worked | decimal | Total hours worked |
| created_at | timestamp | |
| updated_at | timestamp | |

### Usage Aggregation (denormalized for reporting)
| Column | Type | Description |
|--------|------|-------------|
| tenant_id | bigint | Foreign key |
| billing_period | string | YYYY-MM format |
| active_employees | integer | Count of active employees |
| total_shifts | integer | Total shifts created |
| total_hours | decimal | Total hours tracked |
| per_employee_rate | decimal | Rate charged per employee |
| usage_amount | decimal | Calculated usage charge |

## Stripe Integration

### Metered Billing Setup
```php
// Report usage to Stripe at end of billing period
$stripe->subscriptionItems->createUsageRecord(
    $subscriptionItemId,
    [
        'quantity' => $activeEmployeeCount,
        'timestamp' => $periodEnd,
        'action' => 'set',
    ]
);
```

### Usage Dashboard Data
- Current period active employees
- Projected charge
- Historical usage chart
- Per-employee breakdown

## Tasks

- [ ] Create employee_usage migration
- [ ] Create EmployeeUsage model
- [ ] Create UsageTrackingService
  - [ ] Track scheduled employees
  - [ ] Track clocked-in employees
  - [ ] Track employees with leave
- [ ] Create UsageCalculationService
- [ ] Create CalculateMonthlyUsage command
- [ ] Schedule command for end of billing period
- [ ] Integrate with Stripe metered billing
- [ ] Create billing usage dashboard
- [ ] Show current usage and projection
- [ ] Create MonthlyUsageReportNotification
- [ ] Send usage reports to tenants
- [ ] Write comprehensive tests

## Tests

Planned tests for `tests/Feature/PerEmployeePricingTest.php`:

1. `test_scheduled_employee_marked_as_active`
2. `test_clocked_in_employee_marked_as_active`
3. `test_employee_with_leave_marked_as_active`
4. `test_inactive_employee_not_charged`
5. `test_employee_active_only_once_per_period`
6. `test_monthly_usage_calculation`
7. `test_usage_reported_to_stripe`
8. `test_usage_dashboard_shows_current_period`
9. `test_usage_dashboard_shows_projection`
10. `test_usage_report_sent_to_admin`
11. `test_historical_usage_retained`
12. `test_different_tenants_separate_usage`

## Dependencies

- Subscription/billing system
- Stripe integration
- Shift model
- TimeEntry model (clock in/out)
- LeaveRequest model
- User/Employee model
- Scheduled task system
