# Feature 28.3: Tenant Branding

**Status:** Not Started
**Effort:** Medium
**Phase:** 28 - Workflows & Visibility

## Overview

Tiered branding customization allowing tenants to customize the application's appearance based on their subscription tier. Features range from basic logo upload for all tiers to full white-label options for enterprise customers.

## Requirements

### Functional Requirements

#### All Tiers
- Upload company logo
- Logo displayed in header and login page
- Logo used in email communications

#### Professional Tier and Above
- Primary and secondary color customization
- Accent color for buttons and highlights
- Colors applied throughout the application

#### Enterprise Tier Only
- Custom domain support (e.g., schedule.company.com)
- White-label option (remove Plannrly branding)
- Custom email sender name
- Custom favicon

### Branding Elements
| Element | Free | Professional | Enterprise |
|---------|------|--------------|------------|
| Company logo | Yes | Yes | Yes |
| Color scheme | No | Yes | Yes |
| Custom favicon | No | No | Yes |
| Custom domain | No | No | Yes |
| White-label | No | No | Yes |
| Custom email sender | No | No | Yes |

### Authorization
- Only Admins can manage branding settings
- Branding changes apply to all tenant users

## Database Changes

### Tables to Create

**tenant_branding**
| Column | Type | Description |
|--------|------|-------------|
| id | bigint | Primary key |
| tenant_id | bigint | Foreign key to tenants |
| logo_path | string | Path to uploaded logo |
| favicon_path | string | Path to favicon (Enterprise) |
| primary_color | string | Hex color code |
| secondary_color | string | Hex color code |
| accent_color | string | Hex color code |
| custom_domain | string | Custom domain (Enterprise) |
| is_white_label | boolean | Remove Plannrly branding |
| email_sender_name | string | Custom sender name |
| created_at | timestamp | |
| updated_at | timestamp | |

## Files

### To Create
- `app/Models/TenantBranding.php`
- `app/Services/BrandingService.php`
- `app/Services/CustomDomainService.php`
- `app/Http/Controllers/BrandingController.php`
- `app/Http/Requests/Branding/UpdateBrandingRequest.php`
- `app/Http/Middleware/ApplyTenantBranding.php`
- `app/Providers/BrandingServiceProvider.php`
- `resources/views/settings/branding.blade.php`
- `resources/views/components/branding-preview.blade.php`
- `database/migrations/xxxx_create_tenant_branding_table.php`
- `tests/Feature/BrandingTest.php`

### Routes
```php
Route::get('settings/branding', [BrandingController::class, 'edit'])->name('settings.branding');
Route::put('settings/branding', [BrandingController::class, 'update'])->name('settings.branding.update');
Route::post('settings/branding/logo', [BrandingController::class, 'uploadLogo'])->name('settings.branding.logo');
Route::delete('settings/branding/logo', [BrandingController::class, 'removeLogo'])->name('settings.branding.logo.delete');
Route::post('settings/branding/favicon', [BrandingController::class, 'uploadFavicon'])->name('settings.branding.favicon');
Route::post('settings/branding/verify-domain', [BrandingController::class, 'verifyDomain'])->name('settings.branding.verify-domain');
```

## Tasks

- [ ] Create database migration for tenant_branding table
- [ ] Create TenantBranding model with tier restrictions
- [ ] Create BrandingService for applying branding
- [ ] Create CustomDomainService for domain verification
- [ ] Create ApplyTenantBranding middleware
- [ ] Implement logo upload with image processing
- [ ] Add color customization (Professional+)
- [ ] Implement CSS variable injection for colors
- [ ] Add custom domain support (Enterprise)
- [ ] Implement domain verification (DNS check)
- [ ] Add white-label option (Enterprise)
- [ ] Create favicon upload (Enterprise)
- [ ] Build branding preview component
- [ ] Create BrandingServiceProvider for boot-time setup
- [ ] Write tests for tier restrictions

## BrandingService

```php
class BrandingService
{
    public function getLogoUrl(Tenant $tenant): ?string
    {
        return $tenant->branding?->logo_path
            ? Storage::url($tenant->branding->logo_path)
            : null;
    }

    public function getCssVariables(Tenant $tenant): array
    {
        $branding = $tenant->branding;

        if (!$branding || !$tenant->canAccessFeature('branding_colors')) {
            return [];
        }

        return [
            '--color-primary' => $branding->primary_color,
            '--color-secondary' => $branding->secondary_color,
            '--color-accent' => $branding->accent_color,
        ];
    }

    public function isWhiteLabel(Tenant $tenant): bool
    {
        return $tenant->branding?->is_white_label
            && $tenant->canAccessFeature('white_label');
    }
}
```

## CSS Variable Injection

```blade
@if($brandingCss)
<style>
    :root {
        {{ $brandingCss }}
    }
</style>
@endif
```

## Custom Domain Verification

For custom domains, tenants must add a DNS CNAME or TXT record:

1. CNAME: `schedule.company.com` -> `custom.plannrly.com`
2. TXT: `_plannrly-verify.company.com` -> `verify=tenant_uuid`

## Tests

Expected tests in `tests/Feature/BrandingTest.php`:

1. `test_admin_can_view_branding_settings`
2. `test_employee_cannot_access_branding_settings`
3. `test_any_tier_can_upload_logo`
4. `test_logo_dimensions_are_validated`
5. `test_free_tier_cannot_set_colors`
6. `test_professional_tier_can_set_colors`
7. `test_enterprise_can_enable_white_label`
8. `test_enterprise_can_set_custom_domain`
9. `test_domain_verification_checks_dns`
10. `test_branding_applied_via_middleware`
11. `test_css_variables_generated_correctly`
12. `test_white_label_hides_plannrly_branding`

## Dependencies

- Tenant model with subscription tier
- Storage for logo/favicon files
- Image processing (Intervention Image or similar)
- DNS lookup for domain verification
