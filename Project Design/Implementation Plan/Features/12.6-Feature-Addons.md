# Feature 12.6: Feature Add-on Purchases

**Status:** Not Started
**Effort:** Medium
**Phase:** 12 - Stripe Payment Integration

## Overview

Purchase and manage premium add-ons. This feature allows customers to purchase individual premium features as add-ons to their base subscription plan.

## Requirements

### Functional Requirements
- Add-on marketplace view
- Add-on purchase flow
- Add subscription item to existing subscription
- Remove add-on from subscription
- Show active add-ons on subscription page
- Update feature gates when add-ons change

### Business Rules
- Add-ons require active base subscription
- Proration applied when adding mid-cycle
- Add-ons billed on same cycle as subscription
- Feature gates updated immediately on purchase

## Files

### Created/Modified
- `resources/views/subscription/addons.blade.php` - Add-on marketplace

### Routes
```php
Route::middleware('auth')->prefix('subscription')->group(function () {
    Route::get('/addons', [AddonController::class, 'index'])
        ->name('subscription.addons');
    Route::post('/addons/{addon}', [AddonController::class, 'purchase'])
        ->name('subscription.addons.purchase');
    Route::delete('/addons/{addon}', [AddonController::class, 'remove'])
        ->name('subscription.addons.remove');
});
```

## Tasks

- [ ] Create add-on marketplace view
- [ ] Implement add-on purchase flow
- [ ] Add subscription item to existing subscription
- [ ] Remove add-on from subscription
- [ ] Show active add-ons on subscription page
- [ ] Update feature gates when add-ons change
- [ ] Write tests

## Tests

Tests to be created in `tests/Feature/AddonPurchaseTest.php`:

1. `test_addons_page_loads`
2. `test_user_can_purchase_addon`
3. `test_addon_requires_base_subscription`
4. `test_user_can_remove_addon`
5. `test_addon_prorated_correctly`
6. `test_feature_gate_enabled_on_purchase`
7. `test_feature_gate_disabled_on_removal`
8. `test_active_addons_displayed`

## Dependencies

- Feature 12.1: Stripe Setup & Customer Management
- Feature 12.2: Checkout & Subscription Flow
- Feature 1.6: Subscription & Feature Management

## Notes

### Available Add-ons
```php
// config/stripe.php
'addons' => [
    'advanced_analytics' => [
        'price_id' => 'price_xxx',
        'name' => 'Advanced Analytics',
        'description' => 'Custom reports and analytics dashboards',
        'feature_flag' => 'advanced-analytics',
    ],
    'geofencing' => [
        'price_id' => 'price_xxx',
        'name' => 'Advanced Geofencing',
        'description' => 'Location-based clock-in verification',
        'feature_flag' => 'advanced-geofencing',
    ],
    // ...
],
```

### Purchase Implementation
```php
public function purchase(Request $request, string $addon)
{
    $tenant = $request->user()->tenant;
    $subscription = $tenant->subscription('default');

    if (!$subscription || $subscription->cancelled()) {
        return back()->withErrors(['error' => 'Active subscription required']);
    }

    $addonConfig = config("stripe.addons.{$addon}");
    $subscription->addPrice($addonConfig['price_id']);

    // Enable feature
    $tenant->enableFeature($addonConfig['feature_flag']);

    return back()->with('success', 'Add-on activated!');
}
```

### Remove Implementation
```php
public function remove(Request $request, string $addon)
{
    $tenant = $request->user()->tenant;
    $subscription = $tenant->subscription('default');

    $addonConfig = config("stripe.addons.{$addon}");
    $subscription->removePrice($addonConfig['price_id']);

    // Disable feature
    $tenant->disableFeature($addonConfig['feature_flag']);

    return back()->with('success', 'Add-on removed');
}
```

### Check Active Add-ons
```php
public function hasAddon(string $addon): bool
{
    $subscription = $this->subscription('default');
    if (!$subscription) return false;

    $addonConfig = config("stripe.addons.{$addon}");
    return $subscription->hasPrice($addonConfig['price_id']);
}
```
