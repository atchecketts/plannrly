# Feature 3.3: Scheduled vs Actual Time Variance

**Status:** Complete
**Effort:** Medium
**Phase:** 3 - Time & Attendance
**Completed:** January 2026

## Overview

Calculate and display variances between scheduled and actual times. This feature provides computed metrics that help managers identify attendance patterns such as late arrivals, early departures, overtime, and no-shows.

## Requirements

### Functional Requirements
- Calculate actual duration worked ✅
- Calculate scheduled duration from shift ✅
- Calculate variance (overtime/undertime) ✅
- Track early/late arrival ✅
- Track early/late departure ✅
- Identify overtime shifts ✅
- Identify no-show situations ✅
- Color coding for variance display ✅

## Implementation Details

### Files Modified
- `app/Models/TimeEntry.php` - Added 15 computed accessor methods
- `resources/views/time-entries/show.blade.php` - Added Time Variance card
- `resources/views/time-entries/index.blade.php` - Added Variance column header
- `resources/views/time-entries/_row.blade.php` - Added variance badges to table row

### Files Created
- `tests/Unit/Models/TimeEntryVarianceTest.php` - 17 unit tests for variance calculations

### Computed Accessors Added to TimeEntry Model

| Accessor | Type | Description |
|----------|------|-------------|
| `scheduled_duration_minutes` | int | Shift working minutes (from shift model) |
| `variance_minutes` | int | Difference: actual - scheduled (+overtime/-undertime) |
| `clock_in_variance_minutes` | int | Minutes late/early for arrival |
| `clock_out_variance_minutes` | int | Minutes stayed late/left early |
| `is_late` | bool | True if arrived after grace period |
| `is_early_departure` | bool | True if left more than 5 min early |
| `is_overtime` | bool | True if worked 15+ min overtime |
| `is_no_show` | bool | True if shift ended without clock-in |
| `clock_in_status` | array | Label and color for clock-in display |
| `clock_out_status` | array | Label and color for clock-out display |
| `variance_status` | array | Label and color for total variance |

### Helper Methods Added

| Method | Description |
|--------|-------------|
| `formatVariance(int $minutes)` | Formats minutes as "+1h 30m" or "-45m" |
| `getGracePeriodMinutes()` | Gets grace period from tenant settings (default 15) |

## Variance Color Coding

| Status | Color | Threshold |
|--------|-------|-----------|
| On Time | Green | Within grace period |
| Early Arrival | Blue | Arrived 5+ minutes early |
| Minor Late | Yellow | 1-15 minutes late |
| Late | Red | More than 15 minutes late |
| On Target (hours) | Green | Within 5 minutes of scheduled |
| Minor Undertime | Yellow | 5-30 minutes under |
| Significant Undertime | Red | 30+ minutes under |
| Minor Overtime | Yellow | 5-30 minutes over |
| Significant Overtime | Orange | 30+ minutes over |

## Tasks

- [x] Add scheduled_duration_minutes accessor
- [x] Add variance_minutes accessor
- [x] Add clock_in_variance_minutes accessor
- [x] Add clock_out_variance_minutes accessor
- [x] Add is_late boolean accessor
- [x] Add is_early_departure boolean accessor
- [x] Add is_overtime boolean accessor
- [x] Add is_no_show boolean accessor
- [x] Add clock_in_status accessor with color coding
- [x] Add clock_out_status accessor with color coding
- [x] Add variance_status accessor with color coding
- [x] Add formatVariance helper method
- [x] Add variance display to time entry show view
- [x] Add variance column to time entries list
- [x] Write unit tests (17 tests)

## Test Coverage

### TimeEntryVarianceTest.php (17 tests)
- Scheduled duration returns shift working minutes
- Clock in variance on time
- Clock in variance late arrival
- Clock in variance minor late within grace
- Clock in variance early arrival
- Clock out variance on time
- Clock out variance early departure
- Clock out variance overtime
- Total variance overtime
- Total variance undertime
- Is no show when shift passed without clock in
- Is not no show when clocked in
- Format variance positive
- Format variance negative
- Format variance zero
- Variance status color coding
- Grace period uses tenant settings

## Dependencies

- TimeEntry model
- Shift model with start_time, end_time, working_minutes
- TenantSettings for clock_in_grace_minutes configuration
