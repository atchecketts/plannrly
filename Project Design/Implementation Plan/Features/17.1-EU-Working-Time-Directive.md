# Feature 17.1: EU Working Time Directive Monitoring

**Status:** Not Started
**Effort:** Large
**Phase:** 17 - Working Time Compliance

## Overview

Monitor and warn about working time regulation violations based on the EU Working Time Directive. Helps organizations maintain compliance with legal requirements for rest periods, maximum hours, and breaks.

## Requirements

### Functional Requirements
- Monitor minimum rest between shifts (11 hours)
- Monitor maximum weekly hours (48 hours average)
- Monitor weekly rest period (24 hours per week)
- Monitor break requirements (20 min after 6 hours)
- Show warnings when creating shifts that violate rules
- Require acknowledgment for violations
- Log violation overrides with reason
- Generate compliance reports for admins
- Configure rules per tenant (enable/disable, thresholds)

### Compliance Rules
| Rule | Description | Default |
|------|-------------|---------|
| 11h rest | Minimum rest between shifts | 11 hours |
| 48h max/week | Maximum weekly hours (average) | 48 hours |
| 24h rest/week | Weekly rest period | 24 hours |
| 20min break | After 6 hours work | 20 minutes |

### UI Components
- Compliance dashboard for admins
- Violation warnings in schedule view
- Acknowledgment modal with reason
- Compliance report generation
- Rule configuration settings

## Files

### To Create
- `app/Services/WorkingTimeComplianceService.php` - Compliance checks
- `app/Models/ComplianceViolation.php` - Violation records
- `app/Http/Controllers/ComplianceController.php` - Controller
- `database/migrations/xxxx_create_compliance_violations_table.php`
- `resources/views/admin/compliance/dashboard.blade.php` - Dashboard
- `resources/views/admin/compliance/report.blade.php` - Report view
- `tests/Feature/WorkingTimeComplianceTest.php` - Feature tests

### Routes
```php
Route::prefix('admin/compliance')->group(function () {
    Route::get('/', [ComplianceController::class, 'dashboard'])->name('admin.compliance.dashboard');
    Route::get('/report', [ComplianceController::class, 'report'])->name('admin.compliance.report');
    Route::get('/settings', [ComplianceController::class, 'settings'])->name('admin.compliance.settings');
    Route::post('/settings', [ComplianceController::class, 'updateSettings'])->name('admin.compliance.settings.update');
});

// API for shift creation validation
Route::post('api/compliance/check', [ComplianceController::class, 'check'])->name('api.compliance.check');
```

## Database Schema

### compliance_violations
```php
Schema::create('compliance_violations', function (Blueprint $table) {
    $table->id();
    $table->foreignId('tenant_id')->constrained()->cascadeOnDelete();
    $table->foreignId('user_id')->constrained()->cascadeOnDelete();
    $table->foreignId('shift_id')->nullable()->constrained()->nullOnDelete();
    $table->string('rule'); // rest_period, max_weekly_hours, weekly_rest, break_requirement
    $table->string('severity'); // warning, violation
    $table->text('description');
    $table->json('details'); // Specific values that caused violation
    $table->boolean('was_overridden')->default(false);
    $table->text('override_reason')->nullable();
    $table->foreignId('overridden_by')->nullable()->constrained('users')->nullOnDelete();
    $table->timestamp('overridden_at')->nullable();
    $table->timestamps();

    $table->index(['tenant_id', 'created_at']);
    $table->index(['user_id', 'rule']);
});
```

## Compliance Checks

```php
class WorkingTimeComplianceService
{
    public function checkRestPeriod(User $user, Carbon $shiftStart): ?ComplianceViolation
    {
        $previousShift = $user->shifts()
            ->where('end_time', '<', $shiftStart)
            ->latest('end_time')
            ->first();

        if ($previousShift) {
            $restHours = $shiftStart->diffInHours($previousShift->end_time);
            if ($restHours < $this->getMinRestHours()) {
                return new ComplianceViolation(/* ... */);
            }
        }
        return null;
    }

    public function checkWeeklyHours(User $user, Carbon $weekStart): ?ComplianceViolation
    {
        $hours = $user->getScheduledHoursForWeek($weekStart);
        if ($hours > $this->getMaxWeeklyHours()) {
            return new ComplianceViolation(/* ... */);
        }
        return null;
    }

    // ... more checks
}
```

## Tasks

- [ ] Create compliance_violations migration
- [ ] Create WorkingTimeComplianceService
- [ ] Check rest period between shifts
- [ ] Check weekly hours limit
- [ ] Check weekly rest requirement
- [ ] Check break requirements
- [ ] Show warnings when creating shifts
- [ ] Require acknowledgment for violations
- [ ] Log violation overrides with reason
- [ ] Create compliance dashboard for admins
- [ ] Generate compliance reports
- [ ] Configure rules per tenant (enable/disable, thresholds)
- [ ] Write tests

## Tests

Suggested tests for `tests/Feature/WorkingTimeComplianceTest.php`:

1. `test_rest_period_violation_is_detected`
2. `test_weekly_hours_violation_is_detected`
3. `test_weekly_rest_violation_is_detected`
4. `test_break_requirement_violation_is_detected`
5. `test_warning_shown_when_creating_violating_shift`
6. `test_admin_can_override_violation`
7. `test_override_requires_reason`
8. `test_violation_is_logged`
9. `test_compliance_dashboard_shows_violations`
10. `test_compliance_report_is_generated`
11. `test_rules_can_be_configured_per_tenant`
12. `test_rules_can_be_disabled`

## Dependencies

- Shift model
- User model
- TimeEntry model (for break tracking)
- TenantSettings for configuration
