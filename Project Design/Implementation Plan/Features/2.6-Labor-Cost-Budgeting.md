# Feature 2.6: Labor Cost Budgeting

**Status:** Pending
**Effort:** Large
**Phase:** 2 - Scheduling Features

## Overview

Control labor costs with budget planning and real-time tracking on schedule views. This feature enables managers to set budgets for labor costs and track scheduled vs actual costs in real-time as shifts are created and worked.

## Requirements

### Functional Requirements
- Set weekly/bi-weekly/monthly budgets per location
- Optional budget split by department
- Threshold alerts (warning at 80%, critical at 95%, configurable)
- Real-time tracking as shifts are added
- Compare actual labor cost from time entries
- Budget indicator on week view with color coding
- View cost breakdown by role, department, employee
- Track budget performance over time with historical snapshots

### Cost Calculation Logic
```
Scheduled Cost = Sum of (shift.duration_hours x employee.hourly_rate)
- Use role-specific rate if employee has override for that role
- Apply overtime multiplier if tenant has overtime rules
- Deduct scheduled breaks from hours

Actual Cost = Sum of (time_entry.worked_hours x employee.hourly_rate)
- Calculate from clock in/out times
- Apply overtime for hours over threshold
```

## Files

### To Create
- `app/Models/LaborBudget.php`
- `app/Models/LaborBudgetSnapshot.php`
- `app/Services/LaborBudgetService.php`
- `app/Http/Controllers/LaborBudgetController.php`
- `app/Http/Requests/LaborBudget/StoreLaborBudgetRequest.php`
- `app/Http/Requests/LaborBudget/UpdateLaborBudgetRequest.php`
- `app/Policies/LaborBudgetPolicy.php`
- `app/Notifications/BudgetThresholdNotification.php`
- `app/Console/Commands/SendBudgetAlerts.php`
- `resources/views/budgets/index.blade.php`
- `resources/views/budgets/create.blade.php`
- `resources/views/budgets/edit.blade.php`
- `resources/views/components/budget-indicator.blade.php`
- `tests/Feature/LaborBudgetTest.php`
- Database migrations for `labor_budgets` and `labor_budget_snapshots` tables

## Tasks

- [ ] Create LaborBudget model with relationships
- [ ] Create LaborBudgetSnapshot model
- [ ] Create LaborBudgetService with:
  - `setBudget()` - Create/update budget
  - `calculateScheduledCost()` - Sum of scheduled shift costs
  - `calculateActualCost()` - Sum of actual labor costs
  - `getBudgetStatus()` - Return status with percentages
  - `wouldExceedBudget()` - Check before creating shift
  - `getLaborCostByEmployee()` - Breakdown per employee
  - `createPeriodSnapshot()` - Archive completed period
- [ ] Create LaborBudgetController with CRUD
- [ ] Create form requests for validation
- [ ] Create LaborBudgetPolicy for authorization
- [ ] Create budget index view with list of budgets
- [ ] Create budget create/edit forms with:
  - Location selector
  - Optional department selector
  - Period type (weekly/bi-weekly/monthly)
  - Budget amount and currency
  - Warning/critical thresholds
- [ ] Create budget-indicator component for schedule view
- [ ] Integrate indicator into week view header
- [ ] Add tooltip showing: Budget, Scheduled, Actual, Remaining
- [ ] Add warning when creating shift would exceed budget
- [ ] Create budget status API endpoint
- [ ] Create budget breakdown API endpoint
- [ ] Create SendBudgetAlerts command
- [ ] Schedule command to run daily
- [ ] Create BudgetThresholdNotification
- [ ] Add navigation link under Settings
- [ ] Write unit tests for cost calculations
- [ ] Write feature tests for CRUD and API
- [ ] Write tests for schedule view integration

## Dependencies

- Shift model with duration and user relationship
- User model with hourly_rate
- TimeEntry model (for actual cost calculation)
- Location model
- Department model
- Tenant model with overtime settings
- Laravel Scheduler for daily alerts
