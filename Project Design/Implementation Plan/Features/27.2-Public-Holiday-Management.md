# Feature 27.2: Public Holiday Management

**Status:** Not Started
**Effort:** Medium
**Phase:** 27 - Advanced Shift Features

## Overview

Holiday import, pay rates, and scheduling integration. Allows tenants to manage public holidays for their region, apply holiday pay multipliers, and let employees indicate their availability to work on holidays.

## Requirements

### Functional Requirements

#### Holiday Management
- Import public holidays from external API (Nager.Date or similar)
- Support multiple countries and regions
- Manually add custom company holidays
- Edit or remove imported holidays
- Holidays are tenant-scoped

#### Holiday Pay
- Configure pay multiplier per holiday (e.g., 1.5x, 2x)
- Different rates for different holiday types
- Automatic holiday pay calculation in timesheets
- Holiday pay shown in payroll exports

#### Schedule Integration
- Display holidays on schedule calendar
- Visual indicator for shifts on holidays
- Warning when scheduling on holidays
- Employee holiday work preference submission

#### Employee Preferences
- Employees can indicate willingness to work holidays
- Preference can be set per holiday or general availability
- Managers can view holiday availability when scheduling

### Authorization
- Admins can manage holidays and pay rates
- Managers can view holiday availability
- Employees can submit their preferences

## Database Changes

### Tables to Create

**public_holidays**
| Column | Type | Description |
|--------|------|-------------|
| id | bigint | Primary key |
| tenant_id | bigint | Foreign key to tenants |
| name | string | Holiday name |
| date | date | Holiday date |
| country_code | string | ISO country code |
| region_code | string | State/province code (nullable) |
| type | string | public/bank/company |
| pay_multiplier | decimal | Pay rate multiplier (default 1.0) |
| is_recurring | boolean | Repeats annually |
| external_id | string | ID from external API |
| created_at | timestamp | |
| updated_at | timestamp | |

**holiday_work_preferences**
| Column | Type | Description |
|--------|------|-------------|
| id | bigint | Primary key |
| public_holiday_id | bigint | Foreign key to public_holidays |
| user_id | bigint | Employee |
| availability | string | available/unavailable/preferred_off |
| notes | text | Optional notes |
| submitted_at | timestamp | |
| created_at | timestamp | |
| updated_at | timestamp | |

## Files

### To Create
- `app/Models/PublicHoliday.php`
- `app/Models/HolidayWorkPreference.php`
- `app/Enums/HolidayType.php`
- `app/Enums/HolidayAvailability.php`
- `app/Services/HolidayService.php`
- `app/Services/HolidayImportService.php`
- `app/Http/Controllers/HolidayController.php`
- `app/Http/Controllers/HolidayPreferenceController.php`
- `app/Http/Requests/Holiday/StoreHolidayRequest.php`
- `app/Http/Requests/Holiday/ImportHolidaysRequest.php`
- `resources/views/settings/holidays/index.blade.php`
- `resources/views/settings/holidays/create.blade.php`
- `resources/views/settings/holidays/edit.blade.php`
- `resources/views/settings/holidays/import.blade.php`
- `resources/views/holidays/preferences.blade.php`
- `database/migrations/xxxx_create_public_holidays_table.php`
- `database/migrations/xxxx_create_holiday_work_preferences_table.php`
- `tests/Feature/HolidayTest.php`
- `tests/Feature/HolidayPreferenceTest.php`

### Routes
```php
Route::resource('settings/holidays', HolidayController::class);
Route::get('settings/holidays/import', [HolidayController::class, 'showImport'])->name('holidays.import.show');
Route::post('settings/holidays/import', [HolidayController::class, 'import'])->name('holidays.import');
Route::get('holidays/preferences', [HolidayPreferenceController::class, 'index'])->name('holidays.preferences.index');
Route::post('holidays/{holiday}/preference', [HolidayPreferenceController::class, 'store'])->name('holidays.preferences.store');
```

## Tasks

- [ ] Create database migrations for public_holidays and holiday_work_preferences tables
- [ ] Create PublicHoliday model
- [ ] Create HolidayWorkPreference model
- [ ] Create HolidayType enum (Public, Bank, Company)
- [ ] Create HolidayAvailability enum (Available, Unavailable, PreferredOff)
- [ ] Create HolidayService for holiday management
- [ ] Create HolidayImportService for external API integration
- [ ] Integrate holiday API (Nager.Date or similar)
- [ ] Implement country/region holiday import
- [ ] Add holiday pay multiplier support
- [ ] Show holidays on schedule calendar
- [ ] Create holiday work preference submission form
- [ ] Calculate holiday pay in timesheets
- [ ] Add visual indicator for shifts on holidays
- [ ] Write tests

## Holiday Enums

```php
enum HolidayType: string
{
    case Public = 'public';
    case Bank = 'bank';
    case Company = 'company';
}

enum HolidayAvailability: string
{
    case Available = 'available';
    case Unavailable = 'unavailable';
    case PreferredOff = 'preferred_off';
}
```

## External API Integration

Using Nager.Date API (https://date.nager.at/):

```php
// Example API call
$response = Http::get("https://date.nager.at/api/v3/PublicHolidays/{$year}/{$countryCode}");

// Response format
[
    {
        "date": "2024-01-01",
        "localName": "New Year's Day",
        "name": "New Year's Day",
        "countryCode": "US",
        "fixed": true,
        "global": true,
        "counties": null,
        "launchYear": null,
        "types": ["Public"]
    }
]
```

## Tests

Expected tests in `tests/Feature/HolidayTest.php`:

1. `test_admin_can_view_holidays_index`
2. `test_admin_can_create_custom_holiday`
3. `test_admin_can_import_holidays_for_country`
4. `test_admin_can_edit_holiday_pay_multiplier`
5. `test_admin_can_delete_holiday`
6. `test_holidays_are_tenant_scoped`
7. `test_employee_can_submit_holiday_preference`
8. `test_employee_can_update_preference`
9. `test_manager_can_view_holiday_availability`
10. `test_holiday_pay_calculated_in_timesheet`
11. `test_holidays_shown_on_schedule_calendar`
12. `test_recurring_holiday_appears_annually`

## Dependencies

- Tenant model
- User model
- Shift model
- Timesheet model
- Schedule views
- HTTP client for API integration
