# Feature 1.4: Leave Allowances Management

**Status:** Completed
**Effort:** Medium
**Phase:** 1 - Core Features

## Overview

Manage annual leave allowances per employee per leave type. Admins can set how many days each employee is entitled to for each leave type per year, and track usage.

## Requirements

### Functional Requirements
- Admins can view all leave allowances filtered by year and leave type
- Admins can create allowances for employees
- Admins can edit total days and carried over days
- Allowances track: total days, used days, carried over days
- Calculate remaining days automatically
- Cannot delete allowances that have been used
- Prevent duplicate allowances (same user + leave type + year)

### Display
- Show employee name, leave type, total, used, carried over, and remaining days
- Color-code remaining days (red if 0, amber if low, green if healthy)
- Filter by year and leave type

## Files

### Created
- `app/Http/Controllers/LeaveAllowanceController.php`
- `app/Http/Requests/LeaveAllowance/StoreLeaveAllowanceRequest.php`
- `app/Http/Requests/LeaveAllowance/UpdateLeaveAllowanceRequest.php`
- `app/Policies/LeaveAllowancePolicy.php`
- `database/factories/LeaveAllowanceFactory.php`
- `resources/views/leave-allowances/index.blade.php`
- `resources/views/leave-allowances/create.blade.php`
- `resources/views/leave-allowances/edit.blade.php`
- `tests/Feature/LeaveAllowanceManagementTest.php`

### Modified
- `app/Models/LeaveAllowance.php` - Added HasFactory trait

### Routes
```php
Route::resource('leave-allowances', LeaveAllowanceController::class)->except(['show']);
```

## Tasks

- [x] Create LeaveAllowanceController with CRUD actions
- [x] Create StoreLeaveAllowanceRequest with duplicate check
- [x] Create UpdateLeaveAllowanceRequest with tenant validation
- [x] Create LeaveAllowancePolicy for authorization
- [x] Create LeaveAllowanceFactory for testing
- [x] Create index view with year/leave type filters
- [x] Create create form for new allowances
- [x] Create edit form for adjusting allowances
- [x] Add routes to web.php
- [x] Add navigation link to sidebar
- [x] Write comprehensive tests (14 tests)

## Allowance Properties

| Property | Type | Description |
|----------|------|-------------|
| user_id | FK | The employee |
| leave_type_id | FK | The leave type |
| year | integer | The year (e.g., 2024) |
| total_days | decimal | Total days allocated |
| used_days | decimal | Days used (auto-tracked) |
| carried_over_days | decimal | Days carried from previous year |

### Computed Properties
- `remaining_days` = total_days + carried_over_days - used_days
- `total_available` = total_days + carried_over_days

## Tests

All tests located in `tests/Feature/LeaveAllowanceManagementTest.php`:

1. `test_admin_can_view_leave_allowances_index`
2. `test_employee_cannot_view_leave_allowances_index`
3. `test_admin_can_filter_allowances_by_year`
4. `test_admin_can_view_create_leave_allowance_form`
5. `test_admin_can_create_leave_allowance`
6. `test_leave_allowance_requires_user`
7. `test_leave_allowance_requires_leave_type`
8. `test_cannot_create_duplicate_allowance`
9. `test_admin_can_view_edit_leave_allowance_form`
10. `test_admin_can_update_leave_allowance`
11. `test_admin_can_delete_unused_leave_allowance`
12. `test_admin_cannot_delete_used_leave_allowance`
13. `test_admin_from_different_tenant_cannot_access_leave_allowance`
14. `test_index_shows_remaining_days`

## Dependencies

- LeaveAllowance model
- LeaveType model
- User model
- Tenant scoping via BelongsToTenant trait
