# Feature 22.1: Data Retention System

**Status:** Not Started
**Effort:** Large
**Phase:** 22 - Data Retention & Notifications

## Overview

Tenant-configurable data retention and archival policies. This system allows organizations to define how long different types of data are retained, automatically archive old records, and ensure GDPR compliance for data deletion requests.

## Requirements

### Functional Requirements
- Tenant-configurable retention policies per data type
- Automatic archival of records past retention period
- Cold storage for archived records
- GDPR-compliant data export functionality
- Manual purge capability for admins
- Audit trail for data operations

### Data Types with Retention
- Shifts and schedules
- Time entries (clock in/out)
- Leave requests
- Shift swap requests
- Notifications
- Audit logs
- Employee records (after termination)

### Retention Options
- Keep forever
- 6 months
- 1 year
- 2 years
- 3 years
- 5 years
- 7 years (common legal requirement)

### Archive vs Delete
- **Archive**: Move to cold storage, retrievable
- **Delete**: Permanent removal after archive period

## Files

### To Create
- `app/Models/DataRetentionPolicy.php`
- `app/Models/ArchivedRecord.php`
- `app/Services/DataRetentionService.php`
- `app/Services/DataExportService.php`
- `app/Console/Commands/ProcessDataRetention.php`
- `app/Http/Controllers/DataRetentionController.php`
- `app/Http/Requests/DataRetention/UpdatePolicyRequest.php`
- `app/Jobs/ArchiveRecordsJob.php`
- `app/Jobs/PurgeArchivedRecordsJob.php`
- `resources/views/settings/data-retention.blade.php`
- `resources/views/settings/data-export.blade.php`
- `database/migrations/xxxx_create_data_retention_policies_table.php`
- `database/migrations/xxxx_create_archived_records_table.php`
- `tests/Feature/DataRetentionTest.php`

### Routes
```php
Route::prefix('settings/data-retention')->name('settings.data-retention.')->group(function () {
    Route::get('/', [DataRetentionController::class, 'index'])->name('index');
    Route::put('/', [DataRetentionController::class, 'update'])->name('update');
    Route::get('export', [DataRetentionController::class, 'exportForm'])->name('export');
    Route::post('export', [DataRetentionController::class, 'export'])->name('export.generate');
    Route::get('export/{exportId}/download', [DataRetentionController::class, 'download'])->name('export.download');
});
```

## Database Schema

### data_retention_policies
| Column | Type | Description |
|--------|------|-------------|
| id | bigint | Primary key |
| tenant_id | bigint | Foreign key to tenants |
| data_type | string | shifts, time_entries, leave_requests, etc. |
| retention_period | integer | Months to retain (0 = forever) |
| archive_after | integer | Months before archiving |
| delete_after | integer | Months after archive to delete |
| is_active | boolean | Policy enabled |
| last_processed_at | timestamp | Last retention run |
| created_at | timestamp | |
| updated_at | timestamp | |

### archived_records
| Column | Type | Description |
|--------|------|-------------|
| id | bigint | Primary key |
| tenant_id | bigint | Foreign key to tenants |
| data_type | string | Original model type |
| original_id | bigint | Original record ID |
| data | json | Serialized record data |
| archived_at | timestamp | When archived |
| delete_after | timestamp | Scheduled deletion date |
| deleted_at | timestamp | Soft delete |
| created_at | timestamp | |
| updated_at | timestamp | |

## Default Retention Policies

| Data Type | Archive After | Delete After |
|-----------|---------------|--------------|
| Shifts | 24 months | 36 months |
| Time Entries | 24 months | 84 months (7 years) |
| Leave Requests | 24 months | 36 months |
| Swap Requests | 12 months | 24 months |
| Notifications | 6 months | 12 months |
| Audit Logs | 36 months | 84 months |

## GDPR Export Format

Export includes:
- All personal data for the employee
- Shift history
- Time entry history
- Leave request history
- In machine-readable format (JSON)
- With human-readable summary (PDF)

## Tasks

- [ ] Create data_retention_policies migration
- [ ] Create archived_records migration
- [ ] Create DataRetentionPolicy model
- [ ] Create ArchivedRecord model
- [ ] Create DataRetentionService
  - [ ] Check records against policies
  - [ ] Archive eligible records
  - [ ] Delete expired archives
- [ ] Create DataExportService for GDPR
- [ ] Create ProcessDataRetention command
- [ ] Schedule daily retention processing
- [ ] Create ArchiveRecordsJob
- [ ] Create PurgeArchivedRecordsJob
- [ ] Create admin UI for configuring policies
- [ ] Create data export request form
- [ ] Implement GDPR data export functionality
- [ ] Generate JSON and PDF exports
- [ ] Write comprehensive tests

## Tests

Planned tests for `tests/Feature/DataRetentionTest.php`:

1. `test_admin_can_view_retention_settings`
2. `test_admin_can_update_retention_policy`
3. `test_records_archived_after_retention_period`
4. `test_archived_records_deleted_after_expiry`
5. `test_records_not_archived_before_period`
6. `test_keep_forever_policy_prevents_archival`
7. `test_archived_record_preserves_data`
8. `test_gdpr_export_includes_all_data`
9. `test_gdpr_export_generates_json`
10. `test_gdpr_export_generates_pdf`
11. `test_different_tenants_separate_policies`
12. `test_retention_command_processes_all_tenants`

## Dependencies

- Tenant model
- All archivable models (Shift, TimeEntry, etc.)
- Queue system for async processing
- File storage for exports
- PDF generation library
