# Feature 23.3: Employee Stats Dashboard

**Status:** Not Started
**Effort:** Small
**Phase:** 23 - Offline & Self-Service

## Overview

Tenant-configurable employee statistics visibility. This allows employees to view their personal work statistics while giving organizations control over what metrics are visible to employees.

## Requirements

### Functional Requirements
- Personal statistics dashboard for employees
- Tenant-configurable visibility settings
- Display hours worked, leave balance, upcoming shifts
- Optionally show attendance/punctuality metrics
- Historical data visualization

### Available Statistics
- **Always Visible**
  - Upcoming shifts
  - Current leave balance
  - Pending leave requests
  - Active shift swap requests

- **Configurable Visibility**
  - Hours worked (this week/month/year)
  - Attendance rate
  - Punctuality rate
  - Late arrivals count
  - Early departures count
  - Overtime hours
  - Average shift length

### Configuration Options
| Setting | Description |
|---------|-------------|
| show_hours_worked | Display total hours worked |
| show_attendance_rate | Display attendance percentage |
| show_punctuality_rate | Display on-time percentage |
| show_overtime | Display overtime hours |
| show_shift_stats | Display shift-related metrics |

## Files

### To Create
- `app/Services/EmployeeStatsService.php`
- `app/Http/Controllers/EmployeeStatsController.php`
- `resources/views/employee/stats/index.blade.php`
- `resources/views/components/employee/stats-card.blade.php`
- `resources/views/components/employee/hours-chart.blade.php`
- `tests/Feature/EmployeeStatsDashboardTest.php`

### To Modify
- `app/Models/TenantSettings.php` - Add stats visibility settings
- `database/migrations/xxxx_add_employee_stats_settings_to_tenant_settings.php`
- `resources/views/settings/edit.blade.php` - Add stats visibility section

### Routes
```php
Route::get('my-stats', [EmployeeStatsController::class, 'index'])->name('my-stats');
Route::get('my-stats/data', [EmployeeStatsController::class, 'data'])->name('my-stats.data');
```

## Employee Stats Service

```php
class EmployeeStatsService
{
    public function getStats(User $employee, array $visibleStats): array
    {
        return [
            'upcoming_shifts' => $this->getUpcomingShifts($employee),
            'leave_balance' => $this->getLeaveBalance($employee),
            'hours_worked' => $this->getHoursWorked($employee),
            'attendance_rate' => $this->getAttendanceRate($employee),
            'punctuality_rate' => $this->getPunctualityRate($employee),
            'overtime' => $this->getOvertime($employee),
            // ... more stats
        ];
    }

    public function getHoursWorked(User $employee, ?string $period = 'month'): array
    {
        // Returns hours for week, month, year
    }

    public function getAttendanceRate(User $employee): float
    {
        // (Attended shifts / Scheduled shifts) * 100
    }

    public function getPunctualityRate(User $employee): float
    {
        // (On-time clock ins / Total clock ins) * 100
    }
}
```

## Tenant Settings Schema

Add to tenant_settings:

| Setting | Type | Default | Description |
|---------|------|---------|-------------|
| employee_stats_hours_worked | boolean | true | Show hours worked |
| employee_stats_attendance | boolean | false | Show attendance rate |
| employee_stats_punctuality | boolean | false | Show punctuality rate |
| employee_stats_overtime | boolean | true | Show overtime |
| employee_stats_shift_count | boolean | true | Show shift counts |
| employee_stats_period | string | month | Default view period |

## Dashboard Components

### Stats Overview
- Hours this week/month
- Leave balance summary
- Next shift countdown
- Quick stats cards

### Charts
- Weekly hours bar chart
- Monthly attendance trend
- Punctuality over time

### Lists
- Upcoming shifts (next 7 days)
- Recent time entries
- Pending requests

## Tasks

- [ ] Create migration for tenant stats settings
- [ ] Update TenantSettings model
- [ ] Create EmployeeStatsService
- [ ] Create EmployeeStatsController
- [ ] Create stats dashboard view
- [ ] Create stats card component
- [ ] Create hours chart component (using Chart.js or similar)
- [ ] Display always-visible stats
- [ ] Conditionally show attendance based on settings
- [ ] Conditionally show punctuality based on settings
- [ ] Add stats settings to tenant settings page
- [ ] Add navigation link to employee menu
- [ ] Write comprehensive tests

## Tests

Planned tests for `tests/Feature/EmployeeStatsDashboardTest.php`:

1. `test_employee_can_view_stats_dashboard`
2. `test_dashboard_shows_upcoming_shifts`
3. `test_dashboard_shows_leave_balance`
4. `test_dashboard_shows_hours_when_enabled`
5. `test_dashboard_hides_hours_when_disabled`
6. `test_attendance_shown_when_enabled`
7. `test_attendance_hidden_when_disabled`
8. `test_punctuality_shown_when_enabled`
9. `test_punctuality_hidden_when_disabled`
10. `test_stats_calculated_correctly`
11. `test_admin_can_configure_visibility`
12. `test_different_tenants_different_settings`

## Dependencies

- Shift model
- TimeEntry model
- LeaveAllowance model
- TenantSettings model
- User model
- Chart library (Chart.js)
