# Feature 18.2: Predictive Absence Analytics

**Status:** Not Started
**Effort:** Medium
**Phase:** 18 - Analytics Enhancements

## Overview

Identify absence patterns and predict risks. Analyzes historical absence data to detect patterns (Monday/Friday, pre-holiday, seasonal) and generate risk scores to help managers plan proactively.

## Requirements

### Functional Requirements
- Detect Monday/Friday absence patterns
- Detect pre/post holiday absence patterns
- Detect seasonal absence patterns
- Calculate absence trend per employee
- Generate risk scores for upcoming periods
- Create pattern visualizations
- Alert managers for at-risk employees

### Pattern Types
| Pattern | Description |
|---------|-------------|
| Monday/Friday | Higher absences at week boundaries |
| Pre-Holiday | Absences before public holidays |
| Post-Holiday | Absences after holidays/vacations |
| Seasonal | Patterns tied to seasons (winter flu, summer) |
| Personal | Individual employee patterns |

### Risk Indicators
- Increasing absence frequency
- Pattern-based prediction
- Historical same-period comparison
- Team average comparison

### UI Components
- Absence patterns dashboard
- Pattern visualizations (charts)
- At-risk employee list
- Individual employee absence profile
- Upcoming risk alerts

## Files

### To Create
- `app/Services/AbsenceAnalyticsService.php` - Analytics calculations
- `resources/views/analytics/absence-patterns.blade.php` - Dashboard view
- `tests/Feature/PredictiveAbsenceAnalyticsTest.php` - Feature tests

### Routes
```php
Route::get('analytics/absence-patterns', [AnalyticsController::class, 'absencePatterns'])->name('analytics.absence-patterns');
Route::get('api/analytics/absence/patterns', [AnalyticsController::class, 'absencePatternsData'])->name('api.analytics.absence.patterns');
Route::get('api/analytics/absence/risk', [AnalyticsController::class, 'absenceRisk'])->name('api.analytics.absence.risk');
Route::get('api/analytics/absence/user/{user}', [AnalyticsController::class, 'userAbsence'])->name('api.analytics.absence.user');
```

## Pattern Detection Algorithms

### Monday/Friday Pattern
```php
public function detectWeekBoundaryPattern(User $user, Carbon $period): float
{
    $absences = $user->absences()->whereIn('date', $period)->get();

    $mondayFriday = $absences->filter(fn($a) =>
        $a->date->isMonday() || $a->date->isFriday()
    )->count();

    $midWeek = $absences->filter(fn($a) =>
        !$a->date->isMonday() && !$a->date->isFriday() && !$a->date->isWeekend()
    )->count();

    // Expected ratio if random: 2/5 = 0.4
    // Higher ratio indicates pattern
    $actual = $mondayFriday / max(1, $mondayFriday + $midWeek);

    return $actual / 0.4; // Pattern strength (1.0 = normal, >1.5 = pattern)
}
```

### Risk Score Calculation
```php
public function calculateRiskScore(User $user, Carbon $targetDate): int
{
    $score = 0;

    // Historical same day pattern
    $score += $this->getSameDayHistoricalAbsenceRate($user, $targetDate) * 30;

    // Week boundary pattern
    if ($targetDate->isMonday() || $targetDate->isFriday()) {
        $score += $this->getWeekBoundaryPatternStrength($user) * 20;
    }

    // Pre/post holiday
    if ($this->isNearHoliday($targetDate)) {
        $score += $this->getHolidayPatternStrength($user) * 25;
    }

    // Recent absence trend
    $score += $this->getRecentAbsenceTrend($user) * 25;

    return min(100, $score);
}
```

## Tasks

- [ ] Create AbsenceAnalyticsService
- [ ] Detect Monday/Friday patterns
- [ ] Detect pre/post holiday patterns
- [ ] Detect seasonal patterns
- [ ] Calculate absence trend per employee
- [ ] Generate risk scores
- [ ] Create pattern visualization
- [ ] Add manager alerts for at-risk employees
- [ ] Write tests

## Tests

Suggested tests for `tests/Feature/PredictiveAbsenceAnalyticsTest.php`:

1. `test_admin_can_view_absence_patterns_dashboard`
2. `test_monday_friday_pattern_is_detected`
3. `test_pre_holiday_pattern_is_detected`
4. `test_post_holiday_pattern_is_detected`
5. `test_seasonal_pattern_is_detected`
6. `test_absence_trend_is_calculated`
7. `test_risk_score_is_generated`
8. `test_at_risk_employees_are_identified`
9. `test_pattern_visualization_data_is_correct`
10. `test_employee_cannot_access_absence_analytics`

## Dependencies

- User model
- LeaveRequest model (for absence data)
- TimeEntry model (for no-shows)
- Holiday/calendar data
