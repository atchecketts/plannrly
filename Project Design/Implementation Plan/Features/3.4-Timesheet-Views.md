# Feature 3.4: Timesheet Views

**Status:** Complete
**Effort:** Medium
**Phase:** 3 - Time & Attendance
**Completed:** January 2026

## Overview

View and manage timesheets with scheduled vs actual comparison. This feature provides comprehensive views for both employees and managers to review time entries, compare scheduled versus actual hours, and approve timesheets when required.

## Requirements

### Functional Requirements
- Weekly timesheet views with navigation
- Side-by-side scheduled vs actual times
- Variance highlighting (late, early, overtime) using color-coded badges
- Total hours summary per employee and weekly
- Filter by employee, department (admin only)
- Batch approval workflow for managers
- Separate views for admin and employee

### Views
- Admin index view (all employees grouped by user)
- Employee view (own entries only with week grid)
- Weekly summary with totals and pending approval counts

## Implementation

### Files Created
- `app/Http/Controllers/TimesheetController.php` - Main controller with index, employee, approveMultiple methods
- `resources/views/timesheets/index.blade.php` - Admin view with employee grouping, batch approval
- `resources/views/timesheets/employee.blade.php` - Employee personal view with week grid and detailed list
- `tests/Feature/TimesheetTest.php` - 15 tests covering all functionality

### Files Modified
- `routes/web.php` - Added timesheet routes
- `app/Policies/TimeEntryPolicy.php` - Added approveMultiple method
- `resources/views/components/layouts/app.blade.php` - Added Timesheets navigation link

## Tasks

- [x] Create TimesheetController with index(), employee(), approveMultiple()
- [x] Create admin timesheet index (grouped by employee with totals)
- [x] Create employee timesheet view (week grid + detailed list)
- [x] Add week navigation (previous/next/today)
- [x] Show scheduled shift times alongside actual clock times
- [x] Calculate and display variances with color-coded badges
- [x] Add batch approval for managers with checkboxes
- [x] Add navigation link to sidebar (conditional on enable_clock_in_out)
- [x] Write comprehensive tests

## Routes

```php
Route::get('timesheets', [TimesheetController::class, 'index'])->name('timesheets.index');
Route::get('timesheets/my', [TimesheetController::class, 'employee'])->name('timesheets.employee');
Route::post('timesheets/approve-multiple', [TimesheetController::class, 'approveMultiple'])->name('timesheets.approve-multiple');
```

## Timesheet Data Display

### Admin View (index.blade.php)
| Column | Description |
|--------|-------------|
| Date | Date of the entry with business role indicator |
| Scheduled | Shift scheduled start-end time |
| Actual | Clock-in and clock-out times |
| Hours | Total worked hours with break minutes |
| Variance | Clock-in status badge (On Time/Late/Early) |
| Status | Pending/Complete/Approved/In Progress badges |
| Actions | View link, approval checkbox |

### Employee View (employee.blade.php)
- **Summary Cards**: Scheduled hours, Worked hours, Variance, Breaks, Entry count with pending
- **Week Grid**: 7-day grid showing entries by day with quick links
- **Detailed List**: Full table view with all entry details

## Key Features

### Week Navigation
- Previous/Next week buttons with date parameter
- "Today" / "This Week" quick navigation
- Displays week range in header (e.g., "Week of Jan 27 - Feb 02, 2026")

### Batch Approval
- Available to Admin, LocationAdmin, DepartmentAdmin
- Checkboxes on pending entries
- "Select All" per employee section
- "Approve Selected" button submits all checked entries
- Only shown when `require_manager_approval` setting is enabled

### Summary Totals
- Per-user totals in admin view (scheduled, actual, variance, pending count)
- Weekly totals in employee view
- Variance displayed with +/- hours and color coding

### Variance Color Coding
- **Green**: On time or within grace period
- **Yellow**: Slightly late (15-30 minutes)
- **Red**: Significantly late or early departure
- **Orange**: Overtime worked
- **Blue**: Early clock-in

## Dependencies

- TimeEntry model with variance accessors (Feature 3.3)
- Shift model with businessRole relationship
- User model with role checking methods
- TenantSettings for approval requirements
- TimeEntryPolicy for authorization

## Testing

The test suite (`tests/Feature/TimesheetTest.php`) covers:
- Admin can view timesheets index
- Employee can view their own timesheet
- Admin sees all employee timesheets
- Employee only sees own entries in index
- Admin can filter by employee and department
- Week navigation works (previous/next)
- Admin can approve multiple entries
- Employee cannot approve entries
- Empty entry selection handling
- Weekly totals calculation
- Pending approval count display
- Tenant isolation (cross-tenant access denied)
