# Feature 2.5: Staffing Requirements & Coverage Warnings

**Status:** Pending
**Effort:** Large
**Phase:** 2 - Scheduling Features

## Overview

Define minimum and maximum staffing levels per role and show warnings on schedule views. This feature helps managers ensure adequate coverage by displaying visual indicators when staffing levels are below minimum or above maximum thresholds.

## Requirements

### Functional Requirements
- CRUD for staffing requirements
- Different min/max per business role
- Rules can vary by day of week (e.g., weekends need more staff)
- Split day into time slots with different requirements
- Rules can be global, per-location, or per-department
- Visual indicators on week/day schedule views
- Coverage summary widget showing status for the period

### Coverage Status Values
| Value | Description | Color |
|-------|-------------|-------|
| adequate | Within min/max range | Green |
| understaffed | Below minimum | Red/Orange |
| overstaffed | Above maximum | Yellow |
| no_requirement | No rule defined | Gray |

## Files

### To Create
- `app/Models/StaffingRequirement.php`
- `app/Enums/CoverageStatus.php`
- `app/Services/CoverageAnalysisService.php`
- `app/Http/Controllers/StaffingRequirementController.php`
- `app/Http/Controllers/CoverageController.php`
- `app/Http/Requests/StaffingRequirement/StoreStaffingRequirementRequest.php`
- `app/Http/Requests/StaffingRequirement/UpdateStaffingRequirementRequest.php`
- `app/Policies/StaffingRequirementPolicy.php`
- `resources/views/staffing-requirements/index.blade.php`
- `resources/views/staffing-requirements/create.blade.php`
- `resources/views/staffing-requirements/edit.blade.php`
- `resources/views/components/coverage-indicator.blade.php`
- `resources/views/components/coverage-summary.blade.php`
- `tests/Feature/StaffingRequirementTest.php`
- `tests/Unit/Services/CoverageAnalysisServiceTest.php`

## Database Schema

The `staffing_requirements` table:
- `id` (bigint unsigned, PK)
- `tenant_id` (FK to tenants)
- `location_id` (FK to locations, nullable)
- `department_id` (FK to departments, nullable)
- `business_role_id` (FK to business_roles)
- `day_of_week` (tinyint, 0-6)
- `start_time` (time)
- `end_time` (time)
- `min_employees` (integer, default 0)
- `max_employees` (integer, nullable)
- `is_active` (boolean, default true)
- `notes` (text, nullable)
- `timestamps`

## Tasks

- [ ] Create StaffingRequirement model with relationships
- [ ] Create CoverageStatus enum
- [ ] Create CoverageAnalysisService with:
  - `analyzeCoverage()` - Analyze full date range
  - `getDayCoverage()` - Get coverage for single day
  - `getTimeSlotCoverage()` - Check specific time slot
  - `countScheduledEmployees()` - Count scheduled for slot
- [ ] Create StaffingRequirementController with CRUD
- [ ] Create CoverageController for API
- [ ] Create policy for authorization
- [ ] Create index view with table of rules
- [ ] Create create/edit forms with:
  - Role selector
  - Day of week picker (multi-select or single)
  - Time window pickers (start/end)
  - Min/max employee inputs
- [ ] Add navigation link to sidebar under Settings
- [ ] Create coverage indicator component (shows colored badge)
- [ ] Create coverage summary widget (shows gaps count)
- [ ] Integrate indicators into schedule week view
- [ ] Integrate indicators into schedule day view
- [ ] Add API endpoint for coverage analysis
- [ ] Integrate with AI Scheduling as constraint
- [ ] Write unit tests for coverage calculations
- [ ] Write feature tests for CRUD operations
- [ ] Write tests for schedule view integration

## Schedule View Integration

### Week View
- Show small colored indicator per cell when coverage issues exist
- Hover to show tooltip with details ("Need 1 more Waiter 09:00-10:00")
- Optional coverage summary bar above schedule

### Day View
- Show coverage status per time slot in the timeline header
- Red highlight for understaffed time windows
- Yellow highlight for overstaffed time windows
- Coverage summary panel

## Dependencies

- BusinessRole model
- Location model
- Department model
- Tenant model
- Schedule week and day views
- AI Scheduling system (for constraint integration)
