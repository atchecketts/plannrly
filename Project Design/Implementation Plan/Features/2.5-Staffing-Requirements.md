# Feature 2.5: Staffing Requirements & Coverage Warnings

**Status:** Complete
**Effort:** Large
**Phase:** 2 - Scheduling Features
**Completed:** January 2026

## Overview

Define minimum and maximum staffing levels per role and show warnings on schedule views. This feature helps managers ensure adequate coverage by displaying visual indicators when staffing levels are below minimum or above maximum thresholds.

## Requirements

### Functional Requirements
- CRUD for staffing requirements
- Different min/max per business role
- Rules can vary by day of week (e.g., weekends need more staff)
- Split day into time slots with different requirements
- Rules can be global, per-location, or per-department
- Visual indicators on week/day schedule views
- Coverage summary widget showing status for the period

### Coverage Status Values
| Value | Description | Color |
|-------|-------------|-------|
| adequate | Within min/max range | Green |
| understaffed | Below minimum | Red/Orange |
| overstaffed | Above maximum | Yellow |
| no_requirement | No rule defined | Gray |

## Files

### Created
- `database/migrations/2026_01_29_000001_create_staffing_requirements_table.php`
- `app/Models/StaffingRequirement.php`
- `app/Enums/CoverageStatus.php`
- `app/Services/CoverageAnalysisService.php`
- `app/Http/Controllers/StaffingRequirementController.php`
- `app/Http/Requests/StaffingRequirement/StoreStaffingRequirementRequest.php`
- `app/Http/Requests/StaffingRequirement/UpdateStaffingRequirementRequest.php`
- `app/Policies/StaffingRequirementPolicy.php`
- `resources/views/staffing-requirements/index.blade.php`
- `resources/views/staffing-requirements/create.blade.php`
- `resources/views/staffing-requirements/edit.blade.php`
- `resources/views/staffing-requirements/_row.blade.php`
- `resources/views/components/coverage-indicator.blade.php`
- `resources/views/components/coverage-summary.blade.php`
- `database/factories/StaffingRequirementFactory.php`
- `tests/Feature/StaffingRequirementTest.php`
- `tests/Unit/Services/CoverageAnalysisServiceTest.php`

### Modified
- `routes/web.php` - Added staffing-requirements resource route
- `app/Providers/AppServiceProvider.php` - Registered policy
- `resources/views/components/layouts/app.blade.php` - Added navigation link
- `app/Http/Controllers/ScheduleController.php` - Injected CoverageAnalysisService
- `resources/views/schedule/index.blade.php` - Added coverage summary
- `resources/views/schedule/day.blade.php` - Added day coverage display

## Database Schema

The `staffing_requirements` table:
- `id` (bigint unsigned, PK)
- `tenant_id` (FK to tenants)
- `location_id` (FK to locations, nullable)
- `department_id` (FK to departments, nullable)
- `business_role_id` (FK to business_roles)
- `day_of_week` (tinyint, 0-6)
- `start_time` (time)
- `end_time` (time)
- `min_employees` (integer, default 0)
- `max_employees` (integer, nullable)
- `is_active` (boolean, default true)
- `notes` (text, nullable)
- `timestamps`

## Tasks

- [x] Create migration for staffing_requirements table
- [x] Create StaffingRequirement model with relationships
- [x] Create CoverageStatus enum with label(), color(), icon() methods
- [x] Create CoverageAnalysisService with:
  - `analyzeCoverage()` - Analyze full date range
  - `getDayCoverage()` - Get coverage for single day
  - `getTimeSlotCoverage()` - Check specific time slot
  - `countScheduledEmployees()` - Count scheduled for slot
  - `getCoverageSummary()` - Get aggregated statistics
  - `getCoverageIssues()` - Get list of problematic slots
- [x] Create StaffingRequirementController with CRUD
- [x] Create policy for authorization (admin/location_admin can view, admin can edit)
- [x] Create form requests with validation
- [x] Create index view with sortable/groupable table
- [x] Create create/edit forms with:
  - Role selector
  - Day of week picker
  - Time window pickers (start/end)
  - Min/max employee inputs
  - Location/department scope (optional)
- [x] Add navigation link to sidebar
- [x] Create coverage indicator component (shows colored badge)
- [x] Create coverage summary component (shows gaps count)
- [x] Integrate coverage summary into schedule week view
- [x] Integrate coverage display into schedule day view
- [x] Create StaffingRequirementFactory
- [x] Write feature tests for CRUD operations
- [x] Write unit tests for coverage calculations

## Schedule View Integration

### Week View
- Coverage summary shown above schedule for admins
- Shows count of understaffed/overstaffed/adequate
- Expandable details panel showing specific issues
- Issues grouped by role, day, and time window

### Day View
- Coverage badges shown for each time slot requirement
- Color-coded by status (green/yellow/red)
- Shows scheduled vs required counts

## Dependencies

- BusinessRole model
- Location model
- Department model
- Tenant model
- Schedule week and day views
- AI Scheduling system (for constraint integration - future)
