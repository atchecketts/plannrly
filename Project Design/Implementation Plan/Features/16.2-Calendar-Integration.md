# Feature 16.2: Calendar Integration

**Status:** Not Started
**Effort:** Medium
**Phase:** 16 - Scheduling Enhancements

## Overview

Sync schedules to personal calendars via iCal feeds. Each user gets a unique URL that can be subscribed to in Google Calendar, Apple Calendar, Outlook, or any calendar app that supports iCal.

## Requirements

### Functional Requirements
- Generate unique iCal feed URL per user
- Generate ICS format for shifts
- Include shift details (location, role, notes)
- Auto-update feed when schedule changes
- Regenerate feed URL if compromised
- Calendar settings management UI

### iCal Event Details
- Event title: Role name or shift description
- Start/end time: Shift times
- Location: Work location if set
- Description: Shift notes, instructions
- Organizer: Tenant name

### UI Components
- Calendar sync settings page
- Unique feed URL display
- Copy URL button
- Regenerate URL button
- Calendar app instructions

## Files

### To Create
- `app/Http/Controllers/CalendarFeedController.php` - Controller
- `app/Services/ICalService.php` - ICS generation service
- `database/migrations/xxxx_add_calendar_token_to_users_table.php`
- `resources/views/settings/calendar-sync.blade.php` - Settings view
- `tests/Feature/CalendarIntegrationTest.php` - Feature tests

### Routes
```php
// Settings
Route::get('settings/calendar', [CalendarFeedController::class, 'settings'])->name('settings.calendar');
Route::post('settings/calendar/regenerate', [CalendarFeedController::class, 'regenerate'])->name('settings.calendar.regenerate');

// Public feed (no auth, uses token)
Route::get('calendar/{token}.ics', [CalendarFeedController::class, 'feed'])->name('calendar.feed');
```

## Database Schema

### users table update
```php
Schema::table('users', function (Blueprint $table) {
    $table->string('calendar_token', 64)->nullable()->unique();
    $table->timestamp('calendar_token_created_at')->nullable();
});
```

## ICS Format Example

```ics
BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Plannrly//Shift Calendar//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
X-WR-CALNAME:My Work Schedule
BEGIN:VEVENT
UID:shift-123@plannrly.com
DTSTART:20240115T090000Z
DTEND:20240115T170000Z
SUMMARY:Morning Shift - Cashier
LOCATION:Main Store
DESCRIPTION:Notes: Stock check required
ORGANIZER;CN=Acme Corp:mailto:noreply@plannrly.com
END:VEVENT
END:VCALENDAR
```

## Tasks

- [ ] Create unique iCal feed URL per user
- [ ] Generate ICS format for shifts
- [ ] Include shift details (location, role, notes)
- [ ] Auto-update feed when schedule changes
- [ ] Add feed regeneration if URL compromised
- [ ] Create calendar settings UI
- [ ] Add feed URL copy button
- [ ] Write tests

## Tests

Suggested tests for `tests/Feature/CalendarIntegrationTest.php`:

1. `test_user_can_view_calendar_settings`
2. `test_calendar_token_is_generated_on_first_access`
3. `test_ics_feed_returns_valid_icalendar`
4. `test_feed_includes_user_shifts`
5. `test_feed_includes_shift_details`
6. `test_feed_excludes_other_users_shifts`
7. `test_invalid_token_returns_404`
8. `test_user_can_regenerate_calendar_token`
9. `test_old_token_stops_working_after_regeneration`
10. `test_feed_updates_when_schedule_changes`

## Dependencies

- User model
- Shift model with relationships
- Location model (if available)
- iCal library (spatie/icalendar-generator or manual generation)
