# Feature 3.8: Timesheet Export

**Status:** Complete
**Effort:** Medium
**Phase:** 3 - Time & Attendance
**Completed:** January 2026

## Overview

Export timesheets for payroll processing. This feature allows managers to export timesheet data in various formats suitable for integration with payroll systems or for record-keeping purposes.

## Requirements

### Functional Requirements
- Multiple export formats (CSV detailed, CSV payroll)
- Configurable date range (weekly)
- Filter by employee, department, location
- Include all relevant timesheet data
- Employee can export only their own data
- Admins can export payroll-ready format

### Export Formats
| Format | Description |
|--------|-------------|
| Detailed CSV | Full timesheet data with all columns |
| Payroll CSV | Simplified format for payroll systems |

### Export Data Columns (Detailed)
- Employee name
- Employee email
- Date
- Scheduled start/end
- Actual start/end
- Scheduled hours
- Actual hours
- Variance
- Break time
- Department
- Location
- Role
- Status
- Approved by
- Approved at
- Notes

### Export Data Columns (Payroll)
- Employee ID
- Employee name
- Date
- Hours worked
- Overtime hours
- Break hours
- Status

## Implementation

### Files Created
- `app/Services/TimesheetExportService.php` - Export data generation and CSV formatting
- `tests/Feature/TimesheetExportTest.php` - 10 tests

### Files Modified
- `app/Http/Controllers/TimesheetController.php` - Added export and exportPayroll methods
- `routes/web.php` - Added export routes
- `resources/views/timesheets/index.blade.php` - Added export dropdown button
- `resources/views/timesheets/employee.blade.php` - Added export button

## Tasks

- [x] Create TimesheetExportService
- [x] Implement getExportData method with filters
- [x] Implement exportToCsv method (detailed format)
- [x] Implement exportToPayrollCsv method (simplified payroll format)
- [x] Implement getExportSummary for statistics
- [x] Add export routes to web.php
- [x] Add export method to TimesheetController
- [x] Add exportPayroll method (admin only)
- [x] Add export dropdown to admin timesheet view
- [x] Add export button to employee timesheet view
- [x] Write comprehensive tests

## Routes

```php
GET /timesheets/export          - timesheets.export (CSV detailed)
GET /timesheets/export/payroll  - timesheets.export.payroll (CSV payroll, admin only)
```

## Controller Methods

```php
TimesheetController:
- export(Request $request): Response
  - Exports detailed CSV
  - Respects user role (employee vs admin)
  - Filters by week_start, user_id, department_id, location_id

- exportPayroll(Request $request): Response
  - Exports payroll-friendly CSV
  - Admin only (403 for employees)
  - Same filters as export
```

## Service Methods

```php
TimesheetExportService:
- getExportData($startDate, $endDate, $userId, $departmentId, $locationId): Collection
- exportToCsv(Collection $entries): string
- exportToPayrollCsv(Collection $entries): string
- getExportSummary(Collection $entries): array
```

## Security Considerations

- Employees can only export their own timesheets
- user_id filter is ignored for employees (forced to their own ID)
- Payroll export is admin-only
- Tenant isolation is enforced through TenantScope

## UI Integration

### Admin Timesheet View
- Export dropdown with two options:
  - "Detailed CSV" - Full timesheet export
  - "Payroll CSV" - Simplified payroll format
- Exports respect current filters (week, user, department)

### Employee Timesheet View
- Single "Export CSV" button
- Exports only their own timesheets for selected week

## Testing

The test suite covers:
- Admin can export timesheets as CSV
- Employee can export their own timesheets
- Employee cannot export other users' timesheets
- Admin can export payroll CSV
- Employee cannot export payroll CSV
- Export filters by department correctly
- Export service generates correct CSV format
- Export service calculates summary correctly
- Export empty week returns headers only
- Tenant isolation for exports

## Dependencies

- TimeEntry model
- Shift model
- User model
- Feature 3.4 (Timesheet Views)
