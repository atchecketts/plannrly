# Feature 24.2: Team Messaging System

**Status:** Not Started
**Effort:** Large
**Phase:** 24 - Delegation & Messaging

## Overview

Built-in messaging system with direct messages, group conversations, and announcements. This enables team communication within Plannrly, reducing the need for external communication tools and keeping work-related conversations in one place.

## Requirements

### Functional Requirements
- Direct messaging between users
- Group conversations
- Organization-wide announcements
- Read receipts and acknowledgements
- Unread counts in navigation
- Real-time message delivery
- Message search

### Message Types
- **Direct Message** - One-to-one conversation
- **Group Conversation** - Multiple participants
- **Announcement** - One-way communication requiring acknowledgement

### Announcement Features
- Target: All employees, location, department, or role
- Require acknowledgement option
- Track who has/hasn't acknowledged
- Priority levels (normal, important, urgent)
- Scheduled publication

## Files

### To Create
- `app/Models/Conversation.php`
- `app/Models/ConversationParticipant.php`
- `app/Models/Message.php`
- `app/Models/MessageRead.php`
- `app/Models/Announcement.php`
- `app/Models/AnnouncementAcknowledgement.php`
- `app/Services/MessagingService.php`
- `app/Services/AnnouncementService.php`
- `app/Http/Controllers/ConversationController.php`
- `app/Http/Controllers/MessageController.php`
- `app/Http/Controllers/AnnouncementController.php`
- `app/Events/MessageSent.php`
- `app/Events/AnnouncementPublished.php`
- `app/Notifications/NewMessageNotification.php`
- `app/Notifications/NewAnnouncementNotification.php`
- `resources/views/messages/index.blade.php`
- `resources/views/messages/conversation.blade.php`
- `resources/views/messages/new.blade.php`
- `resources/views/announcements/index.blade.php`
- `resources/views/announcements/create.blade.php`
- `resources/views/announcements/show.blade.php`
- `resources/views/announcements/acknowledgements.blade.php`
- `resources/views/components/message-bubble.blade.php`
- `resources/views/components/unread-badge.blade.php`
- `database/migrations/xxxx_create_conversations_table.php`
- `database/migrations/xxxx_create_conversation_participants_table.php`
- `database/migrations/xxxx_create_messages_table.php`
- `database/migrations/xxxx_create_message_reads_table.php`
- `database/migrations/xxxx_create_announcements_table.php`
- `database/migrations/xxxx_create_announcement_acknowledgements_table.php`
- `tests/Feature/MessagingTest.php`
- `tests/Feature/AnnouncementTest.php`

### Routes
```php
// Conversations and messages
Route::prefix('messages')->name('messages.')->group(function () {
    Route::get('/', [ConversationController::class, 'index'])->name('index');
    Route::get('new', [ConversationController::class, 'create'])->name('create');
    Route::post('/', [ConversationController::class, 'store'])->name('store');
    Route::get('{conversation}', [ConversationController::class, 'show'])->name('show');
    Route::post('{conversation}/messages', [MessageController::class, 'store'])->name('send');
    Route::post('{conversation}/read', [MessageController::class, 'markRead'])->name('mark-read');
    Route::get('unread-count', [MessageController::class, 'unreadCount'])->name('unread-count');
});

// Announcements
Route::prefix('announcements')->name('announcements.')->group(function () {
    Route::get('/', [AnnouncementController::class, 'index'])->name('index');
    Route::get('create', [AnnouncementController::class, 'create'])->name('create');
    Route::post('/', [AnnouncementController::class, 'store'])->name('store');
    Route::get('{announcement}', [AnnouncementController::class, 'show'])->name('show');
    Route::post('{announcement}/acknowledge', [AnnouncementController::class, 'acknowledge'])->name('acknowledge');
    Route::get('{announcement}/acknowledgements', [AnnouncementController::class, 'acknowledgements'])->name('acknowledgements');
    Route::delete('{announcement}', [AnnouncementController::class, 'destroy'])->name('destroy');
});
```

## Database Schema

### conversations
| Column | Type | Description |
|--------|------|-------------|
| id | bigint | Primary key |
| tenant_id | bigint | Foreign key to tenants |
| type | string | direct, group |
| name | string | Group name (null for direct) |
| created_by | bigint | User who created |
| last_message_at | timestamp | For sorting |
| created_at | timestamp | |
| updated_at | timestamp | |

### conversation_participants
| Column | Type | Description |
|--------|------|-------------|
| id | bigint | Primary key |
| conversation_id | bigint | Foreign key |
| user_id | bigint | Participant user |
| joined_at | timestamp | When joined |
| left_at | timestamp | When left (null if active) |
| is_admin | boolean | Can manage group |
| created_at | timestamp | |
| updated_at | timestamp | |

### messages
| Column | Type | Description |
|--------|------|-------------|
| id | bigint | Primary key |
| conversation_id | bigint | Foreign key |
| user_id | bigint | Sender |
| body | text | Message content |
| attachment_path | string | Optional attachment |
| attachment_name | string | Original filename |
| edited_at | timestamp | If edited |
| deleted_at | timestamp | Soft delete |
| created_at | timestamp | |
| updated_at | timestamp | |

### message_reads
| Column | Type | Description |
|--------|------|-------------|
| id | bigint | Primary key |
| message_id | bigint | Foreign key |
| user_id | bigint | Who read it |
| read_at | timestamp | When read |

### announcements
| Column | Type | Description |
|--------|------|-------------|
| id | bigint | Primary key |
| tenant_id | bigint | Foreign key |
| user_id | bigint | Author |
| title | string | Announcement title |
| body | text | Announcement content |
| priority | string | normal, important, urgent |
| target_type | string | all, location, department, role |
| target_ids | json | IDs of targeted entities |
| requires_acknowledgement | boolean | Must acknowledge |
| published_at | timestamp | When published |
| expires_at | timestamp | When to hide |
| created_at | timestamp | |
| updated_at | timestamp | |

### announcement_acknowledgements
| Column | Type | Description |
|--------|------|-------------|
| id | bigint | Primary key |
| announcement_id | bigint | Foreign key |
| user_id | bigint | Who acknowledged |
| acknowledged_at | timestamp | When acknowledged |

## Real-Time Messaging

Using Laravel Echo and Pusher/Soketi:

```javascript
// Subscribe to conversation
Echo.private(`conversation.${conversationId}`)
    .listen('MessageSent', (e) => {
        this.messages.push(e.message);
        this.scrollToBottom();
    });

// Subscribe to announcements
Echo.private(`tenant.${tenantId}`)
    .listen('AnnouncementPublished', (e) => {
        this.showAnnouncementBanner(e.announcement);
    });
```

## Messaging Service

```php
class MessagingService
{
    public function createDirectConversation(User $user1, User $user2): Conversation;

    public function createGroupConversation(
        User $creator,
        array $participantIds,
        string $name
    ): Conversation;

    public function sendMessage(
        Conversation $conversation,
        User $sender,
        string $body,
        ?UploadedFile $attachment = null
    ): Message;

    public function markConversationRead(Conversation $conversation, User $user): void;

    public function getUnreadCount(User $user): int;

    public function searchMessages(User $user, string $query): Collection;
}
```

## Tasks

- [ ] Create conversation migrations
- [ ] Create message migrations
- [ ] Create announcement migrations
- [ ] Create Conversation model with relationships
- [ ] Create ConversationParticipant model
- [ ] Create Message model
- [ ] Create MessageRead model
- [ ] Create Announcement model
- [ ] Create AnnouncementAcknowledgement model
- [ ] Create MessagingService
- [ ] Create AnnouncementService
- [ ] Create ConversationController
- [ ] Create MessageController
- [ ] Create AnnouncementController
- [ ] Create MessageSent event
- [ ] Create AnnouncementPublished event
- [ ] Set up Laravel Echo broadcasting
- [ ] Create conversation list UI
- [ ] Create conversation view with messages
- [ ] Create new conversation/message UI
- [ ] Create group conversation management
- [ ] Create announcement list UI
- [ ] Create announcement posting UI
- [ ] Create acknowledgement tracking UI
- [ ] Add unread counts to navigation
- [ ] Create NewMessageNotification
- [ ] Create NewAnnouncementNotification
- [ ] Implement message search
- [ ] Write messaging tests
- [ ] Write announcement tests

## Tests

### tests/Feature/MessagingTest.php
1. `test_user_can_view_conversations`
2. `test_user_can_create_direct_conversation`
3. `test_user_can_send_message`
4. `test_message_marked_read_on_view`
5. `test_unread_count_accurate`
6. `test_user_can_create_group_conversation`
7. `test_user_can_add_participant_to_group`
8. `test_user_can_leave_group`
9. `test_message_event_broadcast`
10. `test_cannot_message_user_in_different_tenant`

### tests/Feature/AnnouncementTest.php
1. `test_admin_can_create_announcement`
2. `test_employee_cannot_create_announcement`
3. `test_announcement_visible_to_target_audience`
4. `test_user_can_acknowledge_announcement`
5. `test_acknowledgement_tracked`
6. `test_admin_can_view_acknowledgement_status`
7. `test_urgent_announcement_shows_banner`
8. `test_scheduled_announcement_publishes_at_time`
9. `test_expired_announcement_hidden`

## Dependencies

- Laravel Echo (broadcasting)
- Pusher or Soketi (WebSocket server)
- User model
- Tenant model
- Location/Department models (for targeting)
- File storage (for attachments)
- Queue system (for notifications)
