# Feature 12.3: Payment Method Management

**Status:** Not Started
**Effort:** Medium
**Phase:** 12 - Stripe Payment Integration

## Overview

Update and manage payment methods. This feature allows customers to add, update, and remove payment methods used for their subscription billing.

## Requirements

### Functional Requirements
- Payment method update form
- Stripe Elements for secure card input
- Add new payment method
- Set default payment method
- Remove old payment methods
- Display card last 4 digits and expiry

### Technical Requirements
- Stripe.js integration
- PCI compliant card handling
- Secure token exchange

## Files

### Created/Modified
- `resources/views/subscription/payment-method.blade.php` - Payment method management

### Routes
```php
Route::middleware('auth')->prefix('subscription')->group(function () {
    Route::get('/payment-method', [PaymentMethodController::class, 'edit'])
        ->name('subscription.payment-method');
    Route::post('/payment-method', [PaymentMethodController::class, 'update'])
        ->name('subscription.payment-method.update');
    Route::delete('/payment-method/{id}', [PaymentMethodController::class, 'destroy'])
        ->name('subscription.payment-method.destroy');
    Route::post('/payment-method/{id}/default', [PaymentMethodController::class, 'setDefault'])
        ->name('subscription.payment-method.default');
});
```

## Tasks

- [ ] Create payment method update form
- [ ] Implement Stripe Elements for card input
- [ ] Allow adding new payment method
- [ ] Set default payment method
- [ ] Remove old payment methods
- [ ] Show card last 4 digits and expiry
- [ ] Write tests

## Tests

Tests to be created in `tests/Feature/PaymentMethodTest.php`:

1. `test_payment_method_page_loads`
2. `test_user_can_add_payment_method`
3. `test_user_can_set_default_payment_method`
4. `test_user_can_remove_payment_method`
5. `test_payment_methods_display_correctly`
6. `test_cannot_remove_only_payment_method`

## Dependencies

- Feature 12.1: Stripe Setup & Customer Management
- Stripe.js library

## Notes

### Stripe Elements Integration
```html
<div id="card-element"></div>
<button id="submit">Update Payment Method</button>

<script src="https://js.stripe.com/v3/"></script>
<script>
const stripe = Stripe('{{ config('services.stripe.key') }}');
const elements = stripe.elements();
const cardElement = elements.create('card');
cardElement.mount('#card-element');

document.getElementById('submit').addEventListener('click', async () => {
    const { setupIntent, error } = await stripe.confirmCardSetup(
        '{{ $intent->client_secret }}',
        {
            payment_method: {
                card: cardElement,
            }
        }
    );

    if (error) {
        // Handle error
    } else {
        // Submit to server
    }
});
</script>
```

### Controller Implementation
```php
public function edit(Request $request)
{
    $tenant = $request->user()->tenant;

    return view('subscription.payment-method', [
        'intent' => $tenant->createSetupIntent(),
        'paymentMethods' => $tenant->paymentMethods(),
        'defaultMethod' => $tenant->defaultPaymentMethod(),
    ]);
}

public function update(Request $request)
{
    $tenant = $request->user()->tenant;
    $tenant->addPaymentMethod($request->payment_method);
    $tenant->updateDefaultPaymentMethod($request->payment_method);

    return redirect()->back()->with('success', 'Payment method updated');
}
```

### Display Payment Methods
```php
@foreach($paymentMethods as $method)
    <div>
        {{ ucfirst($method->card->brand) }} ending in {{ $method->card->last4 }}
        Expires {{ $method->card->exp_month }}/{{ $method->card->exp_year }}
        @if($method->id === $defaultMethod?->id)
            <span>Default</span>
        @endif
    </div>
@endforeach
```
