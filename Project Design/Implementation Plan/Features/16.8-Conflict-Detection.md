# Feature 16.8: Conflict Detection & Warnings

**Status:** Not Started
**Effort:** Medium
**Phase:** 16 - Scheduling Enhancements

## Overview

Proactive alerts for scheduling issues. When creating or editing shifts, the system detects conflicts and warnings, allowing managers to address issues or acknowledge them.

## Requirements

### Functional Requirements
- Detect leave conflicts
- Detect availability conflicts
- Detect rest period violations
- Detect overtime warnings
- Detect qualification gaps
- Show warnings in schedule view
- Require acknowledgment for warnings
- Suggest fixes for detected conflicts
- Log overridden warnings

### Conflict Types
| Type | Severity | Description |
|------|----------|-------------|
| Leave | Error | User is on approved leave |
| Availability | Warning | Outside declared availability |
| Rest Period | Warning | Less than 11h between shifts |
| Overtime | Warning | Would exceed weekly hours limit |
| Qualification | Error | User lacks required role |
| Double Booking | Error | Already scheduled at same time |

### UI Components
- Warning indicators on shifts in calendar
- Conflict list panel
- Acknowledge button with reason
- "Fix All" suggestions
- Conflict details modal

## Files

### To Create
- `app/Services/ConflictDetectionService.php` - Detection logic
- `app/DTOs/ScheduleConflict.php` - Conflict data object
- `database/migrations/xxxx_create_conflict_acknowledgments_table.php`
- `tests/Feature/ConflictDetectionTest.php` - Feature tests

### Routes
```php
Route::post('schedule/check-conflicts', [ScheduleController::class, 'checkConflicts'])->name('schedule.check-conflicts');
Route::post('schedule/acknowledge-conflict', [ScheduleController::class, 'acknowledgeConflict'])->name('schedule.acknowledge-conflict');
```

## ScheduleConflict DTO

```php
class ScheduleConflict
{
    public function __construct(
        public string $type,        // leave, availability, rest, overtime, qualification, double_booking
        public string $severity,    // error, warning
        public Shift $shift,
        public User $user,
        public string $message,
        public ?string $suggestion,
        public array $metadata = [],
    ) {}
}
```

## Database Schema

### conflict_acknowledgments
```php
Schema::create('conflict_acknowledgments', function (Blueprint $table) {
    $table->id();
    $table->foreignId('tenant_id')->constrained()->cascadeOnDelete();
    $table->foreignId('shift_id')->constrained()->cascadeOnDelete();
    $table->foreignId('user_id')->constrained()->cascadeOnDelete(); // Affected user
    $table->string('conflict_type');
    $table->text('reason'); // Why manager is overriding
    $table->foreignId('acknowledged_by')->constrained('users')->cascadeOnDelete();
    $table->timestamps();
});
```

## Detection Rules

```php
// Leave conflict
if ($user->leaveRequests()->approved()->overlapping($shift)->exists()) {
    // Conflict: User is on approved leave
}

// Availability conflict
if (!$user->isAvailableDuring($shift->start_time, $shift->end_time)) {
    // Warning: Outside availability
}

// Rest period violation
$previousShift = $user->shifts()->before($shift->start_time)->latest()->first();
if ($previousShift && $shift->start_time->diffInHours($previousShift->end_time) < 11) {
    // Warning: Less than 11h rest
}

// Overtime
$weeklyHours = $user->getScheduledHoursForWeek($shift->start_time);
if ($weeklyHours + $shift->duration > 48) {
    // Warning: Would exceed 48h/week
}
```

## Tasks

- [ ] Create ConflictDetectionService
- [ ] Detect leave conflicts
- [ ] Detect availability conflicts
- [ ] Detect rest period violations
- [ ] Detect overtime warnings
- [ ] Detect qualification gaps
- [ ] Show warnings in schedule view
- [ ] Require acknowledgment for warnings
- [ ] Add "Fix All" suggestions
- [ ] Log overridden warnings
- [ ] Write tests

## Tests

Suggested tests for `tests/Feature/ConflictDetectionTest.php`:

1. `test_leave_conflict_is_detected`
2. `test_availability_conflict_is_detected`
3. `test_rest_period_violation_is_detected`
4. `test_overtime_warning_is_detected`
5. `test_qualification_gap_is_detected`
6. `test_double_booking_is_detected`
7. `test_conflicts_are_shown_in_schedule_view`
8. `test_admin_can_acknowledge_warning`
9. `test_acknowledgment_requires_reason`
10. `test_acknowledged_warning_is_logged`
11. `test_fix_suggestions_are_provided`

## Dependencies

- Shift model
- User model
- LeaveRequest model
- Availability model
- BusinessRole model
- Working time compliance rules
