# Feature 14.1: Two-Factor Authentication (2FA)

**Status:** Not Started
**Effort:** Large
**Phase:** 14 - Security Features

## Overview

Optional two-factor authentication for enhanced account security. Users can enable TOTP-based 2FA using authenticator apps, with recovery codes as a backup method and trusted device functionality.

## Requirements

### Functional Requirements
- Enable/disable 2FA per user account
- Generate QR codes for authenticator app setup
- Generate and encrypt recovery codes
- Challenge users for 2FA during login
- "Trust this device" functionality to skip 2FA on known devices
- Tenant-level setting for mandatory 2FA per role
- Recovery code verification flow

### UI Components
- 2FA setup wizard with QR code display
- Recovery codes display and download
- 2FA challenge screen during login
- "Trust this device" checkbox
- 2FA management in user settings
- Trusted devices list

## Files

### To Create
- `app/Services/TwoFactorAuthService.php` - 2FA logic
- `app/Http/Controllers/TwoFactorController.php` - Controller
- `app/Models/TwoFactorAuthentication.php` - 2FA settings model
- `app/Models/TrustedDevice.php` - Trusted devices model
- `database/migrations/xxxx_create_two_factor_authentications_table.php`
- `database/migrations/xxxx_create_trusted_devices_table.php`
- `resources/views/settings/two-factor.blade.php` - Settings view
- `resources/views/auth/two-factor-challenge.blade.php` - Login challenge
- `tests/Feature/TwoFactorAuthenticationTest.php` - Feature tests

### Routes
```php
// Settings
Route::get('settings/two-factor', [TwoFactorController::class, 'index'])->name('settings.two-factor');
Route::post('settings/two-factor/enable', [TwoFactorController::class, 'enable'])->name('settings.two-factor.enable');
Route::post('settings/two-factor/verify', [TwoFactorController::class, 'verify'])->name('settings.two-factor.verify');
Route::post('settings/two-factor/disable', [TwoFactorController::class, 'disable'])->name('settings.two-factor.disable');
Route::post('settings/two-factor/regenerate-recovery', [TwoFactorController::class, 'regenerateRecovery'])->name('settings.two-factor.regenerate-recovery');
Route::delete('settings/trusted-devices/{device}', [TwoFactorController::class, 'removeTrustedDevice'])->name('settings.trusted-devices.destroy');

// Auth challenge
Route::get('two-factor-challenge', [TwoFactorController::class, 'challenge'])->name('two-factor.challenge');
Route::post('two-factor-challenge', [TwoFactorController::class, 'verifyChallenge'])->name('two-factor.verify');
Route::post('two-factor-challenge/recovery', [TwoFactorController::class, 'verifyRecovery'])->name('two-factor.verify-recovery');
```

## Database Schema

### two_factor_authentications
```php
Schema::create('two_factor_authentications', function (Blueprint $table) {
    $table->id();
    $table->foreignId('user_id')->constrained()->cascadeOnDelete();
    $table->text('secret'); // Encrypted TOTP secret
    $table->text('recovery_codes'); // Encrypted JSON array
    $table->timestamp('confirmed_at')->nullable();
    $table->timestamps();
});
```

### trusted_devices
```php
Schema::create('trusted_devices', function (Blueprint $table) {
    $table->id();
    $table->foreignId('user_id')->constrained()->cascadeOnDelete();
    $table->string('device_name');
    $table->string('device_token', 64)->unique();
    $table->string('ip_address')->nullable();
    $table->string('user_agent')->nullable();
    $table->timestamp('last_used_at');
    $table->timestamps();
});
```

## Tasks

- [ ] Create database migrations for 2FA tables
- [ ] Install TOTP library (e.g., pragmarx/google2fa-laravel)
- [ ] Create TwoFactorAuthService with enable/verify/disable methods
- [ ] Generate QR codes for authenticator apps
- [ ] Generate and encrypt recovery codes
- [ ] Create 2FA setup wizard UI
- [ ] Create 2FA challenge screen during login
- [ ] Implement "Trust this device" functionality
- [ ] Add tenant setting for mandatory 2FA per role
- [ ] Add recovery code verification flow
- [ ] Write comprehensive tests

## Tests

Suggested tests for `tests/Feature/TwoFactorAuthenticationTest.php`:

1. `test_user_can_enable_two_factor_authentication`
2. `test_user_can_view_qr_code_during_setup`
3. `test_user_must_verify_code_to_complete_setup`
4. `test_recovery_codes_are_generated_on_enable`
5. `test_user_is_challenged_for_2fa_during_login`
6. `test_valid_totp_code_passes_challenge`
7. `test_invalid_totp_code_fails_challenge`
8. `test_recovery_code_can_be_used`
9. `test_recovery_code_is_invalidated_after_use`
10. `test_trusted_device_skips_2fa_challenge`
11. `test_user_can_disable_two_factor_authentication`
12. `test_user_can_remove_trusted_device`
13. `test_user_can_regenerate_recovery_codes`
14. `test_mandatory_2fa_is_enforced_per_role`

## Dependencies

- User model
- TOTP library (pragmarx/google2fa-laravel)
- QR code generation library
- Encryption for secrets and recovery codes
