# Feature 6.2: Employee HR Records (Admin)

**Status:** Complete
**Effort:** Large
**Phase:** 6 - Employee Management
**Completed:** January 2026

## Overview

Comprehensive employment records management for administrators. This feature allows admins to track employment details, pay information, working hour constraints, and HR notes for each employee.

## Requirements

### Functional Requirements
- Track employment start/end dates and probation period
- Track employment status (active, on leave, suspended, notice period, terminated)
- Configure pay type (hourly or salaried) and rates
- Set per-employee hourly rates for each assigned business role
- Set target, minimum, and maximum hours per week
- Mark employees as overtime eligible
- Store private HR notes
- Display employment status badges on user list
- Show employees on notice period or leaving soon on dashboard

### Business Rules
- Pay rate hierarchy: role-specific rate > user base rate > role default rate
- Employment details are admin-only (employees see read-only view)
- HR notes are private and only visible to admins
- Employment status changes should be auditable

### Database Schema
```sql
CREATE TABLE user_employment_details (
    id BIGINT UNSIGNED PRIMARY KEY,
    user_id BIGINT UNSIGNED UNIQUE,
    employment_start_date DATE,
    employment_end_date DATE NULL,
    final_working_date DATE NULL,
    probation_end_date DATE NULL,
    employment_status ENUM('active', 'on_leave', 'suspended', 'notice_period', 'terminated'),
    pay_type ENUM('hourly', 'salaried'),
    base_hourly_rate DECIMAL(10,2) NULL,
    annual_salary DECIMAL(12,2) NULL,
    currency VARCHAR(3) DEFAULT 'GBP',
    target_hours_per_week DECIMAL(5,2) NULL,
    min_hours_per_week DECIMAL(5,2) NULL,
    max_hours_per_week DECIMAL(5,2) NULL,
    overtime_eligible BOOLEAN DEFAULT FALSE,
    notes TEXT NULL,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

## Files

### To Create
- `database/migrations/xxxx_create_user_employment_details_table.php`
- `app/Models/UserEmploymentDetails.php`
- `app/Enums/EmploymentStatus.php`
- `app/Enums/PayType.php`
- `app/Http/Controllers/EmploymentDetailsController.php`
- `app/Http/Requests/Employment/UpdateEmploymentDetailsRequest.php`
- `app/Policies/UserEmploymentDetailsPolicy.php`
- `resources/views/users/employment.blade.php`
- `resources/views/users/partials/employment-form.blade.php`
- `tests/Feature/EmploymentDetailsTest.php`

### Routes
```php
Route::get('users/{user}/employment', [EmploymentDetailsController::class, 'edit'])->name('users.employment.edit');
Route::put('users/{user}/employment', [EmploymentDetailsController::class, 'update'])->name('users.employment.update');
```

## Tasks

- [x] Create migration for user_employment_details table
- [x] Create UserEmploymentDetails model with casts and accessors
- [x] Create EmploymentStatus enum
- [x] Create PayType enum
- [x] Create UserEmploymentDetailsPolicy
- [x] Create EmploymentDetailsController
- [x] Create employment details form
- [x] Add role-specific hourly rates section to employment form
- [x] Implement pay rate hierarchy logic (getEffectiveHourlyRate method)
- [x] Add employment status badges to user list
- [x] Show employees on notice period/leaving soon on dashboard
- [x] Display hourly rates per role on user show and profile pages
- [ ] Create report for employment status overview
- [x] Write tests

## Tests

Tests to be created in `tests/Feature/EmploymentDetailsTest.php`:

1. `test_admin_can_view_employment_details_form`
2. `test_employee_cannot_view_employment_details_form`
3. `test_admin_can_update_employment_details`
4. `test_employment_status_enum_values_are_valid`
5. `test_pay_type_enum_values_are_valid`
6. `test_pay_rate_hierarchy_uses_role_specific_rate_first`
7. `test_pay_rate_hierarchy_falls_back_to_user_base_rate`
8. `test_pay_rate_hierarchy_falls_back_to_role_default_rate`
9. `test_employment_status_badges_show_on_user_list`
10. `test_dashboard_shows_employees_on_notice_period`
11. `test_dashboard_shows_employees_leaving_soon`
12. `test_hr_notes_are_only_visible_to_admins`
13. `test_employment_form_shows_role_specific_rates_section`
14. `test_admin_can_set_role_specific_hourly_rate`
15. `test_clearing_role_rate_sets_it_to_null`
16. `test_effective_hourly_rate_returns_custom_rate_when_set`
17. `test_effective_hourly_rate_falls_back_to_default_when_null`
18. `test_user_show_page_displays_role_hourly_rates`
19. `test_role_rate_validation_rejects_invalid_values`

## Dependencies

- User model
- BusinessRole model
- user_business_roles pivot table (with hourly_rate column)
