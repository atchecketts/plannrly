# Feature 21.3: Partner/Reseller Program

**Status:** Not Started
**Effort:** Large
**Phase:** 21 - Business Model

## Overview

Enable partners to refer and resell Plannrly subscriptions. Partners earn commission on referred customers, with a dedicated dashboard to track referrals, earnings, and request payouts.

## Requirements

### Partner Types
- **Affiliate** - Refer customers, earn commission
- **Reseller** - White-label sales, bulk pricing
- **Integration Partner** - Technical integrations, co-marketing

### Commission Structure
- Affiliates: 20% of first year revenue
- Resellers: 30% recurring commission
- Custom rates for enterprise partners

### Functional Requirements
- Partner registration and approval workflow
- Unique referral codes/links
- Track referrals to tenant signups
- Calculate commission based on revenue
- Partner dashboard with analytics
- Payout request system
- Marketing materials access

## Files

### To Create
- `app/Models/Partner.php`
- `app/Models/PartnerReferral.php`
- `app/Models/PartnerPayout.php`
- `app/Services/PartnerService.php`
- `app/Services/CommissionCalculationService.php`
- `app/Http/Controllers/PartnerController.php`
- `app/Http/Controllers/PartnerDashboardController.php`
- `app/Http/Requests/Partner/RegisterPartnerRequest.php`
- `app/Http/Requests/Partner/PayoutRequestRequest.php`
- `app/Http/Middleware/TrackReferral.php`
- `app/Notifications/PartnerApprovedNotification.php`
- `app/Notifications/ReferralConvertedNotification.php`
- `app/Notifications/PayoutProcessedNotification.php`
- `resources/views/partner/register.blade.php`
- `resources/views/partner/dashboard.blade.php`
- `resources/views/partner/referrals.blade.php`
- `resources/views/partner/payouts.blade.php`
- `resources/views/partner/materials.blade.php`
- `resources/views/admin/partners/index.blade.php`
- `resources/views/admin/partners/show.blade.php`
- `database/migrations/xxxx_create_partners_table.php`
- `database/migrations/xxxx_create_partner_referrals_table.php`
- `database/migrations/xxxx_create_partner_payouts_table.php`
- `tests/Feature/PartnerProgramTest.php`

### Routes
```php
// Public partner registration
Route::get('partner/register', [PartnerController::class, 'register'])->name('partner.register');
Route::post('partner/register', [PartnerController::class, 'store'])->name('partner.store');

// Partner dashboard (authenticated partners)
Route::prefix('partner')->name('partner.')->middleware('auth:partner')->group(function () {
    Route::get('dashboard', [PartnerDashboardController::class, 'index'])->name('dashboard');
    Route::get('referrals', [PartnerDashboardController::class, 'referrals'])->name('referrals');
    Route::get('payouts', [PartnerDashboardController::class, 'payouts'])->name('payouts');
    Route::post('payouts/request', [PartnerDashboardController::class, 'requestPayout'])->name('payouts.request');
    Route::get('materials', [PartnerDashboardController::class, 'materials'])->name('materials');
    Route::get('link', [PartnerDashboardController::class, 'getLink'])->name('link');
});

// Admin partner management
Route::prefix('admin/partners')->name('admin.partners.')->group(function () {
    Route::get('/', [AdminPartnerController::class, 'index'])->name('index');
    Route::get('{partner}', [AdminPartnerController::class, 'show'])->name('show');
    Route::post('{partner}/approve', [AdminPartnerController::class, 'approve'])->name('approve');
    Route::post('{partner}/reject', [AdminPartnerController::class, 'reject'])->name('reject');
    Route::post('payouts/{payout}/process', [AdminPartnerController::class, 'processPayout'])->name('process-payout');
});
```

## Database Schema

### partners
| Column | Type | Description |
|--------|------|-------------|
| id | bigint | Primary key |
| user_id | bigint | Optional link to user account |
| type | string | affiliate, reseller, integration |
| company_name | string | Partner company name |
| contact_name | string | Primary contact |
| email | string | Contact email |
| phone | string | Contact phone |
| website | string | Partner website |
| referral_code | string | Unique referral code |
| commission_rate | decimal | Commission percentage |
| status | string | pending, approved, rejected, suspended |
| approved_at | timestamp | When partner was approved |
| payout_method | string | paypal, bank_transfer, stripe |
| payout_details | json | Payment account details |
| total_referrals | integer | Denormalized count |
| total_revenue | decimal | Total revenue generated |
| total_earned | decimal | Total commission earned |
| total_paid | decimal | Total payouts processed |
| created_at | timestamp | |
| updated_at | timestamp | |

### partner_referrals
| Column | Type | Description |
|--------|------|-------------|
| id | bigint | Primary key |
| partner_id | bigint | Foreign key to partners |
| tenant_id | bigint | Foreign key to tenants |
| referral_code | string | Code used at signup |
| status | string | pending, converted, cancelled |
| converted_at | timestamp | When tenant subscribed |
| revenue | decimal | Revenue from this referral |
| commission | decimal | Commission earned |
| commission_paid | boolean | Included in payout |
| created_at | timestamp | |
| updated_at | timestamp | |

### partner_payouts
| Column | Type | Description |
|--------|------|-------------|
| id | bigint | Primary key |
| partner_id | bigint | Foreign key to partners |
| amount | decimal | Payout amount |
| currency | string | Currency code |
| status | string | requested, processing, completed, failed |
| payout_method | string | Method used |
| transaction_id | string | External payment reference |
| referral_ids | json | Array of referral IDs included |
| requested_at | timestamp | |
| processed_at | timestamp | |
| created_at | timestamp | |
| updated_at | timestamp | |

## Referral Tracking

### How It Works
1. Partner shares link: `https://plannrly.com/?ref=PARTNER123`
2. TrackReferral middleware stores code in session/cookie
3. On signup, referral is recorded
4. On first payment, referral converts
5. Commission calculated and tracked

## Tasks

- [ ] Create partner database migrations
- [ ] Create Partner model with relationships
- [ ] Create PartnerReferral model
- [ ] Create PartnerPayout model
- [ ] Create PartnerService for business logic
- [ ] Create CommissionCalculationService
- [ ] Create partner registration flow
- [ ] Generate unique referral codes
- [ ] Create TrackReferral middleware
- [ ] Track referrals to tenant signups
- [ ] Calculate commission on conversions
- [ ] Create partner dashboard
- [ ] Show referred tenants and earnings
- [ ] Create payout request system
- [ ] Create admin partner management
- [ ] Create partner approval workflow
- [ ] Create payout processing workflow
- [ ] Send notification on approval
- [ ] Send notification on referral conversion
- [ ] Send notification on payout processed
- [ ] Write comprehensive tests

## Tests

Planned tests for `tests/Feature/PartnerProgramTest.php`:

1. `test_can_register_as_partner`
2. `test_partner_registration_requires_approval`
3. `test_approved_partner_can_access_dashboard`
4. `test_referral_code_is_unique`
5. `test_referral_link_tracks_signups`
6. `test_referral_converts_on_first_payment`
7. `test_commission_calculated_correctly`
8. `test_partner_can_view_referrals`
9. `test_partner_can_request_payout`
10. `test_payout_requires_minimum_balance`
11. `test_admin_can_approve_partner`
12. `test_admin_can_process_payout`
13. `test_partner_notified_on_conversion`

## Dependencies

- User authentication system
- Tenant model
- Subscription/billing system
- Payment processor integration
- Notification system
