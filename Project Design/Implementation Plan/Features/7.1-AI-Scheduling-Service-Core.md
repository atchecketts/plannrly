# Feature 7.1: AI Scheduling Service Core

**Status:** Not Started
**Effort:** Large
**Phase:** 7 - AI Scheduling (Premium Add-On)

## Overview

Build the intelligent scheduling engine that can automatically assign employees to shifts based on qualifications, availability, constraints, and optimization goals. This is a premium feature requiring the `ai_scheduling` add-on or Professional/Enterprise subscription plan.

> **Prerequisite:** Phase 1.6 (Subscription & Feature Management) must be completed first.

## Requirements

### Functional Requirements
- Automatically assign employees to unassigned shifts
- Generate complete schedules for a given period
- Find replacement employees for specific shifts
- Analyze schedule quality and provide metrics
- Respect all hard constraints (must satisfy)
- Optimize for soft constraints (scoring-based)

### Hard Constraints (Must Satisfy)
| Constraint | Description |
|------------|-------------|
| Role Qualification | Employee has required business role |
| Availability | Employee available during shift hours |
| Not On Leave | No approved leave during shift |
| No Overlap | Not already scheduled for overlapping shift |
| Active Employment | Employment status is active |
| Max Hours | Doesn't exceed max_hours_per_week |

### Soft Constraints (Optimize by Score)
| Constraint | Weight | Description |
|------------|--------|-------------|
| Target Hours | High | Meet target_hours_per_week |
| Preference Level | Medium | Honor availability preferences |
| Fair Distribution | Medium | Balance hours across employees |
| Minimize Overtime | Medium | Avoid exceeding target hours |
| Consecutive Shifts | Low | Group shifts when possible |

## Files

### To Create
- `app/Services/Scheduling/AISchedulingService.php`
- `app/Services/Scheduling/ScheduleOptimizer.php`
- `app/Services/Scheduling/ScheduleContext.php`
- `app/Services/Scheduling/ScheduleSuggestion.php`
- `app/Services/Scheduling/ScheduleAnalysis.php`
- `app/Services/Scheduling/Constraints/ConstraintInterface.php`
- `app/Services/Scheduling/Constraints/HardConstraint.php`
- `app/Services/Scheduling/Constraints/SoftConstraint.php`
- `app/Services/Scheduling/Constraints/RoleQualificationConstraint.php`
- `app/Services/Scheduling/Constraints/AvailabilityConstraint.php`
- `app/Services/Scheduling/Constraints/LeaveConstraint.php`
- `app/Services/Scheduling/Constraints/OverlapConstraint.php`
- `app/Services/Scheduling/Constraints/EmploymentStatusConstraint.php`
- `app/Services/Scheduling/Constraints/MaxHoursConstraint.php`
- `app/Services/Scheduling/Constraints/TargetHoursConstraint.php`
- `app/Services/Scheduling/Constraints/PreferenceLevelConstraint.php`
- `app/Services/Scheduling/Constraints/FairDistributionConstraint.php`
- `tests/Unit/Services/AISchedulingServiceTest.php`
- `tests/Feature/AISchedulingTest.php`

## Tasks

- [ ] Create AISchedulingService with main interface
- [ ] Create ScheduleContext to track state during optimization
- [ ] Create ConstraintInterface for constraint checking
- [ ] Implement RoleQualificationConstraint (hard)
- [ ] Implement AvailabilityConstraint (hard)
- [ ] Implement LeaveConstraint (hard)
- [ ] Implement OverlapConstraint (hard)
- [ ] Implement EmploymentStatusConstraint (hard)
- [ ] Implement MaxHoursConstraint (hard)
- [ ] Implement TargetHoursConstraint (soft)
- [ ] Implement PreferenceLevelConstraint (soft)
- [ ] Implement FairDistributionConstraint (soft)
- [ ] Create ScheduleOptimizer with scoring algorithm
- [ ] Create ScheduleSuggestion response class
- [ ] Create ScheduleAnalysis for schedule quality metrics
- [ ] Write comprehensive unit tests
- [ ] Write integration tests

## Architecture

### AISchedulingService Interface
```php
interface AISchedulingServiceInterface
{
    public function generateSchedule(Schedule $schedule, array $options = []): ScheduleSuggestion;
    public function fillUnassignedShifts(Schedule $schedule): ScheduleSuggestion;
    public function findReplacement(Shift $shift): ScheduleSuggestion;
    public function analyzeSchedule(Schedule $schedule): ScheduleAnalysis;
}
```

### Constraint Scoring
- Hard constraints return pass/fail
- Soft constraints return a score (0-100)
- Final assignment score = sum of weighted soft constraint scores
- Assignments are ranked by score, highest wins

## Tests

### Unit Tests (`tests/Unit/Services/AISchedulingServiceTest.php`)
1. `test_hard_constraint_role_qualification`
2. `test_hard_constraint_availability`
3. `test_hard_constraint_not_on_leave`
4. `test_hard_constraint_no_overlap`
5. `test_hard_constraint_active_employment`
6. `test_hard_constraint_max_hours`
7. `test_soft_constraint_target_hours_scoring`
8. `test_soft_constraint_preference_level_scoring`
9. `test_soft_constraint_fair_distribution_scoring`
10. `test_optimizer_selects_highest_scoring_employee`

### Feature Tests (`tests/Feature/AISchedulingTest.php`)
1. `test_can_generate_full_schedule`
2. `test_can_fill_unassigned_shifts`
3. `test_can_find_replacement_for_shift`
4. `test_respects_all_hard_constraints`
5. `test_optimizes_for_soft_constraints`
6. `test_schedule_analysis_returns_metrics`
7. `test_feature_requires_ai_scheduling_addon`

## Dependencies

- User model with business roles
- Shift model
- Schedule model
- UserAvailability model (Feature 6.3)
- UserEmploymentDetails model (Feature 6.2)
- LeaveRequest model
- BusinessRole model
- Subscription/Feature Management (Phase 1.6)
