# Feature 10.4: Payroll Integrations (Premium)

**Status:** Not Started
**Effort:** Extra Large
**Phase:** 10 - Premium Add-On Features

## Overview

Direct export to major payroll providers. This premium feature allows organizations to seamlessly transfer time and attendance data to their payroll systems, reducing manual data entry and errors.

## Requirements

### Functional Requirements
- Configure integration with payroll provider
- Export worked hours to payroll system
- Support for multiple providers (ADP, Paychex, Gusto, QuickBooks, Xero)
- Export history and status tracking
- Manual and scheduled exports

### Business Rules
- Feature gated by premium subscription
- One active integration per tenant
- Export includes approved hours only
- Failed exports trigger notifications

### Prerequisites
- Phase 1.6 (Subscription & Feature Management) must be completed

## Supported Providers

| Provider | Export Format |
|----------|---------------|
| ADP | API / CSV |
| Paychex | API / CSV |
| Gusto | API |
| QuickBooks | API |
| Xero | API |

## Database Changes

```php
Schema::create('payroll_integrations', function (Blueprint $table) {
    $table->id();
    $table->foreignId('tenant_id')->constrained()->cascadeOnDelete();
    $table->string('provider'); // PayrollProvider enum
    $table->json('credentials')->nullable(); // encrypted
    $table->boolean('is_active')->default(false);
    $table->json('field_mappings')->nullable();
    $table->timestamps();
});

Schema::create('payroll_exports', function (Blueprint $table) {
    $table->id();
    $table->foreignId('payroll_integration_id')->constrained()->cascadeOnDelete();
    $table->date('period_start');
    $table->date('period_end');
    $table->string('status'); // pending, processing, completed, failed
    $table->integer('records_count')->default(0);
    $table->text('error_message')->nullable();
    $table->string('export_file')->nullable();
    $table->timestamp('completed_at')->nullable();
    $table->timestamps();
});
```

## Files

### Created/Modified
- `app/Models/PayrollIntegration.php` - Integration model
- `app/Models/PayrollExport.php` - Export model
- `app/Enums/PayrollProvider.php` - Provider enum
- `app/Services/PayrollIntegrationService.php` - Integration service
- `app/Services/Payroll/AdpExporter.php` - ADP exporter
- `app/Services/Payroll/PaychexExporter.php` - Paychex exporter
- `app/Services/Payroll/GustoExporter.php` - Gusto exporter
- `app/Services/Payroll/QuickBooksExporter.php` - QuickBooks exporter
- `app/Services/Payroll/XeroExporter.php` - Xero exporter
- `app/Http/Controllers/PayrollController.php` - Payroll controller
- `resources/views/payroll/index.blade.php` - Payroll dashboard
- `resources/views/payroll/setup.blade.php` - Integration setup
- `resources/views/payroll/export.blade.php` - Export wizard
- `tests/Feature/PayrollIntegrationTest.php` - Feature tests

### Routes
```php
Route::middleware(['auth', 'feature:payroll-integrations'])->group(function () {
    Route::get('payroll', [PayrollController::class, 'index'])
        ->name('payroll.index');
    Route::get('payroll/setup', [PayrollController::class, 'setup'])
        ->name('payroll.setup');
    Route::post('payroll/setup', [PayrollController::class, 'configure'])
        ->name('payroll.configure');
    Route::get('payroll/export', [PayrollController::class, 'exportForm'])
        ->name('payroll.export.form');
    Route::post('payroll/export', [PayrollController::class, 'export'])
        ->name('payroll.export');
    Route::get('payroll/history', [PayrollController::class, 'history'])
        ->name('payroll.history');
});
```

## Tasks

- [ ] Create PayrollIntegration model
- [ ] Create PayrollExport model
- [ ] Create PayrollProvider enum
- [ ] Create PayrollIntegrationService
- [ ] Implement provider-specific exporters
- [ ] Create PayrollController
- [ ] Build integration setup UI
- [ ] Build export wizard UI
- [ ] Implement OAuth flows for API providers
- [ ] Add export history view
- [ ] Add feature gate middleware
- [ ] Write tests

## Tests

Tests to be created in `tests/Feature/PayrollIntegrationTest.php`:

1. `test_feature_requires_premium_subscription`
2. `test_admin_can_setup_integration`
3. `test_oauth_flow_works_for_api_providers`
4. `test_csv_export_generates_correctly`
5. `test_api_export_sends_data`
6. `test_export_includes_only_approved_hours`
7. `test_export_history_tracked`
8. `test_failed_export_notification_sent`
9. `test_field_mapping_customizable`

## Dependencies

- Feature 1.6: Subscription & Feature Management
- ClockEvent model with approved hours
- User model with employee IDs
- Tenant model

## Notes

### Exporter Interface
```php
interface PayrollExporter
{
    public function export(PayrollExport $export): bool;
    public function getRequiredFields(): array;
    public function validateCredentials(array $credentials): bool;
    public function supportsOAuth(): bool;
}
```

### OAuth Providers
- Gusto, QuickBooks, Xero use OAuth 2.0
- Store tokens encrypted in credentials
- Implement token refresh

### CSV Format Example
```csv
employee_id,pay_period_start,pay_period_end,regular_hours,overtime_hours
EMP001,2024-01-01,2024-01-15,80.00,5.50
```
