# Feature 7.2: AI Scheduling API & UI

**Status:** Not Started
**Effort:** Medium
**Phase:** 7 - AI Scheduling (Premium Add-On)

## Overview

Expose the AI scheduling capabilities through API endpoints and user interface controls. This allows administrators to trigger AI scheduling from the schedule view, preview suggestions before applying them, and manage the AI scheduling workflow.

> **Prerequisite:** Feature 7.1 (AI Scheduling Service Core) must be completed first.

## Requirements

### Functional Requirements
- API endpoints for AI scheduling operations
- "Auto-Fill" button on schedule toolbar
- "Generate Schedule" modal with configuration options
- Preview suggested assignments before applying
- Show warnings and conflicts in preview
- One-click apply for all suggestions
- Undo capability for applied changes
- Feature gated behind `ai_scheduling` add-on

### Business Rules
- Only admins can access AI scheduling features
- Feature must be enabled via subscription/add-on
- Suggestions are previewed before being applied
- Users can selectively accept/reject suggestions
- Applied changes should be undoable

### API Endpoints
```
POST /schedule/ai/generate         - Generate full schedule
POST /schedule/ai/fill-unassigned  - Fill only unassigned shifts
POST /schedule/ai/find-replacement/{shift} - Find replacement employee
POST /schedule/ai/analyze          - Analyze current schedule
POST /schedule/ai/apply            - Apply suggested assignments
```

## Files

### To Create
- `app/Http/Controllers/AIScheduleController.php`
- `app/Http/Requests/AISchedule/GenerateRequest.php`
- `app/Http/Requests/AISchedule/FillUnassignedRequest.php`
- `app/Http/Requests/AISchedule/ApplyRequest.php`
- `resources/views/components/ai-schedule-modal.blade.php`
- `resources/views/components/ai-schedule-preview.blade.php`
- `resources/js/ai-scheduling.js`
- `tests/Feature/AIScheduleApiTest.php`

### Routes
```php
Route::middleware(['auth', 'feature:ai_scheduling'])->prefix('schedule/ai')->group(function () {
    Route::post('generate', [AIScheduleController::class, 'generate'])->name('schedule.ai.generate');
    Route::post('fill-unassigned', [AIScheduleController::class, 'fillUnassigned'])->name('schedule.ai.fill-unassigned');
    Route::post('find-replacement/{shift}', [AIScheduleController::class, 'findReplacement'])->name('schedule.ai.find-replacement');
    Route::post('analyze', [AIScheduleController::class, 'analyze'])->name('schedule.ai.analyze');
    Route::post('apply', [AIScheduleController::class, 'apply'])->name('schedule.ai.apply');
});
```

## Tasks

- [ ] Create AIScheduleController
- [ ] Create GenerateRequest validation class
- [ ] Create FillUnassignedRequest validation class
- [ ] Create ApplyRequest validation class
- [ ] Add API routes with `feature:ai_scheduling` middleware
- [ ] Create AI scheduling modal component
- [ ] Add "Auto-Fill Shifts" button to schedule toolbar (conditionally shown)
- [ ] Implement preview/apply workflow
- [ ] Show scoring breakdown for each suggestion
- [ ] Display warnings for unfillable shifts
- [ ] Add analytics/metrics display in preview
- [ ] Use `@feature('ai_scheduling')` directive to show/hide UI elements
- [ ] Show upgrade prompt when feature not enabled
- [ ] Implement undo functionality
- [ ] Write tests (including feature gate tests)

## UI Components

### AI Schedule Modal
- Schedule generation options (date range, departments, etc.)
- Progress indicator during generation
- Preview of all suggestions with scores
- Accept all / Accept selected / Cancel buttons
- Warning section for unfillable shifts

### Schedule Toolbar Addition
- "Auto-Fill" dropdown button (when feature enabled)
  - Fill Unassigned Shifts
  - Generate Full Schedule
  - Analyze Schedule
- "Upgrade" button (when feature not enabled)

## Tests

Tests to be created in `tests/Feature/AIScheduleApiTest.php`:

1. `test_generate_endpoint_requires_ai_scheduling_feature`
2. `test_admin_can_generate_schedule`
3. `test_non_admin_cannot_generate_schedule`
4. `test_fill_unassigned_returns_suggestions`
5. `test_find_replacement_returns_candidates`
6. `test_analyze_returns_schedule_metrics`
7. `test_apply_endpoint_assigns_employees`
8. `test_suggestions_include_scoring_breakdown`
9. `test_warnings_returned_for_unfillable_shifts`
10. `test_upgrade_prompt_shown_when_feature_disabled`
11. `test_ui_elements_hidden_when_feature_disabled`

## Dependencies

- AISchedulingService (Feature 7.1)
- Shift model
- Schedule model
- User model
- Subscription/Feature Management (Phase 1.6)
- `feature:ai_scheduling` middleware
- `@feature` Blade directive
