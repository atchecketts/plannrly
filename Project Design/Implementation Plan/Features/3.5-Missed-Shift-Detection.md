# Feature 3.5: Missed Shift Detection

**Status:** Complete
**Effort:** Medium
**Phase:** 3 - Time & Attendance
**Completed:** January 2026

## Overview

Automatically detect and flag missed shifts. This feature runs on a schedule to identify shifts where employees did not clock in, creating a time entry with a missed status and notifying managers of the situation.

## Requirements

### Functional Requirements
- Automatic detection via scheduler (every 15 minutes)
- Find published shifts that started past the grace period
- Check if time entry exists for that shift
- If no entry, create one with status='missed'
- Notify manager of missed shift
- Missed shift indicator on dashboards

### Detection Logic
```
1. Run every 15 minutes via scheduler
2. Find published shifts where:
   - start_time < (now - grace_period)
   - No time_entry exists for the shift
   - Shift is assigned (has user_id)
3. For each missed shift:
   - Create time_entry with status='missed'
   - Send MissedShiftNotification to managers
```

## Implementation

### Files Created
- `app/Console/Commands/DetectMissedShiftsCommand.php` - Artisan command for detection
- `app/Notifications/MissedShiftNotification.php` - Email/database notification
- `tests/Feature/MissedShiftDetectionTest.php` - 13 tests

### Files Modified
- `app/Enums/TimeEntryStatus.php` - Added Missed status with label/color/isMissed()
- `app/Models/TimeEntry.php` - Added isMissed() method and missed/forShift scopes
- `routes/console.php` - Registered command in scheduler
- `app/Http/Controllers/DashboardController.php` - Added missed shift counts
- `resources/views/dashboard/admin.blade.php` - Added missed shifts alert banner
- `resources/views/dashboard/employee.blade.php` - Added missed shifts alert

## Tasks

- [x] Add Missed status to TimeEntryStatus enum
- [x] Add isMissed() method to TimeEntry model
- [x] Add missed scope to TimeEntry model
- [x] Create DetectMissedShiftsCommand
- [x] Implement missed shift detection logic
- [x] Create MissedShiftNotification (mail + database)
- [x] Register command in scheduler (every 15 min)
- [x] Add missed shift count to admin dashboard stats
- [x] Add missed shift count to employee dashboard stats
- [x] Add missed shift alert banner to admin dashboard
- [x] Add missed shift alert banner to employee dashboard
- [x] Write comprehensive tests

## Command Details

```php
// Command signature
php artisan attendance:detect-missed-shifts

// Scheduler registration (in routes/console.php)
Schedule::command('attendance:detect-missed-shifts')->everyFifteenMinutes();
```

## TimeEntryStatus Enum

```php
case Missed = 'missed';

public function label(): string {
    return 'Missed';
}

public function color(): string {
    return 'red';
}

public function isMissed(): bool {
    return $this === self::Missed;
}
```

## Manager Notification Logic

Notifications are sent to:
1. Department admins (if shift has department_id)
2. Location admins (if shift has location_id)
3. Tenant admins

Duplicates are removed by user ID.

## Dashboard Integration

### Admin Dashboard
- `stats['missed_shifts_today']` - Count of missed entries for today
- Red alert banner when missed shifts > 0
- Link to timesheets for review

### Employee Dashboard
- `stats['missed_shifts']` - Count of missed entries this week
- Red alert banner with message to speak with manager

## Dependencies

- Shift model (with timeEntry relationship)
- TimeEntry model
- User model with role assignments
- TenantSettings (for grace period, enable_clock_in_out)
- Laravel Scheduler
- Notification system (mail + database channels)

## Technical Notes

### Console Command Considerations
The `DetectMissedShiftsCommand` uses `withoutGlobalScopes()` when querying shifts because the `TenantScope` global scope on the Shift model can interfere with queries in console contexts (where there is no authenticated user). The command explicitly filters by `tenant_id` to maintain tenant isolation.

### Date Comparison
The command uses `whereDate('date', $today)` instead of `where('date', $today)` for more reliable date comparison, as the Shift model casts the date field to a Carbon date object.

### Test Setup
Tests should set an explicit `timezone` value (e.g., 'UTC') in TenantSettings to ensure consistent date handling between test data and command logic, since the factory generates random timezones.

## Testing

The test suite covers:
- Command creates missed entry for shifts past grace period
- Command does NOT create entry for shifts within grace period
- Command does NOT create entry if time entry already exists
- Command does NOT process tenants without clock-in enabled
- Command sends notification to admin
- Command does NOT process unassigned shifts
- Command does NOT process draft shifts
- isMissed() method works correctly
- Missed scope returns only missed entries
- Admin dashboard shows missed shifts count
- Employee dashboard shows missed shifts count
- Tenant isolation (notifications go to correct tenant)
