# Feature 19.1: Webhook System

**Status:** Not Started
**Effort:** Large
**Phase:** 19 - Technical Infrastructure

## Overview

Real-time event notifications for external integrations. This system allows third-party applications to receive automatic notifications when specific events occur within Plannrly, enabling powerful automation and integration workflows.

## Requirements

### Functional Requirements
- Admins can create, edit, and delete webhooks
- Webhooks can be configured to trigger on specific events
- Webhooks support HMAC signature verification for security
- Failed deliveries are retried with exponential backoff
- Webhooks are automatically disabled after repeated failures
- Delivery history is logged and viewable
- Test webhook functionality for configuration verification

### Supported Events
- `shift.created` - A new shift is created
- `shift.updated` - An existing shift is modified
- `shift.deleted` - A shift is deleted
- `schedule.published` - A schedule is published
- `employee.clocked_in` - An employee clocks in
- `employee.clocked_out` - An employee clocks out
- `leave.requested` - A leave request is submitted
- `leave.approved` - A leave request is approved
- `leave.rejected` - A leave request is rejected
- `swap.requested` - A shift swap is requested
- `swap.approved` - A shift swap is approved
- `swap.rejected` - A shift swap is rejected

### Security Requirements
- HMAC-SHA256 signature verification
- Secret key per webhook for signature generation
- Secure secret key generation and storage
- Request timeout handling

### Retry Policy
- Initial retry after 1 minute
- Exponential backoff: 1min, 5min, 15min, 1hr, 4hr
- Maximum 5 retry attempts
- Disable webhook after 10 consecutive failures

## Files

### To Create
- `app/Models/Webhook.php`
- `app/Models/WebhookDelivery.php`
- `app/Services/WebhookService.php`
- `app/Jobs/WebhookDeliveryJob.php`
- `app/Http/Controllers/WebhookController.php`
- `app/Http/Requests/Webhook/StoreWebhookRequest.php`
- `app/Http/Requests/Webhook/UpdateWebhookRequest.php`
- `app/Policies/WebhookPolicy.php`
- `resources/views/settings/webhooks/index.blade.php`
- `resources/views/settings/webhooks/create.blade.php`
- `resources/views/settings/webhooks/edit.blade.php`
- `resources/views/settings/webhooks/deliveries.blade.php`
- `database/migrations/xxxx_create_webhooks_table.php`
- `database/migrations/xxxx_create_webhook_deliveries_table.php`
- `tests/Feature/WebhookSystemTest.php`

### Routes
```php
Route::resource('settings/webhooks', WebhookController::class);
Route::get('settings/webhooks/{webhook}/deliveries', [WebhookController::class, 'deliveries'])->name('webhooks.deliveries');
Route::post('settings/webhooks/{webhook}/test', [WebhookController::class, 'test'])->name('webhooks.test');
```

## Database Schema

### webhooks
| Column | Type | Description |
|--------|------|-------------|
| id | bigint | Primary key |
| tenant_id | bigint | Foreign key to tenants |
| name | string | Webhook display name |
| url | string | Destination URL |
| secret | string | HMAC signing secret |
| events | json | Array of subscribed events |
| is_active | boolean | Enable/disable webhook |
| last_triggered_at | timestamp | Last successful delivery |
| failure_count | integer | Consecutive failure count |
| created_at | timestamp | |
| updated_at | timestamp | |

### webhook_deliveries
| Column | Type | Description |
|--------|------|-------------|
| id | bigint | Primary key |
| webhook_id | bigint | Foreign key to webhooks |
| event | string | Event type that triggered |
| payload | json | Request payload sent |
| response_code | integer | HTTP response code |
| response_body | text | Response body received |
| attempt | integer | Attempt number |
| delivered_at | timestamp | When delivery was attempted |
| created_at | timestamp | |

## Tasks

- [ ] Create webhook migrations
- [ ] Create Webhook model with tenant relationship
- [ ] Create WebhookDelivery model
- [ ] Create WebhookService for dispatching events
- [ ] Implement HMAC signature verification
- [ ] Create WebhookDeliveryJob with retries
- [ ] Implement exponential backoff for failures
- [ ] Create WebhookController with CRUD
- [ ] Create Form Request classes
- [ ] Create WebhookPolicy for authorization
- [ ] Create webhook management UI (index, create, edit)
- [ ] Add "Test webhook" button functionality
- [ ] Create delivery log viewer
- [ ] Implement auto-disable after repeated failures
- [ ] Add webhook events to relevant models/observers
- [ ] Write comprehensive tests

## Tests

Planned tests for `tests/Feature/WebhookSystemTest.php`:

1. `test_admin_can_view_webhooks_index`
2. `test_employee_cannot_view_webhooks_index`
3. `test_admin_can_create_webhook`
4. `test_webhook_requires_valid_url`
5. `test_webhook_requires_at_least_one_event`
6. `test_admin_can_update_webhook`
7. `test_admin_can_delete_webhook`
8. `test_webhook_delivery_includes_signature`
9. `test_signature_verification_matches`
10. `test_failed_delivery_is_retried`
11. `test_webhook_disabled_after_max_failures`
12. `test_test_webhook_sends_sample_payload`
13. `test_delivery_log_shows_history`
14. `test_different_tenants_have_separate_webhooks`

## Dependencies

- Tenant model
- Event system for triggering webhooks
- Queue system for async delivery
- HTTP client for webhook requests
