# Feature 1.6: Subscription & Feature Management

**Status:** Complete
**Effort:** Large
**Phase:** 1 - Core Features
**Completed:** January 2026

## Overview

Implement subscription tiers (Basic, Professional, Enterprise) and premium feature add-ons (AI Scheduling, Advanced Analytics, API Access, Priority Support) for Plannrly. This provides the foundation for the SaaS business model and feature gating.

## Requirements

### Functional Requirements
- Tenants have a subscription with a plan, status, and billing cycle
- Subscriptions are auto-created when tenants are created (via TenantObserver)
- New tenants start with Basic plan in Trialing status
- Features can be accessed via plan inclusion OR purchased add-ons
- Add-ons can have expiration dates
- Admins can view their subscription status and available features
- Middleware blocks access to premium features for unauthorized tenants
- Blade directives allow conditional rendering based on features

### Plan Hierarchy

| Plan | Price | Included Features |
|------|-------|-------------------|
| Basic | Free | Core features only |
| Professional | $49/mo | AI Scheduling, Advanced Analytics |
| Enterprise | $149/mo | All features |

### Feature Add-ons

| Feature | Price | Description |
|---------|-------|-------------|
| AI Scheduling | $19/mo | Intelligent schedule optimization |
| Advanced Analytics | $14/mo | Detailed reports and insights |
| API Access | $29/mo | REST API for integrations |
| Priority Support | $49/mo | 24/7 priority support |

### Subscription Statuses
- **Active** - Full access to plan features
- **Trialing** - Full access during trial period
- **Past Due** - Access maintained, payment overdue
- **Cancelled** - No access to premium features

## Files

### Created

#### Migrations
- `database/migrations/2026_01_28_000001_create_tenant_subscriptions_table.php`
- `database/migrations/2026_01_28_000002_create_tenant_feature_addons_table.php`

#### Enums
- `app/Enums/SubscriptionPlan.php` - Basic, Professional, Enterprise
- `app/Enums/SubscriptionStatus.php` - Active, PastDue, Cancelled, Trialing
- `app/Enums/BillingCycle.php` - Monthly, Annual
- `app/Enums/FeatureAddon.php` - AiScheduling, AdvancedAnalytics, ApiAccess, PrioritySupport

#### Models
- `app/Models/TenantSubscription.php`
- `app/Models/TenantFeatureAddon.php`

#### Factories
- `database/factories/TenantSubscriptionFactory.php`
- `database/factories/TenantFeatureAddonFactory.php`

#### Service
- `app/Services/SubscriptionService.php`

#### Middleware
- `app/Http/Middleware/RequiresFeature.php`

#### Controllers
- `app/Http/Controllers/SubscriptionController.php`
- `app/Http/Controllers/FeatureController.php`

#### Views
- `resources/views/subscription/index.blade.php`
- `resources/views/subscription/upgrade.blade.php`
- `resources/views/components/feature-gate.blade.php`

#### Tests
- `tests/Unit/SubscriptionPlanTest.php`
- `tests/Feature/SubscriptionManagementTest.php`

### Modified
- `app/Models/Tenant.php` - Added subscription relationships and hasFeature() methods
- `app/Observers/TenantObserver.php` - Auto-create subscription on tenant creation
- `app/Providers/AppServiceProvider.php` - Registered @feature Blade directive
- `bootstrap/app.php` - Registered requires-feature middleware alias
- `routes/web.php` - Added subscription and feature API routes
- `resources/views/components/layouts/app.blade.php` - Added sidebar link

### Routes
```php
// Subscription management (admin only)
Route::get('subscription', [SubscriptionController::class, 'index'])->name('subscription.index');
Route::get('subscription/upgrade', [SubscriptionController::class, 'upgrade'])->name('subscription.upgrade');

// Feature API
Route::get('api/features', [FeatureController::class, 'status'])->name('api.features.status');
Route::get('api/features/{feature}', [FeatureController::class, 'check'])->name('api.features.check');
```

## Tasks

- [x] Create migration for tenant_subscriptions table
- [x] Create migration for tenant_feature_addons table
- [x] Create SubscriptionPlan enum with includedFeatures()
- [x] Create SubscriptionStatus enum with isAccessible()
- [x] Create BillingCycle enum
- [x] Create FeatureAddon enum with labels/descriptions
- [x] Create TenantSubscription model
- [x] Create TenantFeatureAddon model
- [x] Create TenantSubscription factory
- [x] Create TenantFeatureAddon factory
- [x] Update Tenant model with relationships
- [x] Add hasFeature() and convenience methods to Tenant
- [x] Create SubscriptionService
- [x] Create RequiresFeature middleware
- [x] Register middleware in bootstrap/app.php
- [x] Register @feature Blade directive
- [x] Create feature-gate component
- [x] Create SubscriptionController
- [x] Create FeatureController
- [x] Add routes to web.php
- [x] Create subscription index view
- [x] Create subscription upgrade view
- [x] Add subscription link to sidebar
- [x] Update TenantObserver to create subscription
- [x] Write unit tests (12 tests)
- [x] Write feature tests (25 tests)

## Database Schema

### tenant_subscriptions
| Column | Type | Default | Description |
|--------|------|---------|-------------|
| id | bigint | auto | Primary key |
| tenant_id | bigint | - | FK to tenants (unique) |
| plan | varchar | 'basic' | Subscription plan |
| status | varchar | 'trialing' | Subscription status |
| billing_cycle | varchar | 'monthly' | Monthly or annual |
| current_period_start | timestamp | null | Current billing period start |
| current_period_end | timestamp | null | Current billing period end |
| cancelled_at | timestamp | null | When cancelled |
| stripe_subscription_id | varchar | null | Stripe reference |
| created_at | timestamp | - | Created timestamp |
| updated_at | timestamp | - | Updated timestamp |

### tenant_feature_addons
| Column | Type | Default | Description |
|--------|------|---------|-------------|
| id | bigint | auto | Primary key |
| tenant_id | bigint | - | FK to tenants |
| feature | varchar | - | Feature enum value |
| enabled_at | timestamp | - | When enabled |
| expires_at | timestamp | null | When expires (null = permanent) |
| stripe_subscription_item_id | varchar | null | Stripe reference |
| created_at | timestamp | - | Created timestamp |
| updated_at | timestamp | - | Updated timestamp |

**Unique constraint:** (tenant_id, feature)

## Usage Examples

### Middleware Protection
```php
Route::get('/ai-schedule', [AIScheduleController::class, 'index'])
    ->middleware('requires-feature:ai_scheduling');
```

### Blade Directive
```blade
@feature('ai_scheduling')
    <x-ai-schedule-widget />
@endfeature
```

### Component
```blade
<x-feature-gate feature="ai_scheduling">
    <x-ai-schedule-panel />
</x-feature-gate>
```

### In Code
```php
if ($tenant->hasFeature(FeatureAddon::AiScheduling)) {
    // Show AI features
}

// Convenience methods
if ($tenant->hasAIScheduling()) { }
if ($tenant->hasAdvancedAnalytics()) { }
if ($tenant->hasApiAccess()) { }
if ($tenant->hasPrioritySupport()) { }
```

## Tests

### Unit Tests (12 tests in SubscriptionPlanTest.php)
1. `test_basic_plan_includes_no_features`
2. `test_professional_plan_includes_ai_and_analytics`
3. `test_enterprise_plan_includes_all_features`
4. `test_plan_hierarchy_ordering`
5. `test_plan_labels_and_descriptions`
6. `test_plan_pricing`
7. `test_subscription_status_accessibility`
8. `test_subscription_status_labels`
9. `test_billing_cycle_labels`
10. `test_billing_cycle_intervals`
11. `test_feature_addon_labels_and_descriptions`
12. `test_feature_addon_pricing`

### Feature Tests (25 tests in SubscriptionManagementTest.php)
1. `test_subscription_is_created_on_tenant_creation`
2. `test_tenant_has_subscription_relationship`
3. `test_admin_can_view_subscription_page`
4. `test_employee_cannot_view_subscription_page`
5. `test_admin_can_view_upgrade_page`
6. `test_employee_cannot_view_upgrade_page`
7. `test_basic_plan_tenant_does_not_have_premium_features`
8. `test_professional_plan_tenant_has_ai_and_analytics`
9. `test_enterprise_plan_tenant_has_all_features`
10. `test_addon_feature_grants_access`
11. `test_expired_addon_does_not_grant_access`
12. `test_cancelled_subscription_does_not_grant_plan_features`
13. `test_past_due_subscription_still_grants_features`
14. `test_trialing_subscription_grants_features`
15. `test_feature_api_returns_status`
16. `test_feature_check_api_returns_correct_status`
17. `test_feature_check_api_returns_error_for_unknown_feature`
18. `test_tenant_convenience_methods`
19. `test_has_plan_method`
20. `test_subscription_service_creates_subscription`
21. `test_subscription_service_changes_plan`
22. `test_subscription_service_adds_feature_addon`
23. `test_subscription_service_removes_feature_addon`
24. `test_different_tenants_have_separate_subscriptions`
25. `test_addon_feature_does_not_affect_other_tenants`

## Dependencies

- Tenant model
- TenantObserver
- User role system (isAdmin, isSuperAdmin)
- Blade facade

## Future Work

- Phase 12: Stripe payment integration for actual billing
- Phase 12: Checkout flow for plan upgrades
- Phase 12: Add-on purchase flow
- Webhook handlers for Stripe events
