# Feature 26.2: Global Search

**Status:** Not Started
**Effort:** Large
**Phase:** 26 - Billing & Search Enhancements

## Overview

Full-text search across all content types within a tenant. Users can search for employees, shifts, messages, documents, and other entities using a unified search interface accessible via keyboard shortcut (Cmd+K / Ctrl+K).

## Requirements

### Functional Requirements
- Global search accessible via Cmd+K (Mac) or Ctrl+K (Windows)
- Search across multiple entity types:
  - Users/Employees (name, email, role)
  - Shifts (employee, date, status)
  - Messages (content, sender, recipient)
  - Documents (name, content if text-based)
  - Leave requests (employee, type, dates)
- Results grouped by entity type
- Recent searches stored per user
- Search suggestions as user types
- Click-through to entity detail page
- Search results respect user permissions

### Search Features
- Full-text search with word stemming
- Partial matching (type-ahead)
- Phrase matching with quotes
- Filter by entity type
- Sort by relevance or date

### Authorization
- Users can only search entities they have permission to view
- Search results are filtered by tenant
- Admins see all tenant data
- Employees see limited data based on permissions

## Database Changes

### Tables to Create

**search_index**
| Column | Type | Description |
|--------|------|-------------|
| id | bigint | Primary key |
| tenant_id | bigint | Foreign key to tenants |
| searchable_type | string | Model class name |
| searchable_id | bigint | Model ID |
| title | string | Primary searchable text |
| content | text | Additional searchable content |
| metadata | json | Additional filterable data |
| created_at | timestamp | |
| updated_at | timestamp | |

*Note: Add FULLTEXT index on (title, content)*

**recent_searches**
| Column | Type | Description |
|--------|------|-------------|
| id | bigint | Primary key |
| user_id | bigint | Foreign key to users |
| query | string | Search query |
| result_count | integer | Number of results |
| clicked_type | string | Type of result clicked |
| clicked_id | bigint | ID of result clicked |
| created_at | timestamp | |

## Files

### To Create
- `app/Models/SearchIndex.php`
- `app/Models/RecentSearch.php`
- `app/Services/GlobalSearchService.php`
- `app/Services/SearchIndexService.php`
- `app/Traits/Searchable.php`
- `app/Http/Controllers/SearchController.php`
- `app/Console/Commands/ReindexSearch.php`
- `app/Observers/SearchIndexObserver.php`
- `resources/views/components/global-search.blade.php`
- `resources/views/search/results.blade.php`
- `database/migrations/xxxx_create_search_index_table.php`
- `database/migrations/xxxx_create_recent_searches_table.php`
- `tests/Feature/GlobalSearchTest.php`

### Routes
```php
Route::get('search', [SearchController::class, 'search'])->name('search');
Route::get('search/suggestions', [SearchController::class, 'suggestions'])->name('search.suggestions');
Route::get('search/recent', [SearchController::class, 'recent'])->name('search.recent');
Route::delete('search/recent', [SearchController::class, 'clearRecent'])->name('search.recent.clear');
```

## Tasks

- [ ] Create database migrations for search_index and recent_searches tables
- [ ] Create SearchIndex model with FULLTEXT search scope
- [ ] Create RecentSearch model
- [ ] Create Searchable trait for models
- [ ] Add Searchable trait to User, Shift, Message, Document, LeaveRequest models
- [ ] Create SearchIndexObserver for automatic indexing
- [ ] Create GlobalSearchService for unified search
- [ ] Create SearchIndexService for index management
- [ ] Create search API endpoint with permission filtering
- [ ] Build global search UI component (Cmd+K modal)
- [ ] Implement search suggestions endpoint
- [ ] Implement recent searches tracking
- [ ] Create ReindexSearch artisan command
- [ ] Write tests for search functionality

## Searchable Trait

```php
trait Searchable
{
    public static function bootSearchable(): void
    {
        static::observe(SearchIndexObserver::class);
    }

    abstract public function toSearchableArray(): array;

    public function searchIndexTitle(): string
    {
        return $this->name ?? $this->title ?? '';
    }

    public function searchIndexContent(): string
    {
        return '';
    }
}
```

## Search Result Format

```json
{
  "query": "john",
  "total": 15,
  "results": {
    "users": [
      {"id": 1, "title": "John Smith", "subtitle": "Manager", "url": "/employees/1"}
    ],
    "shifts": [
      {"id": 42, "title": "Morning Shift - John Smith", "subtitle": "Jan 15, 2024", "url": "/shifts/42"}
    ],
    "messages": [
      {"id": 100, "title": "Message from John", "subtitle": "2 days ago", "url": "/messages/100"}
    ]
  },
  "suggestions": ["john smith", "john doe"]
}
```

## Tests

Expected tests in `tests/Feature/GlobalSearchTest.php`:

1. `test_user_can_search_employees`
2. `test_user_can_search_shifts`
3. `test_user_can_search_messages`
4. `test_search_results_are_tenant_scoped`
5. `test_search_respects_user_permissions`
6. `test_search_returns_grouped_results`
7. `test_search_supports_partial_matching`
8. `test_search_supports_phrase_matching`
9. `test_recent_searches_are_tracked`
10. `test_user_can_view_recent_searches`
11. `test_user_can_clear_recent_searches`
12. `test_search_suggestions_are_returned`
13. `test_reindex_command_works`
14. `test_search_index_updates_on_model_change`

## Dependencies

- User model
- Shift model
- Message model (if exists)
- Document model (if exists)
- LeaveRequest model
- Permission system
