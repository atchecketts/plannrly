# Feature 1.7: Sortable & Groupable Table Headers

**Status:** Complete
**Effort:** Medium
**Phase:** 1 - Core Features
**Completed:** January 2026

## Overview

Reusable sortable column headers for all list views across the application. Provides sorting (asc/desc) and visual grouping capabilities with query string persistence through pagination.

## Scope

### Affected Controllers (10)
1. `UserController` - Users list
2. `LocationController` - Locations list
3. `DepartmentController` - Departments list
4. `BusinessRoleController` - Business Roles list
5. `LeaveTypeController` - Leave Types list
6. `LeaveRequestController` - Leave Requests list
7. `LeaveAllowanceController` - Leave Allowances list
8. `ShiftSwapController` - Shift Swap Requests list
9. `SuperAdmin\TenantController` - Tenants list
10. `SuperAdmin\UserController` - All Users list

## Technical Implementation

### New Components

#### 1. HandlesSorting Trait
**File:** `app/Traits/HandlesSorting.php`

Provides two methods:
- `applySorting(Builder $query, Request $request, array $sortableColumns, string $defaultSort, string $defaultDirection, array $groupableColumns)` - Applies sorting and grouping to an Eloquent query
- `getSortParameters(Request $request, array $sortableColumns, array $groupableColumns)` - Returns validated sort parameters for the view

#### 2. Sortable Header Component
**File:** `resources/views/components/table/sortable-header.blade.php`

Props:
- `column` - The URL parameter key for sorting
- `label` - Display text for the column
- `currentSort` - Currently active sort column
- `currentDirection` - Current sort direction (asc/desc)
- `currentGroup` - Currently active group column
- `groupable` - Whether this column supports grouping
- `align` - Text alignment (left/right)
- `isFirst` - Whether this is the first column (for padding)

Features:
- Clicking column label cycles: none → asc → desc → none
- Active sort shows chevron up (asc) or down (desc)
- Hover shows neutral double-chevron when unsorted
- Group icon (bars) appears when `groupable=true`
- Preserves all query params, resets page to 1 on sort/group change

#### 3. Group Header Component
**File:** `resources/views/components/table/group-header.blade.php`

Props:
- `label` - Group section label
- `count` - Optional count to display
- `colspan` - Number of columns to span

Renders a styled section header row when grouping is active.

### Column Mappings Per Controller

| Controller | Sortable Columns | Groupable |
|------------|------------------|-----------|
| UserController | name→first_name, email→email, status→is_active | status |
| LocationController | name→name, city→city, departments→departments_count, status→is_active | city, status |
| DepartmentController | name→name, roles→business_roles_count, status→is_active | status |
| BusinessRoleController | name→name, hourly_rate→default_hourly_rate, users→users_count, status→is_active | status |
| LeaveTypeController | name→name, requests→leave_requests_count, status→is_active | status |
| LeaveRequestController | start_date→start_date, days→total_days, status→status, created→created_at | status |
| LeaveAllowanceController | total→total_days, used→used_days, carried_over→carried_over_days | none |
| ShiftSwapController | status→status, requested→created_at | status |
| SuperAdmin\TenantController | organization→name, users→users_count, status→is_active, created→created_at | status |
| SuperAdmin\UserController | name→first_name, status→is_active, last_login→last_login_at | status |

## URL Structure

Sorting is controlled via query string parameters:
- `?sort=name&direction=asc` - Sort by name ascending
- `?sort=status&direction=desc` - Sort by status descending
- `?group=status` - Group rows by status
- `?sort=name&direction=asc&group=status` - Combined sorting and grouping

Parameters persist through pagination via `withQueryString()` on all pagination calls.

## UI/UX Design

### Sort Behavior
1. **Default state**: Column label only, neutral icon on hover
2. **Sorted ascending**: Column highlighted, chevron-up icon in brand color
3. **Sorted descending**: Column highlighted, chevron-down icon in brand color
4. **Click cycle**: none → asc → desc → none

### Group Behavior
1. Group icon visible only on groupable columns
2. Click toggles grouping on/off
3. When grouped, rows are organized under section headers
4. Section headers show group label (e.g., "Active", "Inactive")

## Testing

**File:** `tests/Feature/TableSortingTest.php`

Coverage includes:
- Sort by valid column asc/desc
- Invalid sort column falls back to default
- Sort persists through pagination
- Group-by parameter works
- Non-groupable column rejected
- Combined sort and group
- Smoke tests for all 10 controllers

## Files Changed

### New Files
- `app/Traits/HandlesSorting.php`
- `resources/views/components/table/sortable-header.blade.php`
- `resources/views/components/table/group-header.blade.php`
- `tests/Feature/TableSortingTest.php`

### Modified Controllers
- `app/Http/Controllers/UserController.php`
- `app/Http/Controllers/LocationController.php`
- `app/Http/Controllers/DepartmentController.php`
- `app/Http/Controllers/BusinessRoleController.php`
- `app/Http/Controllers/LeaveTypeController.php`
- `app/Http/Controllers/LeaveRequestController.php`
- `app/Http/Controllers/LeaveAllowanceController.php`
- `app/Http/Controllers/ShiftSwapController.php`
- `app/Http/Controllers/SuperAdmin/TenantController.php`
- `app/Http/Controllers/SuperAdmin/UserController.php`

### Modified Views
- `resources/views/users/index.blade.php`
- `resources/views/locations/index.blade.php`
- `resources/views/departments/index.blade.php`
- `resources/views/business-roles/index.blade.php`
- `resources/views/leave-types/index.blade.php`
- `resources/views/leave/index.blade.php`
- `resources/views/leave-allowances/index.blade.php`
- `resources/views/shift-swaps/index.blade.php`
- `resources/views/super-admin/tenants/index.blade.php`
- `resources/views/super-admin/users/index.blade.php`

---

*Document Version: 1.0*
*Last Updated: January 2026*
