# Feature 10.6: Document & Certification Management (Premium)

**Status:** Not Started
**Effort:** Large
**Phase:** 10 - Premium Add-On Features

## Overview

Manage employee documents and track certifications. This premium feature allows organizations to store employee documents, define certification requirements, and track expiration dates with automated reminders.

## Requirements

### Functional Requirements
- Upload and categorize employee documents
- Define certification types with validity periods
- Track employee certifications with expiry dates
- Define required certifications per role
- Automatic expiry reminder emails
- Certification compliance dashboard

### Business Rules
- Feature gated by premium subscription
- Documents stored securely with access controls
- Expired certifications flagged in scheduling
- Reminders sent 30, 14, and 7 days before expiry

### Prerequisites
- Phase 1.6 (Subscription & Feature Management) must be completed

## Database Changes

```php
Schema::create('employee_documents', function (Blueprint $table) {
    $table->id();
    $table->foreignId('user_id')->constrained()->cascadeOnDelete();
    $table->string('type'); // DocumentType enum
    $table->string('title');
    $table->string('file_path');
    $table->string('file_name');
    $table->integer('file_size');
    $table->date('expiry_date')->nullable();
    $table->foreignId('uploaded_by')->constrained('users');
    $table->timestamps();
});

Schema::create('certifications', function (Blueprint $table) {
    $table->id();
    $table->foreignId('tenant_id')->constrained()->cascadeOnDelete();
    $table->string('name');
    $table->text('description')->nullable();
    $table->integer('validity_months')->nullable();
    $table->boolean('is_active')->default(true);
    $table->timestamps();
});

Schema::create('user_certifications', function (Blueprint $table) {
    $table->id();
    $table->foreignId('user_id')->constrained()->cascadeOnDelete();
    $table->foreignId('certification_id')->constrained()->cascadeOnDelete();
    $table->date('issued_date');
    $table->date('expiry_date')->nullable();
    $table->string('certificate_number')->nullable();
    $table->string('document_path')->nullable();
    $table->foreignId('verified_by')->nullable()->constrained('users');
    $table->timestamp('verified_at')->nullable();
    $table->timestamps();
});

Schema::create('role_required_certifications', function (Blueprint $table) {
    $table->id();
    $table->foreignId('business_role_id')->constrained()->cascadeOnDelete();
    $table->foreignId('certification_id')->constrained()->cascadeOnDelete();
    $table->boolean('is_mandatory')->default(true);
    $table->timestamps();

    $table->unique(['business_role_id', 'certification_id']);
});
```

## Files

### Created/Modified
- `app/Models/EmployeeDocument.php` - Document model
- `app/Models/Certification.php` - Certification type model
- `app/Models/UserCertification.php` - User certification model
- `app/Models/RoleRequiredCertification.php` - Role requirement model
- `app/Enums/DocumentType.php` - Document type enum
- `app/Services/DocumentManagementService.php` - Document service
- `app/Http/Controllers/DocumentController.php` - Document controller
- `app/Http/Controllers/CertificationController.php` - Certification controller
- `app/Jobs/SendCertificationExpiryReminders.php` - Reminder job
- `app/Notifications/CertificationExpiringNotification.php` - Expiry notification
- `resources/views/documents/index.blade.php` - Document list
- `resources/views/documents/upload.blade.php` - Upload form
- `resources/views/certifications/index.blade.php` - Certification list
- `resources/views/users/certifications.blade.php` - User certifications
- `tests/Feature/DocumentManagementTest.php` - Feature tests

### Routes
```php
Route::middleware(['auth', 'feature:document-management'])->group(function () {
    // Documents
    Route::get('documents', [DocumentController::class, 'index'])
        ->name('documents.index');
    Route::get('documents/upload', [DocumentController::class, 'create'])
        ->name('documents.create');
    Route::post('documents', [DocumentController::class, 'store'])
        ->name('documents.store');
    Route::delete('documents/{document}', [DocumentController::class, 'destroy'])
        ->name('documents.destroy');

    // Certifications
    Route::resource('certifications', CertificationController::class);
    Route::get('users/{user}/certifications', [UserCertificationController::class, 'index'])
        ->name('users.certifications.index');
    Route::post('users/{user}/certifications', [UserCertificationController::class, 'store'])
        ->name('users.certifications.store');
});
```

## Tasks

- [ ] Create all document/certification models
- [ ] Create DocumentType enum
- [ ] Create DocumentManagementService
- [ ] Create DocumentController with upload handling
- [ ] Create CertificationController
- [ ] Build document upload and list UI
- [ ] Build certification management UI
- [ ] Build user certification tracking UI
- [ ] Implement role-required certifications
- [ ] Create expiry reminder job (daily)
- [ ] Create expiring certifications dashboard
- [ ] Add compliance check to scheduling (warn if missing certs)
- [ ] Add feature gate middleware
- [ ] Write tests

## Tests

Tests to be created in `tests/Feature/DocumentManagementTest.php`:

1. `test_feature_requires_premium_subscription`
2. `test_admin_can_upload_document`
3. `test_document_categorized_correctly`
4. `test_admin_can_define_certification`
5. `test_admin_can_assign_certification_to_user`
6. `test_certification_expiry_tracked`
7. `test_expiry_reminder_sent`
8. `test_role_required_certifications_defined`
9. `test_missing_certification_warning_in_schedule`
10. `test_compliance_dashboard_accurate`

## Dependencies

- Feature 1.6: Subscription & Feature Management
- User model
- BusinessRole model
- File storage (S3 or local)

## Notes

### Document Types
```php
enum DocumentType: string
{
    case Contract = 'contract';
    case ID = 'id';
    case Certification = 'certification';
    case Training = 'training';
    case Medical = 'medical';
    case Other = 'other';
}
```

### Compliance Dashboard
- Show users with expiring certifications
- Show users missing required certifications
- Filter by role, location, department
- Export compliance report
