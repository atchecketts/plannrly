# Feature 10.2: Advanced Geofencing (Premium)

**Status:** Not Started
**Effort:** Large
**Phase:** 10 - Premium Add-On Features

## Overview

Location-based clock-in verification with configurable geofences. This premium feature allows organizations to enforce that employees clock in/out within designated geographical boundaries.

## Requirements

### Functional Requirements
- Configure geofence per location (lat/long, radius)
- Enforce clock-in within geofence
- Auto clock-in/out on geofence entry/exit (optional)
- GPS trail for mobile workers
- Violation alerts for managers
- Geofence event history

### Business Rules
- Feature gated by premium subscription
- Geofence enforcement is optional per location
- Violations logged but can be overridden by managers
- GPS data retained per data retention policy

### Prerequisites
- Phase 1.6 (Subscription & Feature Management) must be completed

## Database Changes

```php
Schema::create('location_geofences', function (Blueprint $table) {
    $table->id();
    $table->foreignId('location_id')->constrained()->cascadeOnDelete();
    $table->decimal('latitude', 10, 8);
    $table->decimal('longitude', 11, 8);
    $table->integer('radius_meters')->default(100);
    $table->boolean('enforce_on_clock_in')->default(true);
    $table->boolean('enforce_on_clock_out')->default(false);
    $table->boolean('auto_clock_enabled')->default(false);
    $table->timestamps();
});

Schema::create('geofence_events', function (Blueprint $table) {
    $table->id();
    $table->foreignId('user_id')->constrained()->cascadeOnDelete();
    $table->foreignId('location_geofence_id')->constrained()->cascadeOnDelete();
    $table->enum('event_type', ['enter', 'exit', 'clock_in', 'clock_out', 'violation']);
    $table->decimal('latitude', 10, 8);
    $table->decimal('longitude', 11, 8);
    $table->integer('distance_meters')->nullable();
    $table->timestamps();
});
```

## Files

### Created/Modified
- `app/Models/LocationGeofence.php` - Geofence model
- `app/Models/GeofenceEvent.php` - Event logging model
- `app/Services/GeofencingService.php` - Distance calculation and validation
- `app/Http/Controllers/GeofenceController.php` - Geofence management
- `resources/views/locations/geofence.blade.php` - Configuration UI
- `resources/views/components/geofence-map.blade.php` - Map component
- `tests/Feature/GeofencingTest.php` - Feature tests

### Routes
```php
Route::middleware(['auth', 'feature:advanced-geofencing'])->group(function () {
    Route::get('locations/{location}/geofence', [GeofenceController::class, 'edit'])
        ->name('locations.geofence.edit');
    Route::put('locations/{location}/geofence', [GeofenceController::class, 'update'])
        ->name('locations.geofence.update');
    Route::get('geofence/events', [GeofenceController::class, 'events'])
        ->name('geofence.events');
});
```

## Tasks

- [ ] Create LocationGeofence model
- [ ] Create GeofenceEvent model
- [ ] Create GeofencingService with distance calculation
- [ ] Create GeofenceController
- [ ] Build geofence configuration UI with map
- [ ] Integrate with clock-in/out flow
- [ ] Implement auto clock-in/out on geofence events
- [ ] Create violation notification
- [ ] Add geofence events view for managers
- [ ] Add feature gate middleware
- [ ] Write tests

## Tests

Tests to be created in `tests/Feature/GeofencingTest.php`:

1. `test_feature_requires_premium_subscription`
2. `test_admin_can_configure_geofence`
3. `test_clock_in_within_geofence_allowed`
4. `test_clock_in_outside_geofence_blocked`
5. `test_clock_in_outside_geofence_with_override`
6. `test_geofence_event_logged`
7. `test_violation_notification_sent`
8. `test_auto_clock_in_on_geofence_enter`
9. `test_auto_clock_out_on_geofence_exit`
10. `test_distance_calculation_accurate`

## Dependencies

- Feature 1.6: Subscription & Feature Management
- Location model
- ClockEvent model
- User model

## Notes

### Haversine Formula for Distance
```php
public function calculateDistance(float $lat1, float $lon1, float $lat2, float $lon2): float
{
    $earthRadius = 6371000; // meters

    $latDelta = deg2rad($lat2 - $lat1);
    $lonDelta = deg2rad($lon2 - $lon1);

    $a = sin($latDelta / 2) ** 2 +
         cos(deg2rad($lat1)) * cos(deg2rad($lat2)) *
         sin($lonDelta / 2) ** 2;

    $c = 2 * atan2(sqrt($a), sqrt(1 - $a));

    return $earthRadius * $c;
}
```

### Map Integration
- Use Leaflet.js for open-source mapping
- Or Google Maps API if licensed
- Draw radius circle on map
- Allow drag-to-adjust center point
