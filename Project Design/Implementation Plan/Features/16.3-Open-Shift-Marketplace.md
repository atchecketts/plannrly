# Feature 16.3: Open Shift Marketplace

**Status:** Not Started
**Effort:** Large
**Phase:** 16 - Scheduling Enhancements

## Overview

Let employees claim unassigned shifts through a marketplace. Open shifts are listed and qualified, available employees can request to claim them, with optional manager approval.

## Requirements

### Functional Requirements
- Display list of open (unassigned) shifts to employees
- Filter by qualifications and availability automatically
- Employees can request to claim open shifts
- Manager approval queue for claims
- Option for auto-approve per tenant
- Priority rules configuration (seniority, hours worked, etc.)
- Notifications for new open shifts
- Optional auto-assign after deadline

### Claim Process
1. Manager creates shift without assignment (or marks as open)
2. Qualified employees see shift in marketplace
3. Employee submits claim request
4. Manager approves/rejects (or auto-approved)
5. Shift is assigned to employee

### UI Components
- Open shifts list view for employees
- Eligibility indicators (qualified, available)
- Claim request button
- Manager claim approval queue
- Priority configuration (admin)

## Files

### To Create
- `app/Models/OpenShiftClaim.php` - Claim model
- `app/Services/OpenShiftService.php` - Business logic
- `app/Http/Controllers/OpenShiftController.php` - Controller
- `app/Notifications/NewOpenShiftNotification.php`
- `app/Notifications/ClaimApprovedNotification.php`
- `database/migrations/xxxx_create_open_shift_claims_table.php`
- `resources/views/open-shifts/index.blade.php` - Marketplace view
- `resources/views/open-shifts/claims.blade.php` - Admin claims queue
- `tests/Feature/OpenShiftMarketplaceTest.php` - Feature tests

### Routes
```php
// Employee routes
Route::get('open-shifts', [OpenShiftController::class, 'index'])->name('open-shifts.index');
Route::post('open-shifts/{shift}/claim', [OpenShiftController::class, 'claim'])->name('open-shifts.claim');
Route::delete('open-shifts/claims/{claim}', [OpenShiftController::class, 'cancelClaim'])->name('open-shifts.claims.cancel');

// Admin routes
Route::get('admin/open-shift-claims', [OpenShiftController::class, 'adminClaims'])->name('admin.open-shift-claims.index');
Route::post('admin/open-shift-claims/{claim}/approve', [OpenShiftController::class, 'approve'])->name('admin.open-shift-claims.approve');
Route::post('admin/open-shift-claims/{claim}/reject', [OpenShiftController::class, 'reject'])->name('admin.open-shift-claims.reject');
```

## Database Schema

### open_shift_claims
```php
Schema::create('open_shift_claims', function (Blueprint $table) {
    $table->id();
    $table->foreignId('shift_id')->constrained()->cascadeOnDelete();
    $table->foreignId('user_id')->constrained()->cascadeOnDelete();
    $table->string('status'); // pending, approved, rejected, cancelled
    $table->text('note')->nullable(); // Employee note with claim
    $table->text('admin_note')->nullable();
    $table->foreignId('processed_by')->nullable()->constrained('users')->nullOnDelete();
    $table->timestamp('processed_at')->nullable();
    $table->timestamps();

    $table->unique(['shift_id', 'user_id']);
});
```

## Priority Rules

Configurable per tenant:
- First come, first served
- Seniority (hire date)
- Fewest hours this period
- Role expertise level
- Manager's choice

## Tasks

- [ ] Create open_shift_claims migration
- [ ] Create open shift list for employees
- [ ] Filter by qualifications and availability
- [ ] Implement claim request flow
- [ ] Create manager approval queue
- [ ] Add auto-approve option per tenant
- [ ] Configure priority rules (seniority, hours, etc.)
- [ ] Send notifications for new open shifts
- [ ] Auto-assign after deadline (optional)
- [ ] Write tests

## Tests

Suggested tests for `tests/Feature/OpenShiftMarketplaceTest.php`:

1. `test_employee_can_view_open_shifts`
2. `test_open_shifts_are_filtered_by_qualification`
3. `test_open_shifts_are_filtered_by_availability`
4. `test_employee_can_claim_open_shift`
5. `test_employee_cannot_claim_shift_twice`
6. `test_admin_can_approve_claim`
7. `test_admin_can_reject_claim`
8. `test_approved_claim_assigns_shift`
9. `test_auto_approve_works_when_enabled`
10. `test_notification_sent_for_new_open_shift`
11. `test_priority_rules_are_applied`
12. `test_employee_can_cancel_pending_claim`

## Dependencies

- Shift model
- User model with qualifications/roles
- Availability model
- Notification system
- TenantSettings for configuration
