# Feature 14.3: Audit Log System

**Status:** Not Started
**Effort:** Large
**Phase:** 14 - Security Features

## Overview

Complete audit trail for compliance and security. All significant actions are logged and can be searched, filtered, and exported for compliance purposes.

## Requirements

### Functional Requirements
- Log all significant actions (create, update, delete)
- Track which user performed the action
- Store old and new values for changes
- Provide searchable audit log viewer
- Filter by user, action type, entity, date range
- Export audit logs to CSV for compliance
- Configure retention period per tenant
- Ensure logs are immutable

### Actions to Log
- User authentication (login, logout, failed attempts)
- CRUD operations on key models
- Permission and role changes
- Settings changes
- Data exports
- Approval actions

### UI Components
- Audit log list with pagination
- Advanced filters (user, action, entity, date)
- Search functionality
- CSV export button
- Retention settings (admin)

## Files

### To Create
- `app/Models/AuditLog.php` - Audit log model
- `app/Services/AuditLogService.php` - Logging service
- `app/Traits/Auditable.php` - Model trait for automatic logging
- `app/Http/Controllers/AuditLogController.php` - Controller
- `database/migrations/xxxx_create_audit_logs_table.php`
- `resources/views/audit-logs/index.blade.php` - Log viewer
- `tests/Feature/AuditLogSystemTest.php` - Feature tests

### Routes
```php
Route::get('audit-logs', [AuditLogController::class, 'index'])->name('audit-logs.index');
Route::get('audit-logs/export', [AuditLogController::class, 'export'])->name('audit-logs.export');
```

## Database Schema

### audit_logs
```php
Schema::create('audit_logs', function (Blueprint $table) {
    $table->id();
    $table->foreignId('tenant_id')->constrained()->cascadeOnDelete();
    $table->foreignId('user_id')->nullable()->constrained()->nullOnDelete();
    $table->string('user_name')->nullable(); // Preserve even if user deleted
    $table->string('action'); // created, updated, deleted, login, etc.
    $table->string('auditable_type'); // Model class
    $table->unsignedBigInteger('auditable_id')->nullable();
    $table->json('old_values')->nullable();
    $table->json('new_values')->nullable();
    $table->string('ip_address')->nullable();
    $table->string('user_agent')->nullable();
    $table->timestamps();

    $table->index(['tenant_id', 'created_at']);
    $table->index(['auditable_type', 'auditable_id']);
});
```

## Auditable Trait Usage

```php
use App\Traits\Auditable;

class Shift extends Model
{
    use Auditable;

    // Optionally exclude attributes from logging
    protected array $auditExclude = ['updated_at'];
}
```

## Tasks

- [ ] Create audit_logs migration
- [ ] Create AuditLogService for logging actions
- [ ] Create Auditable trait for models
- [ ] Apply trait to key models (Shift, User, LeaveRequest, etc.)
- [ ] Create audit log viewer with filtering
- [ ] Implement search by user, action, entity, date
- [ ] Add CSV export for compliance
- [ ] Configure retention period per tenant
- [ ] Ensure logs are immutable
- [ ] Write tests

## Tests

Suggested tests for `tests/Feature/AuditLogSystemTest.php`:

1. `test_admin_can_view_audit_logs`
2. `test_audit_log_is_created_on_model_create`
3. `test_audit_log_is_created_on_model_update`
4. `test_audit_log_is_created_on_model_delete`
5. `test_audit_log_stores_old_and_new_values`
6. `test_audit_log_captures_user_information`
7. `test_audit_logs_can_be_filtered_by_user`
8. `test_audit_logs_can_be_filtered_by_action`
9. `test_audit_logs_can_be_filtered_by_date_range`
10. `test_audit_logs_can_be_exported_to_csv`
11. `test_audit_logs_are_immutable`
12. `test_employee_cannot_access_audit_logs`

## Dependencies

- Tenant model
- User model
- All auditable models (Shift, LeaveRequest, User, etc.)
