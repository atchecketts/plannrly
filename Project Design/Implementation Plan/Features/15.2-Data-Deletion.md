# Feature 15.2: Data Deletion (Right to Erasure)

**Status:** Not Started
**Effort:** Large
**Phase:** 15 - GDPR Compliance

## Overview

Process data deletion requests with approval workflow in compliance with GDPR Article 17 (Right to Erasure). Users can request deletion of their personal data, which goes through an admin approval process.

## Requirements

### Functional Requirements
- Users can submit data deletion requests
- Admin approval workflow for deletion requests
- Anonymize user data to preserve historical records
- Delete personal documents and files
- Handle legal retention requirements
- Send confirmation emails at each stage
- Log all deletion actions in audit trail

### Deletion Process
1. User submits deletion request with reason
2. Admin reviews request
3. Admin approves or rejects with reason
4. If approved, data is anonymized/deleted
5. Confirmation sent to user
6. Action logged for compliance

### Data Handling
- Anonymize: Replace personal info with generic values (preserves historical data)
- Delete: Remove completely (documents, files)
- Retain: Keep for legal requirements (financial records)

## Files

### To Create
- `app/Models/DataDeletionRequest.php` - Request model
- `app/Services/GdprDeletionService.php` - Deletion logic
- `app/Http/Controllers/DataDeletionController.php` - Controller
- `app/Notifications/DeletionRequestSubmittedNotification.php`
- `app/Notifications/DeletionRequestProcessedNotification.php`
- `database/migrations/xxxx_create_data_deletion_requests_table.php`
- `resources/views/settings/data-deletion.blade.php` - User request form
- `resources/views/admin/deletion-requests/index.blade.php` - Admin queue
- `tests/Feature/GdprDataDeletionTest.php` - Feature tests

### Routes
```php
// User routes
Route::get('settings/data-deletion', [DataDeletionController::class, 'index'])->name('settings.data-deletion');
Route::post('settings/data-deletion/request', [DataDeletionController::class, 'request'])->name('settings.data-deletion.request');

// Admin routes
Route::get('admin/deletion-requests', [DataDeletionController::class, 'adminIndex'])->name('admin.deletion-requests.index');
Route::post('admin/deletion-requests/{request}/approve', [DataDeletionController::class, 'approve'])->name('admin.deletion-requests.approve');
Route::post('admin/deletion-requests/{request}/reject', [DataDeletionController::class, 'reject'])->name('admin.deletion-requests.reject');
```

## Database Schema

### data_deletion_requests
```php
Schema::create('data_deletion_requests', function (Blueprint $table) {
    $table->id();
    $table->foreignId('tenant_id')->constrained()->cascadeOnDelete();
    $table->foreignId('user_id')->constrained()->cascadeOnDelete();
    $table->string('status'); // pending, approved, rejected, completed
    $table->text('reason')->nullable(); // User's reason for request
    $table->text('admin_notes')->nullable();
    $table->foreignId('processed_by')->nullable()->constrained('users')->nullOnDelete();
    $table->timestamp('processed_at')->nullable();
    $table->timestamp('completed_at')->nullable();
    $table->timestamps();
});
```

## Anonymization Strategy

```php
// Example anonymization
$user->update([
    'name' => 'Deleted User ' . $user->id,
    'email' => 'deleted_' . $user->id . '@anonymized.local',
    'phone' => null,
    'address' => null,
    'emergency_contact' => null,
    'photo' => null,
    'deleted_at' => now(),
]);
```

## Tasks

- [ ] Create data_deletion_requests migration
- [ ] Create deletion request submission UI
- [ ] Create admin approval workflow
- [ ] Implement user anonymization (preserve historical data)
- [ ] Delete personal documents and files
- [ ] Handle legal retention requirements
- [ ] Send confirmation emails
- [ ] Log all deletion actions
- [ ] Write tests

## Tests

Suggested tests for `tests/Feature/GdprDataDeletionTest.php`:

1. `test_user_can_view_deletion_request_page`
2. `test_user_can_submit_deletion_request`
3. `test_admin_can_view_deletion_requests`
4. `test_admin_can_approve_deletion_request`
5. `test_admin_can_reject_deletion_request`
6. `test_approved_request_anonymizes_user`
7. `test_personal_files_are_deleted`
8. `test_historical_records_are_preserved`
9. `test_confirmation_email_is_sent`
10. `test_deletion_is_logged_in_audit_trail`
11. `test_user_cannot_submit_duplicate_request`

## Dependencies

- User model
- AuditLogService (from 14.3)
- File storage service
- Mail system
