# Feature 9.3: Push Notifications

**Status:** Not Started
**Effort:** Large
**Phase:** 9 - Mobile Interface & Accessibility

## Overview

Real-time notifications for schedule changes, reminders, and approvals. Users can receive push notifications on their devices even when not actively using the application.

## Requirements

### Functional Requirements
- Users can subscribe to push notifications
- Notifications sent for schedule changes
- Shift reminders with configurable timing
- Leave request status notifications
- Swap request notifications
- Notification preferences UI for customization
- Quiet hours functionality

### Business Rules
- Users must explicitly opt-in to push notifications
- Notifications respect quiet hours settings
- Each device has its own subscription
- Failed deliveries are logged and retried

## Database Changes

```php
Schema::create('push_subscriptions', function (Blueprint $table) {
    $table->id();
    $table->foreignId('user_id')->constrained()->cascadeOnDelete();
    $table->string('endpoint')->unique();
    $table->text('public_key');
    $table->text('auth_token');
    $table->string('user_agent')->nullable();
    $table->timestamps();
});

Schema::create('notification_preferences', function (Blueprint $table) {
    $table->id();
    $table->foreignId('user_id')->constrained()->cascadeOnDelete();
    $table->boolean('schedule_published')->default(true);
    $table->boolean('shift_reminders')->default(true);
    $table->integer('reminder_minutes_before')->default(60);
    $table->boolean('leave_request_updates')->default(true);
    $table->boolean('swap_request_updates')->default(true);
    $table->time('quiet_hours_start')->nullable();
    $table->time('quiet_hours_end')->nullable();
    $table->timestamps();
});
```

## Files

### Created/Modified
- `app/Models/PushSubscription.php` - Push subscription model
- `app/Models/NotificationPreference.php` - Notification preference model
- `app/Services/PushNotificationService.php` - Web push service
- `app/Http/Controllers/Api/PushSubscriptionController.php` - Subscription endpoints
- `app/Jobs/SendPushNotification.php` - Queued push job
- `resources/views/settings/notifications.blade.php` - Notification preferences UI

### Routes
```php
Route::prefix('api/push')->group(function () {
    Route::post('subscribe', [PushSubscriptionController::class, 'subscribe']);
    Route::post('unsubscribe', [PushSubscriptionController::class, 'unsubscribe']);
});

Route::get('settings/notifications', [NotificationPreferenceController::class, 'edit'])
    ->name('settings.notifications');
Route::put('settings/notifications', [NotificationPreferenceController::class, 'update'])
    ->name('settings.notifications.update');
```

## Tasks

- [ ] Generate VAPID keys for web push
- [ ] Create PushSubscription model and migration
- [ ] Implement subscription endpoint (subscribe/unsubscribe)
- [ ] Create PushNotificationService with WebPush library
- [ ] Integrate notifications with shift published event
- [ ] Add shift reminder notifications (configurable timing)
- [ ] Add leave request status notifications
- [ ] Add swap request notifications
- [ ] Create notification preferences UI
- [ ] Implement quiet hours functionality
- [ ] Handle notification clicks in service worker
- [ ] Write tests for push notifications

## Tests

Tests to be created in `tests/Feature/PushNotificationTest.php`:

1. `test_user_can_subscribe_to_push_notifications`
2. `test_user_can_unsubscribe_from_push_notifications`
3. `test_push_notification_sent_on_schedule_publish`
4. `test_shift_reminder_notification_sent`
5. `test_quiet_hours_respected`
6. `test_notification_preferences_saved`
7. `test_duplicate_subscription_handled`

## Dependencies

- Feature 9.1: PWA Foundation (service worker)
- Shift model with published event
- LeaveRequest model
- ShiftSwapRequest model
- User model

## Notes

- Use minishlink/web-push package for PHP WebPush
- VAPID keys should be stored in environment variables
- Service worker handles notification click routing
- Consider notification grouping for multiple updates
