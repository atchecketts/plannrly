# Feature 19.2: API Rate Limiting

**Status:** Not Started
**Effort:** Small
**Phase:** 19 - Technical Infrastructure

## Overview

Fair usage enforcement with visibility for API consumers. This feature implements tiered rate limiting based on subscription level, provides usage visibility, and handles burst traffic gracefully.

## Requirements

### Functional Requirements
- Rate limits vary by subscription tier
- Rate limit headers included in all API responses
- API usage dashboard available in settings
- Email alerts sent when approaching limits
- Burst allowance for occasional traffic spikes
- Rate limits documented in API documentation

### Rate Limits by Tier

| Tier | Requests/Minute | Requests/Hour | Burst Allowance |
|------|-----------------|---------------|-----------------|
| Free | 30 | 500 | 10 |
| Starter | 60 | 2,000 | 20 |
| Professional | 120 | 10,000 | 50 |
| Enterprise | 300 | 50,000 | 100 |

### API Response Headers
- `X-RateLimit-Limit` - Maximum requests allowed
- `X-RateLimit-Remaining` - Remaining requests in window
- `X-RateLimit-Reset` - Unix timestamp when limit resets
- `Retry-After` - Seconds to wait (when rate limited)

### Alert Thresholds
- Warning at 80% usage
- Critical at 95% usage
- Daily usage summary (optional)

## Files

### To Create
- `app/Http/Middleware/ApiRateLimiting.php`
- `app/Services/RateLimitService.php`
- `app/Http/Controllers/Api/UsageController.php`
- `app/Notifications/RateLimitWarningNotification.php`
- `resources/views/settings/api-usage.blade.php`
- `tests/Feature/ApiRateLimitingTest.php`

### To Modify
- `bootstrap/app.php` - Register rate limiting middleware
- `routes/api.php` - Apply rate limiting to API routes
- `config/rate-limiting.php` - Rate limit configuration

### Routes
```php
// API route
Route::get('api/usage', [UsageController::class, 'index'])->name('api.usage');

// Web route
Route::get('settings/api-usage', [TenantSettingsController::class, 'apiUsage'])->name('settings.api-usage');
```

## Configuration

### config/rate-limiting.php
```php
return [
    'tiers' => [
        'free' => [
            'per_minute' => 30,
            'per_hour' => 500,
            'burst' => 10,
        ],
        'starter' => [
            'per_minute' => 60,
            'per_hour' => 2000,
            'burst' => 20,
        ],
        'professional' => [
            'per_minute' => 120,
            'per_hour' => 10000,
            'burst' => 50,
        ],
        'enterprise' => [
            'per_minute' => 300,
            'per_hour' => 50000,
            'burst' => 100,
        ],
    ],
    'alert_thresholds' => [
        'warning' => 80,
        'critical' => 95,
    ],
];
```

## Tasks

- [ ] Create rate limiting configuration file
- [ ] Create RateLimitService for limit calculations
- [ ] Create ApiRateLimiting middleware
- [ ] Configure rate limits per subscription tier
- [ ] Add rate limit headers to API responses
- [ ] Create API usage dashboard in settings
- [ ] Create RateLimitWarningNotification
- [ ] Implement email alerts for approaching limits
- [ ] Implement burst request allowance
- [ ] Document rate limits in API docs
- [ ] Write comprehensive tests

## Tests

Planned tests for `tests/Feature/ApiRateLimitingTest.php`:

1. `test_api_responses_include_rate_limit_headers`
2. `test_free_tier_has_correct_limits`
3. `test_professional_tier_has_higher_limits`
4. `test_requests_blocked_when_limit_exceeded`
5. `test_retry_after_header_when_rate_limited`
6. `test_burst_allowance_permits_spike`
7. `test_usage_dashboard_shows_current_usage`
8. `test_warning_notification_at_80_percent`
9. `test_critical_notification_at_95_percent`
10. `test_rate_limit_resets_after_window`

## Dependencies

- Subscription/billing system for tier detection
- Redis for rate limit storage (recommended)
- Notification system for alerts
- API authentication system
