# Feature 10.5: Team Messaging & Announcements (Premium)

**Status:** Not Started
**Effort:** Large
**Phase:** 10 - Premium Add-On Features

## Overview

Internal communication tools for staff. This premium feature enables organizations to communicate with employees through announcements and direct messages within the application.

## Requirements

### Functional Requirements
- Create announcements (org/location/department scope)
- Require acknowledgment for important announcements
- Track read receipts
- Direct messaging between users
- Unread counts in navigation
- Message search

### Business Rules
- Feature gated by premium subscription
- Announcements respect user scope (location/department)
- Important announcements require acknowledgment before dismissal
- Messages retained per data retention policy

### Prerequisites
- Phase 1.6 (Subscription & Feature Management) must be completed

## Database Changes

```php
Schema::create('announcements', function (Blueprint $table) {
    $table->id();
    $table->foreignId('tenant_id')->constrained()->cascadeOnDelete();
    $table->foreignId('author_id')->constrained('users')->cascadeOnDelete();
    $table->foreignId('location_id')->nullable()->constrained()->cascadeOnDelete();
    $table->foreignId('department_id')->nullable()->constrained()->cascadeOnDelete();
    $table->string('title');
    $table->text('content');
    $table->boolean('requires_acknowledgment')->default(false);
    $table->timestamp('published_at')->nullable();
    $table->timestamp('expires_at')->nullable();
    $table->timestamps();
});

Schema::create('announcement_reads', function (Blueprint $table) {
    $table->id();
    $table->foreignId('announcement_id')->constrained()->cascadeOnDelete();
    $table->foreignId('user_id')->constrained()->cascadeOnDelete();
    $table->boolean('acknowledged')->default(false);
    $table->timestamp('read_at');
    $table->timestamp('acknowledged_at')->nullable();

    $table->unique(['announcement_id', 'user_id']);
});

Schema::create('direct_messages', function (Blueprint $table) {
    $table->id();
    $table->foreignId('sender_id')->constrained('users')->cascadeOnDelete();
    $table->foreignId('recipient_id')->constrained('users')->cascadeOnDelete();
    $table->text('content');
    $table->timestamp('read_at')->nullable();
    $table->timestamps();
});
```

## Files

### Created/Modified
- `app/Models/Announcement.php` - Announcement model
- `app/Models/AnnouncementRead.php` - Read tracking model
- `app/Models/DirectMessage.php` - Message model
- `app/Services/MessagingService.php` - Messaging service
- `app/Http/Controllers/AnnouncementController.php` - Announcement controller
- `app/Http/Controllers/DirectMessageController.php` - Message controller
- `app/Notifications/NewAnnouncementNotification.php` - Email notification
- `resources/views/messaging/announcements/index.blade.php` - Announcements list
- `resources/views/messaging/announcements/create.blade.php` - Create form
- `resources/views/messaging/messages/index.blade.php` - Messages inbox
- `resources/views/components/announcement-card.blade.php` - Announcement card
- `resources/views/components/message-thread.blade.php` - Message thread
- `tests/Feature/MessagingTest.php` - Feature tests

### Routes
```php
Route::middleware(['auth', 'feature:team-messaging'])->group(function () {
    // Announcements
    Route::get('announcements', [AnnouncementController::class, 'index'])
        ->name('announcements.index');
    Route::get('announcements/create', [AnnouncementController::class, 'create'])
        ->name('announcements.create');
    Route::post('announcements', [AnnouncementController::class, 'store'])
        ->name('announcements.store');
    Route::post('announcements/{announcement}/acknowledge', [AnnouncementController::class, 'acknowledge'])
        ->name('announcements.acknowledge');

    // Direct Messages
    Route::get('messages', [DirectMessageController::class, 'index'])
        ->name('messages.index');
    Route::get('messages/{user}', [DirectMessageController::class, 'show'])
        ->name('messages.show');
    Route::post('messages/{user}', [DirectMessageController::class, 'store'])
        ->name('messages.store');
});
```

## Tasks

- [ ] Create Announcement model with scopes
- [ ] Create AnnouncementRead model
- [ ] Create DirectMessage model
- [ ] Create MessagingService
- [ ] Create AnnouncementController
- [ ] Create DirectMessageController
- [ ] Build announcements list and create UI
- [ ] Build direct messages UI
- [ ] Implement read tracking
- [ ] Implement acknowledgment flow
- [ ] Add unread badge to navigation
- [ ] Create email notification for new announcements
- [ ] Add feature gate middleware
- [ ] Write tests

## Tests

Tests to be created in `tests/Feature/MessagingTest.php`:

1. `test_feature_requires_premium_subscription`
2. `test_manager_can_create_announcement`
3. `test_announcement_scoped_to_location`
4. `test_announcement_scoped_to_department`
5. `test_user_can_read_announcement`
6. `test_user_can_acknowledge_announcement`
7. `test_acknowledgment_required_enforced`
8. `test_user_can_send_direct_message`
9. `test_user_can_view_message_thread`
10. `test_unread_count_accurate`
11. `test_email_notification_sent`

## Dependencies

- Feature 1.6: Subscription & Feature Management
- User model
- Location model
- Department model
- Notification system

## Notes

### Announcement Scopes
- Organization: All users in tenant
- Location: Users assigned to location
- Department: Users in department

### UI Considerations
- Unread count badge in sidebar
- Pinned announcements at top
- Expired announcements hidden by default
- Mark all as read action
