# Feature 29.4: Employee Personal Insights

**Status:** Not Started
**Effort:** Medium
**Phase:** 29 - Employee Lifecycle & Bulk Operations

## Overview

Comprehensive self-service analytics for employees. Provides personalized insights about work patterns, hours, attendance, and leave balance to help employees understand and manage their work life better.

## Requirements

### Functional Requirements

#### Hours & Attendance Metrics
- Total hours worked (week, month, year)
- Average hours per week
- Overtime hours breakdown
- Attendance rate percentage
- Late arrival statistics

#### Shift Analysis
- Shift type distribution (morning, afternoon, night)
- Day of week distribution
- Busiest days/periods
- Shift change/swap history

#### Leave Insights
- Current leave balance by type
- Leave usage over time
- Projected balance at year end
- Upcoming leave booked

#### Trends & Comparisons
- Hours trend over past 12 weeks
- Comparison to previous periods
- Comparison to team average (anonymized)

#### Personalized Recommendations
- Suggested optimal shift preferences
- Leave planning recommendations
- Work-life balance tips

### Dashboard Display
- Summary cards with key metrics
- Interactive charts
- Period selector (week, month, quarter, year)
- Export personal report

### Authorization
- Employees can only view their own insights
- Managers can view team summary (not individual)
- Data is read-only

## Database Changes

### Tables to Create

**employee_insights_cache**
| Column | Type | Description |
|--------|------|-------------|
| id | bigint | Primary key |
| user_id | bigint | Employee |
| period | string | weekly/monthly/yearly |
| period_start | date | Start of period |
| metrics | json | Calculated metrics |
| calculated_at | timestamp | When calculated |
| created_at | timestamp | |
| updated_at | timestamp | |

## Files

### To Create
- `app/Models/EmployeeInsightsCache.php`
- `app/Services/EmployeeInsightsService.php`
- `app/Services/InsightsCalculationService.php`
- `app/Http/Controllers/InsightsController.php`
- `app/Data/EmployeeInsights.php`
- `app/Data/HoursMetrics.php`
- `app/Data/AttendanceMetrics.php`
- `app/Data/LeaveMetrics.php`
- `app/Data/ShiftMetrics.php`
- `app/Console/Commands/CalculateEmployeeInsights.php`
- `resources/views/dashboard/insights.blade.php`
- `resources/views/insights/hours.blade.php`
- `resources/views/insights/attendance.blade.php`
- `resources/views/insights/leave.blade.php`
- `resources/views/insights/shifts.blade.php`
- `resources/views/components/insights-card.blade.php`
- `resources/views/components/insights-chart.blade.php`
- `database/migrations/xxxx_create_employee_insights_cache_table.php`
- `tests/Feature/EmployeeInsightsTest.php`

### Routes
```php
Route::get('insights', [InsightsController::class, 'index'])->name('insights.index');
Route::get('insights/hours', [InsightsController::class, 'hours'])->name('insights.hours');
Route::get('insights/attendance', [InsightsController::class, 'attendance'])->name('insights.attendance');
Route::get('insights/leave', [InsightsController::class, 'leave'])->name('insights.leave');
Route::get('insights/shifts', [InsightsController::class, 'shifts'])->name('insights.shifts');
Route::get('insights/export', [InsightsController::class, 'export'])->name('insights.export');
Route::get('api/insights/chart-data', [InsightsController::class, 'chartData'])->name('insights.chart-data');
```

## Tasks

- [ ] Create database migration for employee_insights_cache table
- [ ] Create EmployeeInsightsCache model
- [ ] Create EmployeeInsightsService for fetching insights
- [ ] Create InsightsCalculationService for calculations
- [ ] Create data transfer objects for different metric types
- [ ] Implement caching for performance
- [ ] Build hours/attendance metrics calculations
- [ ] Create shift type/day breakdown analysis
- [ ] Implement hours trend over time
- [ ] Add leave balance projection
- [ ] Build upcoming shift load visualization
- [ ] Create personalized recommendations logic
- [ ] Add insights to employee dashboard
- [ ] Create CalculateEmployeeInsights command
- [ ] Build chart components for visualizations
- [ ] Write tests for calculations

## Data Transfer Objects

```php
class EmployeeInsights
{
    public function __construct(
        public User $employee,
        public Carbon $periodStart,
        public Carbon $periodEnd,
        public HoursMetrics $hours,
        public AttendanceMetrics $attendance,
        public LeaveMetrics $leave,
        public ShiftMetrics $shifts,
        public array $recommendations,
    ) {}
}

class HoursMetrics
{
    public function __construct(
        public float $totalHours,
        public float $averagePerWeek,
        public float $overtime,
        public array $trend,
        public ?float $comparisonToPrevious,
    ) {}
}

class AttendanceMetrics
{
    public function __construct(
        public float $attendanceRate,
        public int $onTimeArrivals,
        public int $lateArrivals,
        public int $absences,
        public int $totalShifts,
    ) {}
}

class LeaveMetrics
{
    public function __construct(
        public array $balanceByType,
        public array $usedByType,
        public float $projectedYearEndBalance,
        public int $upcomingLeaveDays,
    ) {}
}

class ShiftMetrics
{
    public function __construct(
        public array $byType,
        public array $byDayOfWeek,
        public int $swapsInitiated,
        public int $swapsReceived,
    ) {}
}
```

## InsightsCalculationService

```php
class InsightsCalculationService
{
    public function calculateHoursMetrics(User $user, Carbon $start, Carbon $end): HoursMetrics
    {
        $timesheets = $user->timesheets()
            ->whereBetween('date', [$start, $end])
            ->get();

        $totalHours = $timesheets->sum('total_hours');
        $weeks = $start->diffInWeeks($end) ?: 1;
        $overtime = $timesheets->sum('overtime_hours');

        // Calculate trend (weekly totals)
        $trend = $timesheets
            ->groupBy(fn ($t) => $t->date->startOfWeek()->format('Y-m-d'))
            ->map(fn ($group) => $group->sum('total_hours'))
            ->toArray();

        return new HoursMetrics(
            totalHours: $totalHours,
            averagePerWeek: $totalHours / $weeks,
            overtime: $overtime,
            trend: $trend,
            comparisonToPrevious: $this->calculateComparison($user, $start, $end),
        );
    }

    public function calculateLeaveProjection(User $user): float
    {
        $currentBalance = $user->leaveAllowance?->remaining_days ?? 0;
        $pendingLeave = $user->leaveRequests()
            ->where('status', 'approved')
            ->where('start_date', '>', now())
            ->where('start_date', '<=', now()->endOfYear())
            ->sum('duration_days');

        return $currentBalance - $pendingLeave;
    }
}
```

## Recommendations Logic

```php
public function generateRecommendations(EmployeeInsights $insights): array
{
    $recommendations = [];

    // Work-life balance
    if ($insights->hours->averagePerWeek > 45) {
        $recommendations[] = [
            'type' => 'work_life_balance',
            'message' => 'Your average hours are above typical. Consider discussing workload with your manager.',
        ];
    }

    // Leave usage
    if ($insights->leave->projectedYearEndBalance > 10) {
        $recommendations[] = [
            'type' => 'leave_planning',
            'message' => "You have {$insights->leave->projectedYearEndBalance} days projected at year end. Plan some time off!",
        ];
    }

    // Shift patterns
    $nightShiftPercent = ($insights->shifts->byType['night'] ?? 0) / array_sum($insights->shifts->byType) * 100;
    if ($nightShiftPercent > 50) {
        $recommendations[] = [
            'type' => 'shift_variety',
            'message' => 'Over 50% of your shifts are night shifts. Request variety if desired.',
        ];
    }

    return $recommendations;
}
```

## Tests

Expected tests in `tests/Feature/EmployeeInsightsTest.php`:

1. `test_employee_can_view_own_insights`
2. `test_employee_cannot_view_other_insights`
3. `test_hours_metrics_calculated_correctly`
4. `test_attendance_rate_calculated_correctly`
5. `test_leave_balance_projection_accurate`
6. `test_shift_distribution_calculated`
7. `test_insights_cached_for_performance`
8. `test_cache_invalidated_on_new_data`
9. `test_trend_data_shows_weekly_breakdown`
10. `test_recommendations_generated`
11. `test_insights_export_generates_pdf`
12. `test_calculate_command_updates_cache`

## Dependencies

- User model
- Timesheet model
- Shift model
- LeaveRequest model
- LeaveAllowance model
- AttendanceRecord model (if exists)
- Chart.js for visualizations
