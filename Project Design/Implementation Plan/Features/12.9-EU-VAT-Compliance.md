# Feature 12.9: EU Intra-Community VAT Compliance

**Status:** Not Started
**Effort:** Large
**Phase:** 12 - Stripe Payment Integration

## Overview

Implement EU VAT regulations for cross-border B2B transactions. This feature is required for the Spanish company (Checketts Propiedad SL) to properly handle VAT for customers in different EU member states and beyond.

## Requirements

### Functional Requirements
- VIES VAT number validation
- Automatic VAT rate determination
- Reverse charge handling for intra-EU B2B
- VAT validation display on billing forms
- Quarterly re-validation of VAT numbers
- Modelo 349 export report

### Business Rules
- Spanish IVA (21%) for Spanish customers
- 0% with reverse charge for EU B2B customers
- 0% for non-EU customers (export)
- 21% Spanish IVA for EU B2C customers
- VAT numbers validated via VIES service

## VAT Treatment Rules

| Customer Type | Location | VAT Rate | Treatment |
|---------------|----------|----------|-----------|
| Business (B2B) | Spain | 21% | Domestic IVA |
| Business (B2B) | Other EU | 0% | Reverse Charge |
| Business (B2B) | Non-EU | 0% | Export (outside scope) |
| Consumer (B2C) | Spain | 21% | Domestic IVA |
| Consumer (B2C) | Other EU | 21% | Spanish IVA applies |
| Consumer (B2C) | Non-EU | 0% | Export (outside scope) |

## Database Changes

```php
// Add to tenant_billing_details
$table->string('billing_country_code', 2)->nullable();
$table->boolean('vat_validated')->default(false);
$table->timestamp('vat_validated_at')->nullable();
$table->string('vat_validation_request_id')->nullable();
$table->string('vat_company_name_from_vies')->nullable();

// Add to invoices
$table->string('vat_type')->nullable();
$table->boolean('reverse_charge')->default(false);
$table->string('vat_determination_reason')->nullable();
$table->string('customer_vat_number')->nullable();
$table->boolean('customer_vat_validated')->default(false);
$table->string('reverse_charge_text')->nullable();
```

## Files

### Created/Modified
- `app/Services/ViesValidationService.php` - VIES SOAP validation
- `app/Services/EuVatDeterminationService.php` - VAT rate logic
- `app/Http/Controllers/VatValidationController.php` - Validation endpoints
- `app/DTOs/ViesValidationResult.php` - Validation result DTO
- `app/DTOs/VatDetermination.php` - VAT determination DTO
- `app/Enums/VatType.php` - VAT type enum

### Routes
```php
Route::middleware('auth')->group(function () {
    Route::post('/vat/validate', [VatValidationController::class, 'validate'])
        ->name('vat.validate');
    Route::post('/vat/revalidate/{tenant}', [VatValidationController::class, 'revalidate'])
        ->name('vat.revalidate');
});

Route::middleware(['auth', 'super-admin'])->group(function () {
    Route::get('/reports/modelo-349', [VatReportController::class, 'modelo349'])
        ->name('reports.modelo-349');
});
```

## Tasks

- [ ] Create ViesValidationService using SOAP client
- [ ] Implement VIES WSDL connection with timeout handling
- [ ] Cache VIES validation results (24 hours)
- [ ] Create VatType enum (domestic, intra_eu_b2b, intra_eu_b2c, export)
- [ ] Create EuVatDeterminationService with tax logic
- [ ] Add EU country code list constant
- [ ] Create VatValidationController with validate/revalidate endpoints
- [ ] Add billing_country_code to tenant billing details form
- [ ] Implement real-time VAT number validation on input
- [ ] Display VIES company name/address after validation
- [ ] Store validation timestamp and request ID for audit
- [ ] Update invoice creation to use VAT determination service
- [ ] Auto-populate VAT fields when creating invoice
- [ ] Add reverse charge text to invoice PDF template
- [ ] Display both supplier and customer VAT numbers on invoice
- [ ] Add "VAT validated" badge on invoice
- [ ] Create scheduled command to re-validate VAT numbers quarterly
- [ ] Handle VIES service unavailability gracefully
- [ ] Create Modelo 349 export report (intra-community transactions)
- [ ] Log all VAT determinations for audit trail
- [ ] Write tests for all VAT scenarios
- [ ] Test with real EU VAT numbers in staging

## Tests

Tests to be created in `tests/Feature/EuVatComplianceTest.php`:

1. `test_vies_validation_works`
2. `test_invalid_vat_number_rejected`
3. `test_domestic_vat_applied_for_spanish_customer`
4. `test_reverse_charge_for_eu_b2b`
5. `test_export_rate_for_non_eu`
6. `test_spanish_vat_for_eu_b2c`
7. `test_vat_determination_logged`
8. `test_reverse_charge_text_on_invoice`
9. `test_modelo_349_report_generates`
10. `test_vies_unavailable_handled`
11. `test_quarterly_revalidation_works`

## Dependencies

- Feature 12.7: Tenant Billing Details
- Feature 12.8: Ad-Hoc Invoice Management
- SOAP extension for PHP

## Notes

### VIES Validation Service
```php
class ViesValidationService
{
    private const WSDL = 'https://ec.europa.eu/taxation_customs/vies/checkVatService.wsdl';

    public function validate(string $countryCode, string $vatNumber): ViesValidationResult
    {
        $client = new SoapClient(self::WSDL, [
            'connection_timeout' => 10,
        ]);

        $result = $client->checkVat([
            'countryCode' => $countryCode,
            'vatNumber' => $vatNumber,
        ]);

        return new ViesValidationResult(
            valid: $result->valid,
            name: $result->name ?? null,
            address: $result->address ?? null,
            requestId: $result->requestIdentifier ?? null,
        );
    }
}
```

### VAT Type Enum
```php
enum VatType: string
{
    case Domestic = 'domestic';
    case IntraEuB2b = 'intra_eu_b2b';
    case IntraEuB2c = 'intra_eu_b2c';
    case Export = 'export';
}
```

### EU Country Codes
```php
const EU_COUNTRIES = [
    'AT', 'BE', 'BG', 'HR', 'CY', 'CZ', 'DK', 'EE', 'FI', 'FR',
    'DE', 'GR', 'HU', 'IE', 'IT', 'LV', 'LT', 'LU', 'MT', 'NL',
    'PL', 'PT', 'RO', 'SK', 'SI', 'ES', 'SE'
];
```

### Reverse Charge Invoice Text
```
"Reverse charge - Article 196 Council Directive 2006/112/EC"
"The Client is responsible for tax payment to their local tax authority."
```

### Modelo 349 Report
- Required quarterly for Spanish companies
- Reports all intra-EU B2B transactions
- Includes customer VAT numbers and amounts
- Export as CSV/XML for tax filing
