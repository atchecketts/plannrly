# Feature 12.5: Stripe Webhooks

**Status:** Not Started
**Effort:** Medium
**Phase:** 12 - Stripe Payment Integration

## Overview

Handle Stripe events for subscription lifecycle. This feature processes webhook events from Stripe to keep the application in sync with subscription and payment status changes.

## Requirements

### Functional Requirements
- Handle subscription created event
- Handle subscription updated event
- Handle subscription deleted event
- Handle payment succeeded event
- Handle payment failed event
- Notify tenant on payment failure
- Start grace period on payment failure

### Business Rules
- Sync tenant features based on subscription status
- Grace period of 7 days on payment failure
- Multiple retry notifications before suspension

## Webhook Events to Handle

| Event | Action |
|-------|--------|
| customer.subscription.created | Activate subscription |
| customer.subscription.updated | Update subscription status |
| customer.subscription.deleted | Mark subscription cancelled |
| invoice.payment_succeeded | Log successful payment |
| invoice.payment_failed | Notify tenant, start grace period |
| customer.updated | Update customer info |

## Files

### Created/Modified
- `app/Http/Controllers/StripeWebhookController.php` - Webhook handler
- `app/Notifications/PaymentFailedNotification.php` - Payment failure notification
- `app/Notifications/GracePeriodNotification.php` - Grace period notification

### Routes
```php
Route::post('stripe/webhook', [StripeWebhookController::class, 'handleWebhook'])
    ->name('stripe.webhook');
```

## Tasks

- [ ] Create webhook controller
- [ ] Implement signature verification
- [ ] Handle subscription.created event
- [ ] Handle subscription.updated event
- [ ] Handle subscription.deleted event
- [ ] Handle payment_succeeded event
- [ ] Handle payment_failed event
- [ ] Create PaymentFailedNotification
- [ ] Create GracePeriodNotification
- [ ] Sync tenant features based on subscription status
- [ ] Write webhook tests

## Tests

Tests to be created in `tests/Feature/StripeWebhookTest.php`:

1. `test_webhook_verifies_signature`
2. `test_subscription_created_activates_tenant`
3. `test_subscription_updated_syncs_status`
4. `test_subscription_deleted_marks_cancelled`
5. `test_payment_succeeded_logs_payment`
6. `test_payment_failed_notifies_tenant`
7. `test_payment_failed_starts_grace_period`
8. `test_features_synced_on_subscription_change`

## Dependencies

- Feature 12.1: Stripe Setup & Customer Management
- Feature 12.2: Checkout & Subscription Flow
- Tenant model

## Notes

### Webhook Controller
```php
class StripeWebhookController extends CashierController
{
    public function handleSubscriptionCreated(array $payload)
    {
        $tenant = $this->getTenantFromPayload($payload);
        $tenant->syncFeatures();

        return $this->successMethod();
    }

    public function handleInvoicePaymentFailed(array $payload)
    {
        $tenant = $this->getTenantFromPayload($payload);

        $tenant->notify(new PaymentFailedNotification());
        $tenant->startGracePeriod();

        return $this->successMethod();
    }

    protected function getTenantFromPayload(array $payload): Tenant
    {
        return Tenant::where('stripe_id', $payload['data']['object']['customer'])
            ->firstOrFail();
    }
}
```

### Grace Period
```php
public function startGracePeriod(): void
{
    $this->update([
        'grace_period_ends_at' => now()->addDays(7),
    ]);

    $this->notify(new GracePeriodNotification($this->grace_period_ends_at));
}

public function isInGracePeriod(): bool
{
    return $this->grace_period_ends_at &&
           $this->grace_period_ends_at->isFuture();
}
```

### Feature Sync
```php
public function syncFeatures(): void
{
    $subscription = $this->subscription('default');

    if (!$subscription || $subscription->cancelled()) {
        $this->disableAllPremiumFeatures();
        return;
    }

    // Sync based on plan
    $plan = $this->getCurrentPlan();
    $this->enableFeaturesForPlan($plan);
}
```

### Stripe Dashboard Webhook Setup
1. Go to Stripe Dashboard > Developers > Webhooks
2. Add endpoint: `https://yourapp.com/stripe/webhook`
3. Select events to listen for
4. Copy webhook signing secret to `.env`
