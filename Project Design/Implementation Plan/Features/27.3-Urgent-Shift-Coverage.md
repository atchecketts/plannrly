# Feature 27.3: Urgent Shift Coverage

**Status:** Not Started
**Effort:** Large
**Phase:** 27 - Advanced Shift Features

## Overview

Find replacement workflow for last-minute vacancies. When an employee calls in sick or cannot make their shift, managers can quickly find and notify available employees to cover the shift with escalating urgency.

## Requirements

### Functional Requirements

#### Coverage Request Creation
- Manager creates coverage request for vacant shift
- Set priority level (normal, urgent, critical)
- Add reason for vacancy
- Specify deadline for responses
- Optional: offer incentives (bonus pay, time off)

#### Employee Notification
- Notify eligible employees based on:
  - Skills/certifications required for shift
  - Availability (not already scheduled)
  - Overtime limits
  - Location/department
- Escalation system for urgent requests:
  - Normal: In-app notification
  - Urgent: In-app + push notification
  - Critical: In-app + push + SMS

#### Response Handling
- Employees can accept or decline
- First accepted response wins (or manager selects)
- Auto-assign option for first responder
- Track all responses for reporting

#### Manager Dashboard
- View all open coverage requests
- See response status in real-time
- Manually assign from available employees
- Cancel or close coverage requests

### Authorization
- Admins and Managers can create coverage requests
- Employees can respond to coverage requests for their role
- Admins can view all coverage requests

## Database Changes

### Tables to Create

**coverage_requests**
| Column | Type | Description |
|--------|------|-------------|
| id | bigint | Primary key |
| tenant_id | bigint | Foreign key to tenants |
| shift_id | bigint | Foreign key to shifts |
| requested_by | bigint | Manager who created request |
| priority | string | normal/urgent/critical |
| reason | text | Why coverage is needed |
| deadline | datetime | Response deadline |
| incentive_type | string | bonus_pay/time_off/none |
| incentive_value | decimal | Amount of incentive |
| status | string | open/filled/cancelled/expired |
| auto_assign | boolean | Auto-assign first responder |
| filled_by | bigint | Employee who took the shift |
| filled_at | timestamp | When coverage was accepted |
| created_at | timestamp | |
| updated_at | timestamp | |

**coverage_responses**
| Column | Type | Description |
|--------|------|-------------|
| id | bigint | Primary key |
| coverage_request_id | bigint | Foreign key to coverage_requests |
| user_id | bigint | Employee responding |
| response | string | accepted/declined |
| notes | text | Optional message |
| response_time_seconds | integer | How long to respond |
| created_at | timestamp | |

**coverage_notifications**
| Column | Type | Description |
|--------|------|-------------|
| id | bigint | Primary key |
| coverage_request_id | bigint | Foreign key to coverage_requests |
| user_id | bigint | Notified employee |
| channel | string | app/push/sms |
| sent_at | timestamp | |
| read_at | timestamp | |
| created_at | timestamp | |

## Files

### To Create
- `app/Models/CoverageRequest.php`
- `app/Models/CoverageResponse.php`
- `app/Models/CoverageNotification.php`
- `app/Enums/CoveragePriority.php`
- `app/Enums/CoverageStatus.php`
- `app/Enums/CoverageIncentive.php`
- `app/Services/UrgentCoverageService.php`
- `app/Services/CoverageNotificationService.php`
- `app/Http/Controllers/CoverageController.php`
- `app/Http/Requests/Coverage/StoreCoverageRequest.php`
- `app/Notifications/UrgentCoverageNotification.php`
- `app/Notifications/CoverageFilledNotification.php`
- `app/Jobs/SendCoverageNotifications.php`
- `app/Jobs/ExpireCoverageRequests.php`
- `resources/views/coverage/index.blade.php`
- `resources/views/coverage/create.blade.php`
- `resources/views/coverage/show.blade.php`
- `resources/views/coverage/respond.blade.php`
- `resources/views/coverage/dashboard.blade.php`
- `database/migrations/xxxx_create_coverage_requests_table.php`
- `database/migrations/xxxx_create_coverage_responses_table.php`
- `database/migrations/xxxx_create_coverage_notifications_table.php`
- `tests/Feature/UrgentCoverageTest.php`

### Routes
```php
Route::resource('coverage', CoverageController::class);
Route::get('coverage/{coverage}/respond', [CoverageController::class, 'showRespond'])->name('coverage.respond.show');
Route::post('coverage/{coverage}/respond', [CoverageController::class, 'respond'])->name('coverage.respond');
Route::post('coverage/{coverage}/assign/{user}', [CoverageController::class, 'assign'])->name('coverage.assign');
Route::post('coverage/{coverage}/cancel', [CoverageController::class, 'cancel'])->name('coverage.cancel');
Route::get('coverage-dashboard', [CoverageController::class, 'dashboard'])->name('coverage.dashboard');
```

## Tasks

- [ ] Create database migrations for coverage tables
- [ ] Create CoverageRequest model with relationships
- [ ] Create CoverageResponse model
- [ ] Create CoverageNotification model
- [ ] Create CoveragePriority enum (Normal, Urgent, Critical)
- [ ] Create CoverageStatus enum (Open, Filled, Cancelled, Expired)
- [ ] Create CoverageIncentive enum (BonusPay, TimeOff, None)
- [ ] Create UrgentCoverageService for business logic
- [ ] Create CoverageNotificationService for multi-channel notifications
- [ ] Implement priority calculation and escalation
- [ ] Create UrgentCoverageNotification (app/push/SMS)
- [ ] Build employee response interface
- [ ] Implement auto-assign option
- [ ] Create manager coverage dashboard
- [ ] Add SendCoverageNotifications job
- [ ] Add ExpireCoverageRequests job for deadline handling
- [ ] Add coverage tracking to reports
- [ ] Write tests

## Coverage Enums

```php
enum CoveragePriority: string
{
    case Normal = 'normal';
    case Urgent = 'urgent';
    case Critical = 'critical';
}

enum CoverageStatus: string
{
    case Open = 'open';
    case Filled = 'filled';
    case Cancelled = 'cancelled';
    case Expired = 'expired';
}

enum CoverageIncentive: string
{
    case BonusPay = 'bonus_pay';
    case TimeOff = 'time_off';
    case None = 'none';
}
```

## Notification Escalation

| Priority | Channels | Timing |
|----------|----------|--------|
| Normal | In-app only | Immediate |
| Urgent | In-app + Push | Immediate |
| Critical | In-app + Push + SMS | Immediate, repeat after 15 min if no response |

## Tests

Expected tests in `tests/Feature/UrgentCoverageTest.php`:

1. `test_manager_can_create_coverage_request`
2. `test_coverage_request_requires_shift`
3. `test_employee_cannot_create_coverage_request`
4. `test_eligible_employees_are_notified`
5. `test_notification_channels_match_priority`
6. `test_employee_can_accept_coverage`
7. `test_employee_can_decline_coverage`
8. `test_auto_assign_works_for_first_responder`
9. `test_manager_can_manually_assign`
10. `test_coverage_expires_at_deadline`
11. `test_coverage_dashboard_shows_open_requests`
12. `test_response_time_is_tracked`
13. `test_only_eligible_employees_notified`
14. `test_incentive_recorded_on_acceptance`

## Dependencies

- Shift model
- User model
- Tenant model
- Push notification service
- SMS service (Twilio or similar)
- Notification system
