# Feature 12.4: Invoice & Billing History

**Status:** Not Started
**Effort:** Medium
**Phase:** 12 - Stripe Payment Integration

## Overview

View and download invoices. This feature allows customers to view their billing history, download PDF invoices, and see upcoming invoice previews.

## Requirements

### Functional Requirements
- List invoice history
- Show invoice details (amount, date, status)
- PDF invoice download
- Upcoming invoice preview
- Payment status indicators

### Technical Requirements
- Stripe invoice retrieval
- PDF generation or Stripe hosted invoice

## Files

### Created/Modified
- `resources/views/subscription/invoices.blade.php` - Invoice list and details

### Routes
```php
Route::middleware('auth')->prefix('subscription')->group(function () {
    Route::get('/invoices', [InvoiceController::class, 'index'])
        ->name('subscription.invoices');
    Route::get('/invoices/{invoice}', [InvoiceController::class, 'show'])
        ->name('subscription.invoices.show');
    Route::get('/invoices/{invoice}/download', [InvoiceController::class, 'download'])
        ->name('subscription.invoices.download');
});
```

## Tasks

- [ ] List invoice history
- [ ] Show invoice details (amount, date, status)
- [ ] Implement PDF invoice download
- [ ] Show upcoming invoice preview
- [ ] Display payment status indicators
- [ ] Write tests

## Tests

Tests to be created in `tests/Feature/InvoiceTest.php`:

1. `test_invoices_page_loads`
2. `test_invoices_list_displays`
3. `test_invoice_details_show`
4. `test_invoice_pdf_downloads`
5. `test_upcoming_invoice_preview_shows`
6. `test_payment_status_indicated`

## Dependencies

- Feature 12.1: Stripe Setup & Customer Management
- Feature 12.2: Checkout & Subscription Flow

## Notes

### Invoice List Implementation
```php
public function index(Request $request)
{
    $tenant = $request->user()->tenant;

    return view('subscription.invoices', [
        'invoices' => $tenant->invoices(),
        'upcomingInvoice' => $tenant->upcomingInvoice(),
    ]);
}
```

### Invoice Download
```php
public function download(Request $request, string $invoiceId)
{
    $tenant = $request->user()->tenant;

    return $tenant->downloadInvoice($invoiceId, [
        'vendor' => 'Checketts Propiedad SL',
        'product' => 'Plannrly Subscription',
        'street' => 'Calle Francisco Salzillo 9',
        'location' => 'Orihuela Costa, Alicante 03189',
        'country' => 'Spain',
        'tax_id' => 'ESB42691550',
    ]);
}
```

### Invoice Display
```blade
@foreach($invoices as $invoice)
    <tr>
        <td>{{ $invoice->date()->toFormattedDateString() }}</td>
        <td>{{ $invoice->number }}</td>
        <td>{{ $invoice->total() }}</td>
        <td>
            @if($invoice->paid)
                <span class="text-green-600">Paid</span>
            @else
                <span class="text-red-600">Unpaid</span>
            @endif
        </td>
        <td>
            <a href="{{ route('subscription.invoices.download', $invoice->id) }}">
                Download PDF
            </a>
        </td>
    </tr>
@endforeach
```

### Upcoming Invoice
```blade
@if($upcomingInvoice)
    <div>
        <h3>Upcoming Invoice</h3>
        <p>Due: {{ $upcomingInvoice->date()->toFormattedDateString() }}</p>
        <p>Amount: {{ $upcomingInvoice->total() }}</p>
    </div>
@endif
```
